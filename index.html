<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>ARTE MODERNO</title>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{
      --bg:#0b1020;--panel:#111a2b;--muted:#99a3b4;--text:#e7eefc;
      --accent:#0ea5e9;--accent2:#22c55e;
      --verb:#ff4d4d; --adj:#7CFC00; --place:#ffe066; --event:#b266ff; --scene:#ffb347;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
      color:var(--text);background:linear-gradient(180deg,#0b1020,#0b1428) fixed;
    }

    /* === Appbar compacto (horizontal) === */
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(9,13,26,.7);backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .appbar{
      max-width:820px;margin:0 auto;
      padding:8px 12px; /* compacto */
      display:flex;align-items:center;gap:10px;
      min-height:48px;
    }
    .brand{
      display:flex;align-items:center;gap:8px;min-width:0;white-space:nowrap;
      font-weight:800;font-size:16px; /* peque√±o */
    }
    .spacer{flex:1}
    #roomBadge{
      display:none;font-weight:700;font-size:12px;
      padding:4px 10px;border:1px solid rgba(255,255,255,.15);border-radius:999px;
      white-space:nowrap;
    }
    #leaveRow{display:none}
    #btnLeave{padding:8px 10px;font-size:13px;border-radius:10px}

    .container{max-width:820px;margin:0 auto;padding:16px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 6px 30px rgba(0,0,0,.25)
    }
    .title{font-size:18px;font-weight:800;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    .btn{
      appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:700;color:var(--text);
      background:transparent;border:1px solid rgba(255,255,255,.12);cursor:pointer;transition:background .15s,color .15s,font-weight .05s;font-size:14px;
    }
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn:active{transform:translateY(1px)}
      .btn-chip{ margin-left:auto; padding:8px 10px; font-size:12px; opacity:.85 }
.btn-chip .chev{ display:inline-block; transition:transform .15s ease }
.btn-chip[aria-expanded="true"] .chev{ transform:rotate(180deg) }
    .inline{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input{
      width:100%;background:#0f182a;color:var(--text);border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;font-size:15px;
    }
    .out{
      font-size:22px;line-height:1.45;background:#0b1426;border-radius:14px;padding:14px;border:1px dashed rgba(255,255,255,.15)
    }
    /* Nota de desaf√≠o debajo del enunciado */
.challengeNote{
  color: var(--muted);
  font-size: 13px;
  line-height: 1.35;
  border-left: 3px solid var(--accent);
  padding-left: 8px;
  opacity: 0.95;
}
    footer{opacity:.8;padding:16px 12px;text-align:center;font-size:12px;position:relative}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;border:1px solid rgba(255,255,255,.2);padding:2px 6px;border-radius:6px;background:#0e1628}
    .char{ color:#4cc9f0; } .verb{ color:var(--verb); } .adj{ color:var(--adj); } .place{ color:#ffe066; } .event{ color:#b266ff; } .scene{ color:#ffb347; }

    #footerBtns{position:absolute;right:12px;bottom:8px;opacity:0;transition:opacity .3s;display:flex;gap:6px;}
    footer:hover #footerBtns{opacity:0.5;}
    #footerBtns .btn{font-size:10px;padding:4px 8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);}
    .btn span { font-weight: bold; }
    .letter-p{color:#4cc9f0}.letter-v{color:#ff4d4d}.letter-a{color:#7CFC00}.letter-l{color:#ffe066}

    /* Overlay inicial ‚Äî visible por defecto; se oculta al entrar a sala */
    #lobbyOverlay{
      position:fixed; inset:0; background:rgba(11,16,32,.92);backdrop-filter: blur(8px);
      display:flex; align-items:center; justify-content:center; z-index:1000;
    }

    /* Toast */
    #toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
      background:rgba(20,28,48,.96); border:1px solid rgba(255,255,255,.15); color:var(--text);
      padding:10px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);
      opacity:0; transition:opacity .25s, transform .25s; z-index:1200; pointer-events:none; font-weight:700;
    }
    #toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    /* Jugadores (vertical + group-colored + score) */
    .players-wrap{ display:flex; flex-direction:column; gap:8px; }
    .players-title-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .playerChip{
      position:relative;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border:1px solid rgba(255,255,255,.14);
      border-radius:12px;background:rgba(255,255,255,.04); width:100%;
      --gc:#64748b;
    }
    .playerChip::before{
      content:"";
      position:absolute; left:0; top:0; bottom:0; width:4px;
      background:var(--gc);
      border-top-left-radius:12px;border-bottom-left-radius:12px;
      opacity:.95;
    }
    .playerChip .dot{ width:8px;height:8px;border-radius:50%;background:var(--accent2) }
    .groupBadge{
      padding:2px 8px; border:1px solid rgba(255,255,255,.18); border-radius:8px;
      background:#0e1628; font-weight:800; font-size:12px; white-space:nowrap;
    }
    .playerChip .name{ font-weight:700; display:flex; align-items:center; gap:8px; }
    .playerChip .role{
      font-size:10px;border:1px solid rgba(255,255,255,.2);
      padding:2px 6px;border-radius:999px;opacity:.9
    }
    .scoreBox{
      margin-left:auto; display:flex; align-items:center; gap:6px;
      font-variant-numeric: tabular-nums; user-select:none;
    }
    .score{ min-width:36px; text-align:right; font-weight:800; padding:2px 6px;
      border:1px solid rgba(255,255,255,.18); border-radius:8px; background:#0e1628;
    }
    .scoreBtn{
      width:28px;height:28px;display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06);
      border-radius:8px; cursor:pointer; font-weight:900; font-size:14px;
    }
    .scoreBtn[disabled]{opacity:.35; cursor:not-allowed}

    /* Enunciado por grupo (l√≠nea con badge de color) */
    .lineGroup{ display:flex; align-items:center; gap:10px; margin:6px 0; }
    .lineGroup .gBadge{
      padding:2px 8px; border:1px solid rgba(255,255,255,.18); border-radius:8px; background:#0e1628; font-weight:800; font-size:12px; white-space:nowrap;
    }
    @media (max-width: 820px) {
  header a[title="Ver instrucciones del juego"] {
    /* mantener el bot√≥n arriba, un poco m√°s abajo del borde */
    top: 10px !important;       /* <- antes dec√≠a top:auto */
    bottom: auto !important;    /* <- elimina el anclaje inferior */
    right: 16px !important;     /* <- posici√≥n a la derecha */
    z-index: 2000 !important;   /* <- para que quede encima del header */

    width: 30px !important;     /* tama√±o original */
    height: 30px !important;
    font-size: 18px !important;

    opacity: 0.9 !important;
    background: rgba(255,255,255,0.08) !important;
    border-color: rgba(255,255,255,0.2) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.35) !important;
  }

  header a[title="Ver instrucciones del juego"]:hover {
    opacity: 1 !important;
    background: rgba(255,255,255,0.16) !important;
  }
}

    /* Animaci√≥n suave para el overlay de Filtros */
#filtersOverlay{
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease;
}
#filtersOverlay.open{
  opacity: 1;
  pointer-events: auto;
}
/* peque√±o pop del panel */
#filtersOverlay .card{
  transform: scale(.98);
  transition: transform .25s ease;
}
#filtersOverlay.open .card{
  transform: scale(1);
}
    /* Ocultar botones Copiar y Test en m√≥viles */
@media (max-width: 820px) {
  #btnCopiar, #btnTest {
    display: none !important;
  }
}
    /* Toast un poco m√°s abajo en m√≥viles */
@media (max-width: 820px) {
  #toast {
    bottom: 14px !important; /* antes 24px */
  }
}
    #timerDisplay {
  font-size: 2.2rem;     /* tama√±o grande */
  font-weight: 900;      /* m√°s grueso */
  letter-spacing: 1px;
  padding: 8px 16px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.2);
  min-width: 90px;
  text-align: center;
  display: inline-block;
  transition: transform 0.25s ease, color 0.25s ease;
}

#timerDisplay.running {
  transform: scale(1.1);
  color: var(--accent2);
}

#timerDisplay.warning {
  color: var(--verb); /* rojo cuando queda poco */
  transform: scale(1.2);
}
    /* Reloj grande y centrado */
#timerWrap { justify-content: center !important; }

#timerDisplay{
  display:inline-flex; align-items:center; justify-content:center;
  min-width:140px;
  font-size:28px; line-height:1; font-variant-numeric: tabular-nums;
  padding:12px 16px; border-radius:14px;
  background:#0e1628; border:1px solid rgba(255,255,255,.20);
  cursor:pointer; user-select:none;
  transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease;
}
    #timerDisplay {
  color: #fff !important; /* üî• fuerza el texto blanco en todos los estados */
}

/* Cuando el temporizador corre, el color se mantiene claro */
#timerDisplay.running {
  color: #fff !important;
}

/* Si quieres, puedes mantener el ‚Äúwarning‚Äù en rojo como ya lo tienes */
#timerDisplay.warning {
  color: #ff4d4d !important;
}

#timerDisplay:hover{ transform: translateY(-1px); }
#timerDisplay:active{ transform: translateY(0); }
#timerDisplay.running{
  font-weight:800;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.08), 0 8px 26px rgba(0,0,0,.35);
  border-color: rgba(255,255,255,.28);
}
#timerDisplay.warning{
  color: var(--verb);
  animation: timerPulse 1000ms ease-in-out infinite;
}
@keyframes timerPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.045); }
  100% { transform: scale(1); }
}
    /* Mueve el selector de segundos un poco m√°s a la izquierda */
#timerSelect {
  position: relative;
  left: -6px; /* ajust√° este valor seg√∫n lo que quieras */
}

/* (opcional) reduce el gap entre el select y el bot√≥n del reloj */
#timerWrap {
  gap: 6px; /* antes 10px */
}
    /* üîß Estilo oscuro para el selector del temporizador */
#timerSelect {
  background: #0e1628; /* mismo fondo que los dem√°s controles */
  color: #fff; /* texto blanco */
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  padding: 8px 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  appearance: none; /* quita el estilo nativo (Safari/Chrome) */
  -webkit-appearance: none;
  -moz-appearance: none;
  transition: background 0.2s, border-color 0.2s;
}

#timerSelect:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(255, 255, 255, 0.3);
}
#timerSelect:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
 #timerSelect option {
 background: #0e1628;
 color: #fff;
}
    /* === Ajuste m√≥vil: mover un poco "Sala: ‚Äî" y el bot√≥n "Salir" hacia la izquierda === */
@media (max-width: 820px) {
  /* deja un colch√≥n a la derecha, para que se vean m√°s ‚Äúmetidos‚Äù a la izquierda */
  #leaveRow {
    margin-right: calc(env(safe-area-inset-right, 0px) + 48px) !important;
  }

  /* opcional: ac√©rcalos un poquito entre s√≠ (sobre-escribe el inline de 8px) */
  #leaveRow {
    margin-left: 6px !important;
  }
}
  /* ‚¨áÔ∏è Pega esto al final del <style> */
  /* Texto m√°s chico cuando est√° parado */
  #timerDisplay:not(.running){
    font-size: 16px !important;
  }

  /* Opcional: un poquito m√°s grande al correr */
  #timerDisplay.running{
    font-size: 18px;              /* sin !important para que esta gane solo si existe */
  }
    footer .copyright{
  margin-top: 8px;
  text-align: center;
  font-size: 12px;
  opacity: .75;
}
    /* P y P+P en blanco */
#btnP .letter-p,
#btnFusion .letter-p{
  color: var(--text) !important;
}
    /* === Botones secundarios: M√°s opciones y Filtros === */
#btnToggleAdv,
/* Igualar tama√±o de Filtros con M√°s opciones (btn-chip) */
#btnFilters{
  padding: 8px 10px !important;
  font-size: 12px !important;
  line-height: 1 !important;   /* asegura misma altura visual */
  opacity: .85;                /* match del chip */
}

/* Hover/active suaves */
#btnToggleAdv:hover,
#btnFilters:hover{
  background: rgba(255,255,255,.10) !important;
  opacity: 1;
}
#btnToggleAdv:active,
#btnFilters:active{
  transform: translateY(1px);
}

/* Separaci√≥n visual del bloque de generadores */
#btnToggleAdv{ margin-left: auto; }   /* empuja estos dos a la derecha */
#btnFilters{ margin-left: 2px; }      /* peque√±o espacio entre ellos */

/* (opcional) que la flechita del chip siga vi√©ndose bien */
#btnToggleAdv .chev{ opacity:.9; }
/* === Secundarios en gris: M√°s opciones + Filtros === */
:is(#btnToggleAdv, #btnFilters){
  background: linear-gradient(180deg, rgba(148,163,184,.16), rgba(148,163,184,.10)) !important; /* slate-300/gray */
  border: 1px solid rgba(148,163,184,.45) !important;
  color: #d9e1ee !important;
  opacity: 1 !important;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
}

:is(#btnToggleAdv, #btnFilters):hover{
  background: linear-gradient(180deg, rgba(148,163,184,.24), rgba(148,163,184,.16)) !important;
  border-color: rgba(148,163,184,.60) !important;
}

:is(#btnToggleAdv, #btnFilters):active{
  transform: translateY(1px);
  background: rgba(148,163,184,.28) !important;
  border-color: rgba(148,163,184,.70) !important;
}

/* Flechita del chip en gris claro */
#btnToggleAdv .chev{ opacity:.95; }

/* En m√≥vil: mismas sensaciones pero un pel√≠n m√°s suaves */
@media (max-width: 820px){
  :is(#btnToggleAdv, #btnFilters){
    background: linear-gradient(180deg, rgba(148,163,184,.14), rgba(148,163,184,.08)) !important;
    border-color: rgba(148,163,184,.38) !important;
  }
}
    /* Contenedor para acciones en el header (oculto por defecto) */
.header-actions { display: none; }

/* Solo desktop */
@media (min-width: 1024px){
  .header-actions{
    display: flex;
    gap: 8px;
    align-items: center;
  }
}
    /* Overlay de Confirmaci√≥n Salir (abre/cierra con clase .open) */
#confirmExitOverlay.open{
  opacity: 1;
  pointer-events: auto;
}
#confirmExitOverlay.open .card{
  transform: scale(1);
}
#confirmExitOverlay .card{
  transform: scale(.98);
  transition: transform .25s ease;
}
</style>
</head>
<body>
  <!-- Appbar compacto -->
  <header>
    <div class="appbar">
      <div class="brand">üé® ARTE MODERNO</div>
      <div class="spacer"></div>
      <span id="roomBadge">Sala: -----</span>
      <div id="leaveRow" class="inline" style="margin-left:8px;">
        <button class="btn" id="btnLeave">Salir</button>
      </div>
    </div>

    <!-- Bot√≥n de ayuda -->
<a href="https://docs.google.com/document/d/1Y5aZf2fiynNV-wOyLERSH7mDVyFipPWosW3VVZwmEYE/edit?tab=t.0"
   target="_blank"
   title="Ver instrucciones del juego"
   style="
     position:fixed;
     top:12px;
     right:16px;
     font-size:18px;
     font-weight:600;
     color:#cbd5e1;
     text-decoration:none;
     background:rgba(255,255,255,0.05);
     border:1px solid rgba(255,255,255,0.15);
     border-radius:50%;
     width:30px;
     height:30px;
     display:flex;
     align-items:center;
     justify-content:center;
     backdrop-filter:blur(6px);
     z-index:2000;
     transition:background .2s, border-color .2s, color .2s, transform .15s;
     box-shadow:0 2px 6px rgba(0,0,0,0.4);
   "
   onmouseover="
     this.style.background='rgba(255,255,255,0.15)';
     this.style.borderColor='rgba(255,255,255,0.25)';
     this.style.color='#e2e8f0';
     this.style.transform='scale(1.08)';
   "
   onmouseout="
     this.style.background='rgba(255,255,255,0.05)';
     this.style.borderColor='rgba(255,255,255,0.15)';
     this.style.color='#cbd5e1';
     this.style.transform='scale(1)';
   ">
  ?
</a>
  </header>

<!-- Overlay de inicio -->
<div id="lobbyOverlay">
  <section class="card" style="max-width:520px; width:92%; padding:20px">
<!-- T√≠tulo principal del men√∫ -->
<div style="
  margin-bottom:20px;
  text-align:center;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
">
  <div style="
    font-size:26px;
    font-weight:900;
    letter-spacing:.3px;
    color:#ffffff;
    margin-bottom:6px;
  ">
    ¬°Bienvenidos a <span style="color:#0ea5e9;">Arte Moderno üé®</span>!
  </div>
  <div style="
    font-size:13px;
    opacity:0.75;
    color:#94a3b8;
  ">
    ¬© 2025 Tabja Games
  </div>
  <div style="
    height:2px;
    width:80%;
    background:linear-gradient(90deg, transparent, #0ea5e9, transparent);
    margin-top:10px;
    border-radius:2px;
    opacity:.6;
  "></div>
</div>

   <!-- Nombre (siempre visible) -->
<div class="inline" style="align-items:flex-end; gap:10px; flex-wrap:wrap; margin-bottom:10px">
  <div style="min-width:180px; flex:1">
<input id="playerName" placeholder="Tu nombre" aria-label="Tu nombre" style="max-width:100%">
<small id="nameError" style="color:#dc2626; display:none;">Por favor coloca tu nombre.</small>
<small id="nameLengthError" style="color:#dc2626; display:none;">M√°ximo 10 caracteres permitidos.</small>
  </div>
</div>

    <!-- Paso 1: elegir acci√≥n -->
    <div id="choiceRow" class="inline" style="gap:10px; flex-wrap:wrap; margin-bottom:6px">
      <button class="btn" id="btnCreateLobby">Crear sala</button>
      <button class="btn" id="btnChooseJoin">Unirse a una sala</button>
    </div>

    <!-- Paso 2 (solo si eligen Unirse): ingresar c√≥digo -->
    <div id="joinRow" class="inline" style="align-items:flex-end; gap:10px; flex-wrap:wrap; display:none">
  <div style="flex:1; min-width:200px;">
    <input id="lobbyCodeInput" placeholder="C√≥digo de sala" aria-label="C√≥digo de sala" style="width:100%; text-transform:uppercase">
    <small id="codeError" style="color:#dc2626; display:none;">Escribe un c√≥digo de sala.</small>
  </div>
  <button class="btn" id="btnJoinLobby">Entrar</button>
  <button class="btn" id="btnBackJoin">‚Üê Atr√°s</button>
</div>

    <div class="muted" id="lobbyStatus" style="margin-top:10px; min-height:20px"></div>
  </section>
</div>

<!-- Overlay Enunciado Secreto -->
<div id="secretOverlay"
     style="display:none; position:fixed; inset:0; z-index:1200;
            align-items:center; justify-content:center;
            background:rgba(11,16,32,.92); backdrop-filter:blur(8px);
            padding:16px;">
  <section class="card" style="max-width:520px; width:92%; padding:20px; text-align:center">
    <div id="secretTitle" style="font-weight:900; font-size:20px; margin-bottom:8px;">
  üïµÔ∏è Enunciado secreto
</div>
    <div id="secretContent"
         class="out"
         style="margin-top:10px; white-space:pre-wrap"></div>
    <div class="inline" style="justify-content:center; margin-top:14px;">
      <button class="btn" id="btnSecretOK">Entendido</button>
    </div>
  </section>
</div>
  <!-- Overlay Confirmar Salida -->
<div id="confirmExitOverlay"
     style="position:fixed; inset:0; z-index:1300; display:flex; align-items:center; justify-content:center; background:rgba(11,16,32,.92); backdrop-filter:blur(8px); padding:16px; transition:opacity .25s ease;">
  <section class="card" style="max-width:520px; width:92%; padding:20px; text-align:center">
    <div style="font-weight:900; font-size:18px; margin-bottom:10px;">
      ¬øEst√°s seguro de salir?
    </div>
    <div class="muted" style="margin-bottom:16px;">
      Perder√°s todo tu puntaje acumulado.
    </div>
    <div class="inline" style="justify-content:center; gap:10px;">
      <button class="btn" id="btnConfirmExitYes">S√≠</button>
      <button class="btn" id="btnConfirmExitNo">No</button>
    </div>
  </section>
</div>
<!-- Overlay Filtros (solo admin en sala; cualquiera en modo local) -->
<div id="filtersOverlay"
     style="position:fixed; inset:0; z-index:1200; display:flex;
            align-items:center; justify-content:center;
            background:rgba(11,16,32,.92); backdrop-filter:blur(8px);
            padding:16px;">
  <section class="card" style="max-width:520px; width:92%; padding:18px;">
    <div class="title" style="align-items:center">
  <span>Frecuencia de Personajes</span>
  <div class="inline" style="gap:8px">
    <button class="btn" id="btnCloseFilters" aria-label="Cerrar">‚úï</button>
  </div>
</div>

    <div class="inline" style="flex-direction:column; gap:14px; margin-top:16px">
      <!-- Anime -->
      <label style="width:100%">
        <div class="inline" style="justify-content:space-between">
          <span class="muted">Anime</span>
          <span class="kbd" id="wAnimeVal">1</span>
        </div>
        <input id="wAnime" type="range" min="0" max="5" step="1" value="1" />
      </label>

      <!-- Caricaturas -->
      <label style="width:100%">
        <div class="inline" style="justify-content:space-between">
          <span class="muted">Caricaturas</span>
          <span class="kbd" id="wCaricaturasVal">1</span>
        </div>
        <input id="wCaricaturas" type="range" min="0" max="5" step="1" value="1" />
      </label>

      <!-- Cine -->
      <label style="width:100%">
        <div class="inline" style="justify-content:space-between">
          <span class="muted">Cine</span>
          <span class="kbd" id="wCineVal">1</span>
        </div>
        <input id="wCine" type="range" min="0" max="5" step="1" value="1" />
      </label>

      <!-- Literatura -->
      <label style="width:100%">
        <div class="inline" style="justify-content:space-between">
          <span class="muted">Literatura</span>
          <span class="kbd" id="wLiteraturaVal">1</span>
        </div>
        <input id="wLiteratura" type="range" min="0" max="5" step="1" value="1" />
      </label>

      <!-- Videojuegos -->
      <label style="width:100%">
        <div class="inline" style="justify-content:space-between">
          <span class="muted">Videojuegos</span>
          <span class="kbd" id="wVideojuegosVal">1</span>
        </div>
        <input id="wVideojuegos" type="range" min="0" max="5" step="1" value="1" />
      </label>

      <!-- Mitolog√≠a & Folclore -->
      <label style="width:100%">
        <div class="inline" style="justify-content:space-between">
          <span class="muted">Mitolog√≠a & Folclore</span>
          <span class="kbd" id="wMitoVal">1</span>
        </div>
        <input id="wMito" type="range" min="0" max="5" step="1" value="1" />
      </label>

      <!-- Animales -->
      <label style="width:100%">
        <div class="inline" style="justify-content:space-between">
          <span class="muted">Animales</span>
          <span class="kbd" id="wAnimalesVal">1</span>
        </div>
        <input id="wAnimales" type="range" min="0" max="5" step="1" value="1" />
      </label>

      <!-- Arquetipos -->
      <label style="width:100%">
        <div class="inline" style="justify-content:space-between">
          <span class="muted">Arquetipos</span>
          <span class="kbd" id="wArquetiposVal">1</span>
        </div>
        <input id="wArquetipos" type="range" min="0" max="5" step="1" value="1" />
      </label>

      <!-- Famosos -->
      <label style="width:100%">
        <div class="inline" style="justify-content:space-between">
          <span class="muted">Famosos</span>
          <span class="kbd" id="wFamososVal">1</span>
        </div>
        <input id="wFamosos" type="range" min="0" max="5" step="1" value="1" />
      </label>

      <!-- Otros -->
      <label style="width:100%">
        <div class="inline" style="justify-content:space-between">
          <span class="muted">Otros</span>
          <span class="kbd" id="wOtrosVal">1</span>
        </div>
        <input id="wOtros" type="range" min="0" max="5" step="1" value="1" />
      </label>

      <!-- Simulador -->
      <div class="inline" style="width:100%; justify-content:space-between; margin-top:10px">
        <div class="inline" style="gap:8px">
          <button class="btn" id="btnResetWeights" title="Restablecer a 1">Reset</button>
          <button class="btn" id="btnSimDist" title="Simular 2,000 picks seg√∫n los pesos">Test</button>
        </div>
        <span class="muted" id="simDistResult">‚Äî</span>
      </div>
    </div>
  </section>
</div>

  <main class="container" style="padding-top:18px">
    <section class="card" id="adminControls">
  <div class="controlsGrid" style="display:grid;gap:10px">
    <!-- Fila 1: botones principales -->
    <div class="inline">
      <button class="btn" id="btnP"><span class="letter-p">P</span></button>
      <button class="btn" id="btnFusion"><span class="letter-p">P</span> + <span class="letter-p">P</span></button>
      <button class="btn" id="btnDoble">x2</button>
      <button class="btn" id="btnTriple">x3</button>
      <button class="btn" id="btnReto">RETO</button>
      <button class="btn" id="btnEvento">EVENTO</button>
      <button class="btn" id="btnEscena">ESCENA</button>
      <button class="btn" id="btnSecreto">SECRETO</button>
      <button class="btn" id="btnMasterpiece">OBRA MAESTRA</button>
      <button class="btn btn-chip" id="btnToggleAdv" aria-expanded="false" title="Mostrar/ocultar opciones avanzadas">
  M√°s opciones <span class="chev">‚ñæ</span>
</button>
      <button class="btn" id="btnFilters" title="Ajustar pesos por categor√≠a">Filtros</button>
</div>
    </div>

    <!-- Fila 2 (plegable): opciones avanzadas -->
    <div class="inline" id="advRow" style="display:none; margin-top:6px">
      <button class="btn" id="btnPV"><span class="letter-p">P</span> + <span class="letter-v">V</span></button>
      <button class="btn" id="btnPA"><span class="letter-p">P</span> + <span class="letter-a">A</span></button>
      <button class="btn" id="btnPL"><span class="letter-p">P</span> + <span class="letter-l">L</span></button>
      <button class="btn" id="btnPVA"><span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-a">A</span></button>
      <button class="btn" id="btnPAL"><span class="letter-p">P</span> + <span class="letter-a">A</span> + <span class="letter-l">L</span></button>
      <button class="btn" id="btnPVL"><span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-l">L</span></button>
      <button class="btn" id="btnPVAL"><span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-a">A</span> + <span class="letter-l">L</span></button>
    </div>
  </div>
</section>

    <section class="card" style="margin-top:14px">
  <div class="title" style="align-items:center">
    <span>Enunciado a dibujar</span>
    <div class="inline">
      <button class="btn" id="btnClearOutput" title="Limpiar enunciado mostrado">Limpiar</button>
    </div>
  </div>
  <div id="salida" class="out" style="margin-top:10px;white-space:pre-wrap"></div>
  <div id="challengeNote" class="challengeNote" style="margin-top:8px;"></div>
  <div id="testlog" class="muted" style="margin-top:10px"></div>
</section>

 <!-- Jugadores conectados -->
<section class="card" id="playersCard" style="margin-top:10px; display:none">
  <div class="players-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <span id="playersTitle" style="font-size:1rem; font-weight:500; color:#9ca3af;">
      Jugadores conectados
    </span>
    <div class="players-title-actions">
      <button class="btn" id="btnGrupos" title="Formar parejas asignando Grupo A, B, C‚Ä¶">Generar grupos</button>
    </div>
  </div>
  <div id="playersList" class="players-wrap" style="margin-top:6px"></div>
</section>
  </main>

  <footer>
    <div id="footerBtns">
      <button class="btn" id="btnCopiar">Copiar</button>
      <button class="btn" id="btnTest">Test</button>
    </div>
    <div id="timerWrap" class="inline" style="margin-top:10px;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap">
  <select id="timerSelect" class="btn" style="padding:8px 10px">
    <option value="30">30s</option>
    <option value="60">60s</option>
    <option value="90">90s</option>
    <option value="120">120s</option>
  </select>

  <!-- El reloj AHORA es el bot√≥n -->
  <button id="timerDisplay"
        class="kbd"
        type="button"
        aria-label="Iniciar o cancelar temporizador"
        title="Iniciar / Cancelar">
  Iniciar
</button>
</div>
    <div class="copyright">¬© 2025 Tabja Games</div>
  </footer>

  <!-- Toast element -->
  <div id="toast"></div>

  <script>
    /* === Generadores locales === */
const PERSONAJES = [
  // ==== Originales ====
  "Goku","Vegeta","Piccolo","Freezer","Monkey D. Luffy","Roronoa Zoro","Sanji","Nami",
  "Naruto Uzumaki","Sasuke Uchiha","Kakashi Hatake","Ichigo Kurusaki","Satoru Gojo","Eren Yeager","Levi Ackerman",
  "Shigeo Kageyama","Saitama","Edward Elric","Tanjiro Kamado","Nezuko Kamado","Kenshin Himura","Joseph Joestar",
  "Guts","Ash Ketchum","Yugi Muto","Bob Esponja","Patricio Estrella","Calamardo","Arnold Shortman","Aang",
  "Timmy Turner","Jimmy Neutron","Johnny Bravo","Mojo Jojo","Perry El Ornitorrinco","Optimus Prime","Mickey Mouse",
  "Bugs Bunny","El Pato Donald","Felix El Gato","Winnie-the-Pooh","Charlie Brown","Snoopy","Hello Kitty",
  "Dora La Exploradora","Peppa Pig","Homero Simpson","Rick Sanchez","Morty Smith","Eric Cartman","Buzz Lightyear",
  "Mike Wazowski","Shrek","Wall-E","Stitch","Nemo","Elsa","Simba","Luke Skywalker","Darth Vader","Yoda","E.T.",
  "John Wick","Neo","Indiana Jones","El Terminator","Jack Sparrow","Borat","Charlie Chaplin","Jason Voorhees",
  "Chucky","Freddy Krueger","Jigsaw","Pennywise","Edward Scissorhands","Jack Skellington","Godzilla","El Xenomorfo",
  "Superman","Spider-Man","Batman","Wolverine","Hulk","Venom","Thor","El Joker","Albert Einstein","Messi",
  "Napole√≥n Bonaparte","Atahualpa","Hitler","Michael Jackson","Freddie Mercury","Beethoven","Pedro Castillo",
  "Donald Trump","Gandalf","Frodo Baggins","Gollum","Harry Potter","Voldemort","Willy Wonka","Cenicienta","Rapunzel",
  "Aladino","Dracula","Frankenstein","Wednesday Addams","El Jorobado de Notre Dame","James Bond",
  "Don Quijote de la Mancha","El Gato con Botas","Robin Hood","Pinnochio","Tarz√°n","Tralalero Tralal√°",
  "Brr Brr Patap√≠m","Chimpanzini Bananini","Tung Tung Tung Sahur","Bombardino Crocodilo","La Vaca Saturno Saturnita",
  "Clippy","El Chavo del Ocho","Jon Snow","Walter White","La Rana Ren√©","Pikachu","Mario","Bowser","Yoshi",
  "Donkey Kong","Kirby","Link","Zelda","Samus Aran","Sonic","Crash Bandicoot","Mega Man","Pac-Man",
  "Leon S. Kennedy","Lara Croft","El Amongus","Santa Claus","Dios","Atlas","Zeus","Poseid√≥n","H√©rcules","Pegaso",
  "El Kraken","El C√≠clope","El Minotauro","El Cerbero","El F√©nix","El Leviat√°n","El Fenrir","La Medusa","La Muerte",
  "El Yeti","El Chupacabras","Un √Ångel","Un Demonio","Un Centauro","Un G√≥lem","Un Basilisco","Un Grifo","Un Ogro",
  "Una Sirena","Una Arp√≠a","Una Hidra","Una Quimera","Un Lic√°ntropo","Un Unicornio","Una Bruja","Un Drag√≥n",
  "Una Valquiria","Un Elfo","Un Gnomo","Un Duende","Un Hada","Un Fantasma","Un Vampiro","Un Zombie","Una Momia",
  "Un Esqueleto","Un Mago", "Una Mujer","Un Hombre","Un Perro","Un Gato","Un Le√≥n","Un Mono","Una Vaca","Un Elefante","Un Caballo","Un Camello",
  "Una Jirafa","Una Oveja","Un Cerdo","Un Oso","Un Canguro","Un Conejo","Una Ardilla","Un Rat√≥n","Una Serpiente",
  "Un Cocodrilo","Una Rana","Una Ara√±a","Un Escorpi√≥n","Una Hormiga","Una Cucaracha","Un Caracol","Un Zancudo",
  "Un Pez","Un Delf√≠n","Un Tibur√≥n","Una Ballena","Una Tortuga","Un Cangrejo","Una Langosta","Un Pulpo","Un Calamar",
  "Una Malagua","Un Ping√ºino","Un Pato","Un Flamenco","Un √Åguila","Un B√∫ho","Un Murci√©lago","Un Virus","Un Dinosaurio",
  "La Salchicha","La Hamburguesa","La Pi√±a","El Pl√°tano","La Zanahoria","El Aguacate","El Huevo","La Galleta",
  "El Burrito","El Nugget","El H√©roe","El Rey","El Caballero","Un Profeta","El Verdugo","Un Viajero","Un Gladiador",
  "Un Esclavo","Un Samurai","Un Ninja","Un N√≥mada","Un Vikingo","Un Soldado","Un Buf√≥n","Un Pirata","Un Vaquero",
  "Un Le√±ador","Un Detective","Un Payaso","Un Chef","Un M√∫sico","Un Pintor","Un Carpintero","Un Cient√≠fico",
  "Un Astronauta","Un Marciano","Un Robot","Una Prostituta","Un Monje","Yo","El √Årbol","El Zapato","La Mochila",
  "El Libro","La Bomba At√≥mica","La Computadora","El Tel√©fono","El Calcet√≠n","El Mu√±eco de Nieve","Un Pok√©mon",
  "Blancanieves","Severus Snape","Sherlock Holmes","El Capit√°n Am√©rica","Peter Pan","Luigi","Barbie","Popeye",
  "El Pato Lucas","Betty Boop","Iron Man","Un Guerrero","Doomguy","El Grinch",
  "Michael Scott","Ronald McDonald","Tom Sawyer","El Jinete sin Cabeza","Quasimodo","Sailor Moon","Michael Myers",
  "Astroboy","Izuku Midoriya","Itachi Uchiha","Frieren","Fern","Yor Forger","Deadpool","Mal√©fica","Peter Griffin",
  "Danny Phantom","Groot","Knuckles","Ryu","Sephiroth","Cloud Strife","Steve","Nier","Bomberman","Diddy Kong",
  "Toad","Fox McCloud","Mewtwo","Cuphead","Agumon","Rayman","Hollow Knight","Wario","Waluigi","La Princesa Peach","2B"
];
   /* Categor√≠as principales (10):
   - anime
   - videojuegos
   - peliculas
   - series
   - comics
   - profesiones
   - mitologia
   - criaturas
   - animales
   - otros (fallback)
*/

/* Categor√≠as principales (10) seg√∫n tu lista:
   - Anime
   - Caricaturas
   - Cine
   - Literatura
   - Videojuegos
   - Mitolog√≠a & Folclore
   - Animales
   - Arquetipos
   - Famosos
   - Otros (fallback)
*/

// === Sets con tus personajes EXACTOS ===
const CAT_ANIME = new Set([
  "Goku","Vegeta","Piccolo","Freezer","Monkey D. Luffy","Roronoa Zoro","Sanji","Nami",
  "Naruto Uzumaki","Sasuke Uchiha","Kakashi Hatake","Ichigo Kurusaki","Satoru Gojo",
  "Eren Yeager","Levi Ackerman","Shigeo Kageyama","Saitama","Edward Elric",
  "Tanjiro Kamado","Nezuko Kamado","Kenshin Himura","Joseph Joestar","Guts",
  "Ash Ketchum","Yugi Muto","Agumon","Sailor Moon","Astroboy",
  "Izuku Midoriya","Itachi Uchiha","Frieren","Fern","Yor Forger"
]);

const CAT_CARICATURAS = new Set([
  "Bob Esponja","Patricio Estrella","Calamardo","Arnold Shortman","Aang","Timmy Turner","Jimmy Neutron",
  "Johnny Bravo","Mojo Jojo","Perry El Ornitorrinco","Optimus Prime","Mickey Mouse",
  "Bugs Bunny","El Pato Donald","Felix El Gato","Winnie-the-Pooh","Charlie Brown",
  "Snoopy","Hello Kitty","Dora La Exploradora","Peppa Pig","Homero Simpson","Rick Sanchez",
  "Morty Smith","Eric Cartman","Buzz Lightyear","Popeye","El Pato Lucas","Betty Boop",
  "Danny Phantom"
]);

const CAT_CINE = new Set([
  "Mike Wazowski","Shrek","Wall-E","Stitch","Nemo","Elsa","Simba","Luke Skywalker",
  "Darth Vader","Yoda","E.T.","John Wick","Neo","Indiana Jones","El Terminator",
  "Jack Sparrow","Borat","Jason Voorhees","Chucky","Freddy Krueger","Jigsaw",
  "Edward Scissorhands","Jack Skellington","Godzilla","El Xenomorfo","El Chavo del Ocho",
  "Walter White","La Rana Ren√©","Cenicienta","Rapunzel","Aladino","Wednesday Addams",
  "Superman","Spider-Man","Batman","Wolverine","Hulk","Venom","Thor","El Joker",
  "El Capit√°n Am√©rica","Peter Pan","Blancanieves","Barbie","Iron Man","Mal√©fica",
  "Peter Griffin","El Grinch","Michael Scott","Michael Myers","Groot","Deadpool"
]);

const CAT_LITERATURA = new Set([
  "Gandalf","Frodo Baggins","Gollum","Harry Potter","Voldemort","Willy Wonka","Dracula",
  "Frankenstein","James Bond","El Gato con Botas","Robin Hood","Pinnochio","Tarz√°n",
  "Pennywise","Jon Snow","Severus Snape","Sherlock Holmes","Quasimodo",
  "Don Quijote de la Mancha","Tom Sawyer","El Jinete sin Cabeza"
]);

const CAT_VIDEOJUEGOS = new Set([
  "Pikachu","Mewtwo","Mario","Bowser","Yoshi","Donkey Kong","Kirby","Link","Zelda",
  "Samus Aran","Sonic","Crash Bandicoot","Mega Man","Pac-Man","Leon S. Kennedy",
  "Lara Croft","Knuckles","Ryu","Sephiroth","Cloud Strife","Steve","Nier","Bomberman",
  "Diddy Kong","Toad","Fox McCloud","Cuphead","Rayman","Hollow Knight","Wario","Waluigi",
  "Luigi","La Princesa Peach","2B","Doomguy","El Amongus"
]);

const CAT_MITO = new Set([
  "Santa Claus","Dios","Atlas","Zeus","Poseid√≥n","H√©rcules","Pegaso",
  "El Kraken","El C√≠clope","El Minotauro","El Cerbero","El F√©nix","El Leviat√°n",
  "El Fenrir","La Medusa","La Muerte","El Yeti","El Chupacabras","Un √Ångel","Un Demonio",
  "Un Centauro","Un G√≥lem","Un Basilisco","Un Grifo","Un Ogro","Una Sirena","Una Arp√≠a",
  "Una Hidra","Una Quimera","Un Lic√°ntropo","Un Unicornio","Una Bruja","Un Drag√≥n",
  "Una Valquiria","Un Elfo","Un Gnomo","Un Duende","Un Hada","Un Fantasma","Un Vampiro",
  "Un Zombie","Una Momia","Un Esqueleto","Un Mago","Un Marciano"
]);

const CAT_ANIMALES = new Set([
  "Una Mujer","Un Hombre","Un Perro","Un Gato","Un Le√≥n","Un Mono","Una Vaca",
  "Un Elefante","Un Caballo","Un Camello","Una Jirafa","Una Oveja","Un Cerdo","Un Oso",
  "Un Canguro","Un Conejo","Una Ardilla","Un Rat√≥n","Una Serpiente","Un Cocodrilo",
  "Una Rana","Una Ara√±a","Un Escorpi√≥n","Una Hormiga","Una Cucaracha","Un Caracol",
  "Un Zancudo","Un Pez","Un Delf√≠n","Un Tibur√≥n","Una Ballena","Una Tortuga","Un Cangrejo",
  "Una Langosta","Un Pulpo","Un Calamar","Una Malagua","Un Ping√ºino","Un Pato",
  "Un Flamenco","Un √Åguila","Un B√∫ho","Un Murci√©lago","Un Virus","Un Dinosaurio"
]);

const CAT_ARQUETIPOS = new Set([
  "El H√©roe","El Rey","El Caballero","Un Profeta","El Verdugo","Un Viajero","Un Gladiador",
  "Un Esclavo","Un Samurai","Un Ninja","Un N√≥mada","Un Vikingo","Un Soldado","Un Buf√≥n",
  "Un Pirata","Un Vaquero","Un Le√±ador","Un Detective","Un Carpintero","Un Robot",
  "Un Payaso","Un Chef","Un M√∫sico","Un Pintor","Una Prostituta","Un Monje",
  "Un Cient√≠fico","Un Astronauta","Un Guerrero","Yo"
]);

const CAT_FAMOSOS = new Set([
  "Albert Einstein","Messi","Napole√≥n Bonaparte","Atahualpa","Hitler","Michael Jackson",
  "Freddie Mercury","Beethoven","Pedro Castillo","Donald Trump","Ronald McDonald",
  "Charlie Chaplin"
]);

// --- BUCKETS (claves cortas) ---
const BUCKETS = {
  anime:[], caricaturas:[], cine:[], literatura:[], videojuegos:[],
  mito:[], animales:[], arquetipos:[], famosos:[], otros:[]
};

// Construcci√≥n de buckets usando los sets
for (const name of PERSONAJES) {
  const cat =
    CAT_ANIME.has(name)        ? 'anime' :
    CAT_CARICATURAS.has(name)  ? 'caricaturas' :
    CAT_CINE.has(name)         ? 'cine' :
    CAT_LITERATURA.has(name)   ? 'literatura' :
    CAT_VIDEOJUEGOS.has(name)  ? 'videojuegos' :
    CAT_MITO.has(name)         ? 'mito' :
    CAT_ANIMALES.has(name)     ? 'animales' :
    CAT_ARQUETIPOS.has(name)   ? 'arquetipos' :
    CAT_FAMOSOS.has(name)      ? 'famosos' : 'otros';
  BUCKETS[cat].push(name);
}

function categoriaDe(nombre){
  if (CAT_ANIME.has(nombre))        return 'anime';
  if (CAT_CARICATURAS.has(nombre))  return 'caricaturas';
  if (CAT_CINE.has(nombre))         return 'cine';
  if (CAT_LITERATURA.has(nombre))   return 'literatura';
  if (CAT_VIDEOJUEGOS.has(nombre))  return 'videojuegos';
  if (CAT_MITO.has(nombre))         return 'mito';
  if (CAT_ANIMALES.has(nombre))     return 'animales';
  if (CAT_ARQUETIPOS.has(nombre))   return 'arquetipos';
  if (CAT_FAMOSOS.has(nombre))      return 'famosos';
  return 'otros';
}

// Pesos por categor√≠a (persisten en localStorage)
// Nota: merge con guardados viejos para compatibilidad
const DEFAULT_WEIGHTS = {
  anime:1, caricaturas:1, cine:1, literatura:1, videojuegos:1,
  mito:1, animales:1, arquetipos:1, famosos:1, otros:1
};

let WEIGHTS = (()=> {
  try{
    const saved = JSON.parse(localStorage.getItem('am_weights')) || {};
    return { ...DEFAULT_WEIGHTS, ...saved };
  }catch(e){ return { ...DEFAULT_WEIGHTS }; }
})();

function setWeight(cat, val){
  WEIGHTS[cat] = Math.max(0, Number(val)||0);
  try{ localStorage.setItem('am_weights', JSON.stringify(WEIGHTS)); }catch(e){}
}
function getWeight(cat){ return Number(WEIGHTS[cat] ?? 1); }

// Elecci√≥n de categor√≠a solo por pesos
function pickCategoryByWeight(R){
  const cats = ['anime','caricaturas','cine','literatura','videojuegos','mito','animales','arquetipos','famosos','otros'];
  const alive = cats.filter(c => BUCKETS[c].length > 0);
  let total = 0;
  const cum = [];
  for (const c of alive){ total += Math.max(0, getWeight(c)); cum.push(total); }
  if (total <= 0) return alive[Math.floor(R()*alive.length)];
  const t = R()*total;
  for (let i=0;i<cum.length;i++){ if (t < cum[i]) return alive[i]; }
  return alive[alive.length-1];
}

function pickPersonaje(R){
  const cat = pickCategoryByWeight(R);
  const arr = BUCKETS[cat];
  if (!arr || arr.length === 0) {
    return PERSONAJES[Math.floor(R()*PERSONAJES.length)];
  }
  return arr[Math.floor(R()*arr.length)];
}

// export helpers
window.pickPersonaje = pickPersonaje;
window.setWeight = setWeight;
window.getWeight = getWeight;

// === UI de pesos ===
function setSliderVal(idSlider, idBadge, v){
  const s = document.getElementById(idSlider);
  const b = document.getElementById(idBadge);
  if(s) s.value = v;
  if(b) b.textContent = String(v);
}

// Habilitar/deshabilitar sliders (seg√∫n rol)
window.setWeightsEnabled = function onOff(on){
  const ids = ['wAnime','wCaricaturas','wCine','wLiteratura','wVideojuegos','wMito','wAnimales','wArquetipos','wFamosos','wOtros'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.disabled = !on;
    el.style.opacity = on ? '' : '0.6';
    el.style.pointerEvents = on ? '' : 'none';
  });
};

function initWeightSliders(){
  // Cargar valores
  setSliderVal('wAnime','wAnimeVal',              getWeight('anime'));
  setSliderVal('wCaricaturas','wCaricaturasVal',  getWeight('caricaturas'));
  setSliderVal('wCine','wCineVal',                getWeight('cine'));
  setSliderVal('wLiteratura','wLiteraturaVal',    getWeight('literatura'));
  setSliderVal('wVideojuegos','wVideojuegosVal',  getWeight('videojuegos'));
  setSliderVal('wMito','wMitoVal',                getWeight('mito'));
  setSliderVal('wAnimales','wAnimalesVal',        getWeight('animales'));
  setSliderVal('wArquetipos','wArquetiposVal',    getWeight('arquetipos'));
  setSliderVal('wFamosos','wFamososVal',          getWeight('famosos'));
  setSliderVal('wOtros','wOtrosVal',              getWeight('otros'));

  // Hook helper
  const hook = (idSlider, idBadge, cat)=>{
    const s = document.getElementById(idSlider);
    if(!s) return;
    s.addEventListener('input', async ()=>{
      const v = parseInt(s.value,10);
      setWeight(cat, v);
      const b = document.getElementById(idBadge);
      if(b) b.textContent = String(v);

      // Publicar a Firebase si corresponde
      if (window.lobbyCode && window.isHost && window.db && window.fbRef && window.fbUpdate) {
        try {
          const path = `lobbies/${window.lobbyCode}/weights`;
          await window.fbUpdate(window.fbRef(window.db, path), { ...WEIGHTS });
          if (window.showToast) window.showToast('Pesos guardados');
        } catch (e) { console.warn('No se pudieron publicar los pesos:', e); }
      }
    });
  };

  // Hooks
  hook('wAnime','wAnimeVal','anime');
  hook('wCaricaturas','wCaricaturasVal','caricaturas');
  hook('wCine','wCineVal','cine');
  hook('wLiteratura','wLiteraturaVal','literatura');
  hook('wVideojuegos','wVideojuegosVal','videojuegos');
  hook('wMito','wMitoVal','mito');
  hook('wAnimales','wAnimalesVal','animales');
  hook('wArquetipos','wArquetiposVal','arquetipos');
  hook('wFamosos','wFamososVal','famosos');
  hook('wOtros','wOtrosVal','otros');

  // Reset
  const btnReset = document.getElementById('btnResetWeights');
  if(btnReset){
    btnReset.addEventListener('click', async ()=>{
      ['anime','caricaturas','cine','literatura','videojuegos','mito','animales','arquetipos','famosos','otros'].forEach(cat=> setWeight(cat,1));
      initWeightSliders();

      if (window.lobbyCode && window.isHost && window.db && window.fbRef && window.fbUpdate) {
        try{
          const path = `lobbies/${window.lobbyCode}/weights`;
          await window.fbUpdate(window.fbRef(window.db, path), { ...WEIGHTS });
          if (window.showToast) window.showToast('Pesos restablecidos (sala)');
        }catch(e){ console.warn('No se pudieron publicar los pesos (reset):', e); }
      } else {
        if (window.showToast) window.showToast('Pesos restablecidos');
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', initWeightSliders);
initWeightSliders();

// Simulador de distribuci√≥n
function simularDistribucion(n=2000){
  const R = rng('sim-'+Date.now());
  const tally = { anime:0, caricaturas:0, cine:0, literatura:0, videojuegos:0, mito:0, animales:0, arquetipos:0, famosos:0, otros:0 };
  for(let i=0;i<n;i++){
    const p = pickPersonaje(R);
    tally[categoriaDe(p)]++;
  }
  const pct = Object.fromEntries(Object.entries(tally).map(([k,v])=> [k, Math.round(v*100/n)]));
  return { tally, pct, n };
}
function attachSimBtn(){
  const btn = document.getElementById('btnSimDist');
  const out = document.getElementById('simDistResult');
  if(!btn || !out) return;
  btn.addEventListener('click', ()=>{
    const { pct, n } = simularDistribucion(2000);
    out.textContent =
      `Anime ${pct.anime}% ‚Ä¢ Caricaturas ${pct.caricaturas}% ‚Ä¢ Cine ${pct.cine}% ‚Ä¢ Literatura ${pct.literatura}% ‚Ä¢ `+
      `Videojuegos ${pct.videojuegos}% ‚Ä¢ Mitolog√≠a & Folclore ${pct.mito}% ‚Ä¢ Animales ${pct.animales}% ‚Ä¢ `+
      `Arquetipos ${pct.arquetipos}% ‚Ä¢ Famosos ${pct.famosos}% ‚Ä¢ Otros ${pct.otros}% (n=${n})`;
    if(window.showToast) window.showToast('Simulaci√≥n lista');
  });
}
attachSimBtn();

    const VERBOS=['leyendo','patinando','esquiando','surfeando','navegando','cabalgando','pedaleando','nadando','bailando','pescando','regando','componiendo','escribiendo','cocinando','conduciendo','cenando','trabajando','jugando','barriendo','corriendo','caminando','saltando','trepando','luchando','descansando','durmiendo','marchando','volando','bebiendo','fumando','vomitando','masturbando','orinando','cagando','copulando','muriendo','naciendo','pariendo','gritando','llorando','cantando','pensando','rezando','vendiendo','saludando','boxeando'];
    const ADJETIVOS=['content@','enojad@','asustad@','preocupad@','desnud@','cansad@','confundid@','excitad@','aburrid@','sorprendid@','doblad@','sentad@','parad@','arrodillad@','echad@','suspendid@','tembland@','derretid@','herid@','atad@','enamorad@','relajad@','borrach@','nervios@','enferm@','descalz@','tens@'];
    const LUGARES=['bajo el agua','bajo el sol','bajo la luna','bajo la lluvia','bajo la tierra','bajo las estrellas','bajo un √°rbol','bajo un puente','sobre un tren','sobre una torre','sobre una cama','sobre una mesa','sobre un techo','sobre las nubes','tras los arbustos','tras una roca','tras la ventana','tras las rejas','en el campo','en el mar','en el espacio','en el futuro','en el pasado','en el infierno','en el cielo','en la ciudad','en la monta√±a','en la playa','en la selva','en el Valhalla','en el Olimpo','en la corte','en el fin del mundo','en la prehistoria','en un ba√±o','en un bosque','en un colegio','en un desierto','en un gimnasio','en un zool√≥gico','en un pantano','en una tormenta','en una oficina','en un bar','en un hospital','en un cementerio','en un parque','en un balc√≥n','en una granja','en un teatro','en una biblioteca','en un cine','en un avi√≥n','en un helic√≥ptero','en un cohete','en un castillo','en un mercado','en una pradera','en un globo','en un burdel','en un laboratorio','en una prisi√≥n','en un jard√≠n','en Egipto','en Francia','en Jap√≥n','en Per√∫','en Australia','en la Ant√°rtida','en su casa','en su habitaci√≥n'];
    const EVENTOS=['El nacimiento de','La muerte de','La creaci√≥n de','La destrucci√≥n de','La victoria de','La derrota de','El sacrificio de','La furia de','La ca√≠da de','El sue√±o de','El regreso de','La invasi√≥n de','El ritual de','La persecuci√≥n de','La evoluci√≥n de','Los ojos de','El beso de','El rapto de','La danza de','La casa de','La habitaci√≥n de','El ba√±o de','Retrato de','La venganza de','La tortura de','El castigo de','La traici√≥n de','La ejecuci√≥n de','El asesinato de','La rebeli√≥n de','El entierro de','La confesi√≥n de','El cumplea√±os de','El concierto de','El bautizo de','El Baby Shower de','La aventura de'];
    const ESCENAS=['Guerra','Paz','Caos','Orden','Odio','Amor','Soledad','Invierno','Verano','Oto√±o','Primavera','Amanecer','Atardecer','Anochecer','Terror','Incendio','Duelo','Batalla','Matrimonio','Despedida','Bienvenida','Encuentro','Apocalipsis','Tragedia','Desastre','Cat√°strofe','Exterminio','Masacre','Tratado','Barbacoa','Picnic','Banquete','Fiesta','Excursi√≥n','Olimpiadas','Carnaval','Desfile','Venganza','Tortura','Castigo','Traici√≥n','Ejecuci√≥n','Asesinato','Revoluci√≥n','Funeral','Confesi√≥n','Cumplea√±os','Concierto','Bautizo','Baby Shower','Aventura'];

    const byId=id=>document.getElementById(id);
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
    function rng(seed){if(!seed)return Math.random;let n=0;for(let i=0;i<seed.length;i++)n=(n*31+seed.charCodeAt(i))>>>0;return mulberry32(n)}
    const pick=(arr,R)=>arr[Math.floor(R()*arr.length)];
    const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    const wrapChar=name=>`<span class="char">${esc(name)}</span>`;
    const wrapVerb=v=>`<span class="verb">${esc(v)}</span>`;
    const wrapAdj=a=>`<span class="adj">${esc(a)}</span>`;
    const wrapPlace=l=>`<span class="place">${esc(l)}</span>`;
    const wrapEvent=e=>`<span class="event">${esc(e)}</span>`;
    const wrapScene=s=>`<span class="scene">${esc(s)}</span>`;

    function genPVAL(R){const p=pickPersonaje(R),v=pick(VERBOS,R),a=pick(ADJETIVOS,R),l=pick(LUGARES,R);return{ text:`${p} ${v} ${a} ${l}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapAdj(a)} ${wrapPlace(l)}` }}
    function genPV(R){const p=pickPersonaje(R),v=pick(VERBOS,R);return{ text:`${p} ${v}`, html:`${wrapChar(p)} ${wrapVerb(v)}` }}
    function genPA(R){const p=pickPersonaje(R),a=pick(ADJETIVOS,R);return{ text:`${p} ${a}`, html:`${wrapChar(p)} ${wrapAdj(a)}` }}
    function genPL(R){const p=pickPersonaje(R),l=pick(LUGARES,R);return{ text:`${p} ${l}`, html:`${wrapChar(p)} ${wrapPlace(l)}` }}
    function genPAL(R){const p=pickPersonaje(R),a=pick(ADJETIVOS,R),l=pick(LUGARES,R);return{ text:`${p} ${a} ${l}`, html:`${wrapChar(p)} ${wrapAdj(a)} ${wrapPlace(l)}` }}
    function genPVA(R){const p=pickPersonaje(R),v=pick(VERBOS,R),a=pick(ADJETIVOS,R);return{ text:`${p} ${v} ${a}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapAdj(a)}` }}
    function genPVL(R){const p=pickPersonaje(R),v=pick(VERBOS,R),l=pick(LUGARES,R);return{ text:`${p} ${v} ${l}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapPlace(l)}` }}
function genFusion(R){
  let p1 = pickPersonaje(R);
  let p2;
  do{ p2 = pickPersonaje(R); }while(p2 === p1);
  return { text:`${p1} + ${p2}`, html:`${wrapChar(p1)} + ${wrapChar(p2)}` }
}
    function genP(R){const p=pickPersonaje(R);return{ text:`${p}`, html:`${wrapChar(p)}` }}
    function genEvento(R){const e=pick(EVENTOS,R),p=pickPersonaje(R);return{ text:`${e} ${p}`, html:`${wrapEvent(e)} ${wrapChar(p)}` }}
    function genEscena(R){const s=pick(ESCENAS,R),l=pick(LUGARES,R);return{ text:`${s} ${l}`, html:`${wrapScene(s)} ${wrapPlace(l)}` }}

    let lastCopyText='';

    function generarUno(mode){
      const R=rng();
      switch(mode){
        case'PV':return genPV(R);
        case'PA':return genPA(R);
        case'PL':return genPL(R);
        case'PAL':return genPAL(R);
        case'PVA':return genPVA(R);
        case'PVL':return genPVL(R);
        case'FUSION':return genFusion(R);
        case'P':return genP(R);
        case'EVENTO':return genEvento(R);
        case'ESCENA':return genEscena(R);
        default:return genPVAL(R);
      }
    }

    function generarN(mode,n){
      const R=rng();
      const gens={PVAL:genPVAL,PV:genPV,PA:genPA,PL:genPL,PAL:genPAL,PVA:genPVA,PVL:genPVL,FUSION:genFusion,P:genP,EVENTO:genEvento,ESCENA:genEscena};
      const fn=gens[mode]||genPVAL;
      const out=Array.from({length:n},()=>fn(R));
      document.getElementById('salida').innerHTML=out.map(o=>o.html).join('<br>');
      lastCopyText=out.map(o=>o.text).join('\n');
    }

    // Toast + sonidos
    const toastEl = document.getElementById('toast');
    let toastTimer=null, __uiAudioCtx;
    function showToast(msg){
      if(!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 2200);
    }
   function playClick(){
  try{
    const a = window.sndButton || new Audio('sfx/button_press.mp3'); // fallback por si acaso
    a.currentTime = 0;  // evita solaparse si haces clics seguidos
    const p = a.play();
    if (p && p.catch) p.catch(()=>{ /* autoplay blocked, no pasa nada */ });
  }catch(e){}
}
    (function(){ document.querySelectorAll('button').forEach(b=> b.addEventListener('click', playClick, {capture:true})); })();

    document.getElementById('btnCopiar').onclick=async()=>{
      if(!lastCopyText) return;
      await navigator.clipboard.writeText(lastCopyText);
    };

    document.getElementById('btnTest').onclick=()=>{
      const modes=['PVAL','PV','PA','PL','PAL','PVA','PVL','FUSION','P','EVENTO','ESCENA'];
      let report='Pruebas:';
      for(const m of modes){
        let ok=0,total=100;
        for(let i=0;i<total;i++){
          const {text,html}=generarUno(m);
          if(typeof text==='string'&&text.length>0&&typeof html==='string'&&html.length>0) ok++;
        }
        report+=`\n‚Ä¢ ${m}: ${ok}/${total} generados correctamente`;
      }
      document.getElementById('testlog').textContent=report;
    };

    document.addEventListener('keydown',e=>{
      if((e.metaKey||e.ctrlKey)){
        if(e.key==='1'){e.preventDefault();generarN('PVAL',1);} 
        if(e.key==='2'){e.preventDefault();generarN('PV',1);}   
        if(e.key==='3'){e.preventDefault();generarN('PA',1);}   
        if(e.key==='4'){e.preventDefault();generarN('PL',1);}   
        if(e.key==='5'){e.preventDefault();generarN('FUSION',1);} 
        if(e.key==='6'){e.preventDefault();generarN('P',1);}    
      }
    });

    generarN('PVAL',1);
  </script>

  <!-- üî• Firebase Realtime (grupos, colores, score y generaci√≥n por grupo) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, onDisconnect, push, get, off, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAHEBnKMHJt9npV6NeHzSjWdJtBE9EUmwQ",
      authDomain: "arte-moderno-5ff8a.firebaseapp.com",
      projectId: "arte-moderno-5ff8a",
      storageBucket: "arte-moderno-5ff8a.firebasestorage.app",
      messagingSenderId: "478321511301",
      appId: "1:478321511301:web:6b46294944397c0ce952ec",
      measurementId: "G-BP2SKW1881"
    };

    const appFB = initializeApp(firebaseConfig);
    const db = getDatabase(appFB);
    // Exponer Firebase helpers para el script no-module
window.db = db;
window.fbRef = ref;
window.fbUpdate = update;
    const rng = window.rng;
   // === SFX del temporizador ===
const sndBeep  = new Audio('sfx/timer_beep.mp3');   // beep por segundo (√∫ltimos 10s)
const sndAlarm = new Audio('sfx/timer_alarm.mp3');  // alarma al llegar a 0
    // Sonido de bot√≥n
const sndButton = new Audio('sfx/button_press.mp3');
sndButton.preload = 'auto';
sndButton.volume = 0.8; // ajusta si quieres
window.sndButton = sndButton;
sndBeep.preload  = 'auto';
sndAlarm.preload = 'auto';
sndBeep.volume   = 0.7; // ajusta si quieres
sndAlarm.volume  = 1.0; // ajusta si quieres

// üß© funci√≥n para detener el beep
function stopBeep(){
  try{
    sndBeep.pause();
    sndBeep.currentTime = 0;
  }catch(e){}
}

const genPVAL = window.genPVAL;

function getClientId(){
  const k="am_client_id";
  let id=localStorage.getItem(k);
  if(!id){ id = Math.random().toString(36).slice(2); localStorage.setItem(k,id); }
  return id;
}
const clientId = getClientId();

let lobbyCode = null;
let isHost = false;

    // Espejos iniciales para el otro script
window.lobbyCode = lobbyCode;
window.isHost = isHost;
    let prevIsHost = false;
    let playersConnected = 0;
    let currentConnRef = null;
    let lobbyRef = null;
    let lobbyCallback = null;
    let lastLobbyState = null;

    const $ = (id)=> document.getElementById(id);
    const statusEl = "lobbyStatus" in window ? window.lobbyStatus : document.getElementById('lobbyStatus');
    const badgeEl  = $("roomBadge");
    const overlayEl = $("lobbyOverlay");
    const leaveRow = $("leaveRow");
    const playersCard = $("playersCard");
    const playersList = $("playersList");
    const btnGrupos = $("btnGrupos");
    const clearBtn = $("btnClearOutput");
    const adminControls = $("adminControls");

    // ====== Overlay de Filtros ======
const filtersOverlay = $("filtersOverlay");
const btnFilters     = $("btnFilters");
const btnCloseFilters= $("btnCloseFilters");

// Guard para abrir solo si es admin en sala o cualquiera en modo local
function canControlWeights(){
  const inLobby = !!lobbyCode;
  return (!inLobby || isHost);
}

function openFilters(){
  if(!canControlWeights()){
    if(window.showToast) window.showToast('Solo el ADMIN puede abrir Filtros en sala');
    return;
  }
  if(filtersOverlay) filtersOverlay.classList.add('open');
  if(typeof window.initWeightSliders === 'function') window.initWeightSliders();
}

function closeFilters(){
  if(filtersOverlay) filtersOverlay.classList.remove('open');
}

// Botones abrir/cerrar
btnFilters?.addEventListener('click', openFilters);
btnCloseFilters?.addEventListener('click', closeFilters);

// Cerrar con ESC
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && filtersOverlay?.classList.contains('open')){
    closeFilters();
  }
});

// Cerrar al hacer click fuera de la tarjeta
filtersOverlay?.addEventListener('click', (e)=>{
  if(e.target === filtersOverlay) closeFilters();
});

    const choiceRow     = $("choiceRow");
    const joinRow       = $("joinRow");
    const btnChooseJoin = $("btnChooseJoin");
    const btnBackJoin   = $("btnBackJoin");

    const timerSelect   = $("timerSelect");
    const timerDisplay  = $("timerDisplay");
    let timerActive = false; // control local del estado del timer

    let timerInterval = null;
// Control interno de sonidos por sesi√≥n del timer
let lastBeepSecond = null;        // para no repetir el beep en el mismo segundo
let alarmPlayedForTimerId = null; // para no repetir alarma en esta sesi√≥n

    // ====== Enunciado Secreto ======
let lastSecretTs = null;

function showSecretOverlay(html, title='üïµÔ∏è Enunciado secreto'){
  const wrap = document.getElementById('secretOverlay');
  const cont = document.getElementById('secretContent');
  const titleEl = document.getElementById('secretTitle');
  if(!wrap || !cont) return;
  cont.innerHTML = html;
  if(titleEl) titleEl.textContent = title;
  wrap.style.display = 'flex';
}

function hideSecretOverlay(){
  const wrap = document.getElementById('secretOverlay');
  if(!wrap) return;
  wrap.style.display = 'none';
}

document.getElementById('btnSecretOK')?.addEventListener('click', async ()=>{
  hideSecretOverlay();
  // Marca ack en Firebase si estamos en lobby y hay secreto para este cliente
  try{
    if(lobbyCode){
      await update(ref(db, `lobbies/${lobbyCode}/secrets/${clientId}`), { ack: true });
    }
  }catch(e){}
});

    const LS_CODE_KEY = "am_lobby_code";

    function makeCode(){
      const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      return Array.from({length:5},()=> chars[Math.floor(Math.random()*chars.length)]).join("");
    }

    // ====== Colores por grupo ======
    const GROUP_PALETTE = ['#60a5fa','#f472b6','#34d399','#fbbf24','#a78bfa','#fb7185','#22d3ee','#f59e0b','#4ade80','#e879f9'];
    const hexToRgb = (hex)=>{ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:{r:100,g:100,b:100}; };
    const rgba = (hex, a)=>{ const {r,g,b}=hexToRgb(hex); return `rgba(${r}, ${g}, ${b}, ${a})`; };
    const groupColor = (letter)=>{
      if(!letter) return '#64748b';
      const idx = Math.max(0, letter.charCodeAt(0) - 65);
      return GROUP_PALETTE[idx % GROUP_PALETTE.length];
    };

    function setLobbyCode(code){
      lobbyCode = code;
      localStorage.setItem(LS_CODE_KEY, code);
      badgeEl.style.display='inline-block'; badgeEl.textContent = `Sala: ${code}`;
      leaveRow.style.display='flex';
      overlayEl.style.display='none';
      playersCard.style.display='block';
      window.lobbyCode = lobbyCode;
    }
    function clearLobbyCode(){
      lobbyCode = null;
      localStorage.removeItem(LS_CODE_KEY);
      badgeEl.style.display='none'; badgeEl.textContent = 'Sala: -----';
      leaveRow.style.display='none';
      overlayEl.style.display='flex';
      playersCard.style.display='none';
      lastLobbyState = null;
      window.lobbyCode = lobbyCode;
    }

    let joinMode = false;
function setJoinMode(on){
  joinMode = !!on;
  if (choiceRow) choiceRow.style.display = on ? "none" : "flex";
  if (joinRow)   joinRow.style.display   = on ? "flex" : "none";
  // reset de mensajes y c√≥digo
  if (!on) {
    const input = $("lobbyCodeInput");
    if (input) input.value = "";
    if (statusEl) statusEl.textContent = "";
  }
}

    /* Presencia por pesta√±a */
    function setupPresence(code){
      if (!code) return;

      if (currentConnRef) { try { onDisconnect(currentConnRef).cancel(); } catch(e){} currentConnRef = null; }

      const infoRef = ref(db, ".info/connected");
      onValue(infoRef, (snap)=>{
        if (snap.val() === true) {
          const connRef = push(ref(db, `lobbies/${code}/players/${clientId}/connections`));
          currentConnRef = connRef;
          set(connRef, true);
          onDisconnect(connRef).remove();
          update(ref(db, `lobbies/${code}/players/${clientId}`), { connected: true });
        }
      });
    }

   function updateHostUI(){
  const inLobby = !!lobbyCode;

  // Mostrar controles solo si NO hay lobby o si eres ADMIN
  if (adminControls) adminControls.style.display = (!inLobby || isHost) ? "" : "none";
  if (clearBtn)      clearBtn.style.display      = (!inLobby || isHost) ? "" : "none";
  if (btnGrupos)     btnGrupos.style.display     = (!inLobby || isHost) ? "" : "none";

  // Temporizador
  if (timerSelect) timerSelect.style.display = (!inLobby || isHost) ? "" : "none";

  if (timerDisplay) {
    // el reloj siempre visible
    timerDisplay.style.display = "";

    // qui√©n puede controlarlo: admin en lobby o si est√°s solo
    const canControlTimer = (!inLobby) ? false : (isHost || playersConnected <= 1);
    timerDisplay.tabIndex = canControlTimer ? 0 : -1;
    timerDisplay.style.opacity = canControlTimer ? '' : '0.6';
    timerDisplay.style.pointerEvents = canControlTimer ? '' : 'none';
  }

  // Habilitar/deshabilitar el <select> del tiempo (solo admin en lobby)
  if (timerSelect) {
    const disableSel = !(isHost && inLobby);
    timerSelect.disabled = disableSel;
    timerSelect.style.opacity = disableSel ? 0.5 : '';
  }

  // Botones de puntaje (+/-) solo si eres admin o est√°s solo
  const hostOrSolo = isHost || playersConnected <= 1;
  if (playersList) {
    playersList.querySelectorAll('.scoreBtn').forEach(b => b.disabled = !hostOrSolo);
  }
}

// === Plegado de opciones avanzadas (toggle) ===
const btnToggleAdv = $("btnToggleAdv");
const advRow = $("advRow");

// Estado persistente (solo para modo local o cuando seas admin)
function setAdvOpen(open){
  if(!advRow || !btnToggleAdv) return;
  advRow.style.display = open ? "" : "none";
  btnToggleAdv.setAttribute("aria-expanded", open ? "true" : "false");
  try{ localStorage.setItem("am_adv_open", open ? "1" : "0"); }catch(e){}
}

btnToggleAdv?.addEventListener("click", ()=>{
  const open = btnToggleAdv.getAttribute("aria-expanded") !== "true";
  setAdvOpen(open);
});

// Inicializa preferencia
(function initAdvPref(){
  const pref = (localStorage.getItem("am_adv_open") === "1");
  setAdvOpen(pref);
})();

// ‚ûï Integra con tu control de host para sala
const __origUpdateHostUI = updateHostUI;
updateHostUI = function(){
  __origUpdateHostUI();

  const inLobby = !!lobbyCode;

  // En sala: solo ADMIN ve el bot√≥n y la fila (plegable)
  if(btnToggleAdv){
    btnToggleAdv.style.display = (!inLobby || isHost) ? "" : "none";
  }
  if(advRow){
    if(inLobby && !isHost){
      advRow.style.display = "none";
    }else{
      const pref = (localStorage.getItem("am_adv_open") === "1");
      advRow.style.display = pref ? "" : "none";
    }
  }

  // (opcional) esto controlaba la antigua tarjeta catWeightsCard:
  const catCard = document.getElementById('catWeightsCard');
  const canControlWeights = (!inLobby || isHost);
  if (catCard) catCard.style.display = canControlWeights ? '' : 'none';

  // ‚¨áÔ∏è NUEVO: visibilidad del bot√≥n Filtros
  const btnFiltersEl = document.getElementById('btnFilters');
  if (btnFiltersEl) btnFiltersEl.style.display = (!inLobby || isHost) ? '' : 'none';

   // üîí Si el overlay de Filtros estaba abierto y perdiste permisos, ci√©rralo
const wasOpen = filtersOverlay?.classList.contains('open');
const stillCan = (!inLobby || isHost);
if (wasOpen && !stillCan) closeFilters();
};
updateHostUI(); // para aplicar el estado inicial fuera/antes del lobby
    
    const clampScore = (n)=> Math.max(0, Math.min(999, n|0));

    function getActiveGroupsFromState(state){
      const playersObj = state?.players || {};
      return [...new Set(
        Object.values(playersObj)
          .filter(p=>p && p.connections && Object.keys(p.connections).length>0)
          .map(p=> p.group ? String(p.group).toUpperCase() : null)
          .filter(Boolean)
      )].sort();
    }

    function renderPlayers(state){
      if(!playersCard || !playersList) return;

      const playersObj = state.players || {};
      const items = Object.entries(playersObj).map(([pid,p])=>{
        const connected = !!(p && p.connections && Object.keys(p.connections).length > 0);
        return {
          id: pid,
          name: (p && p.name) || "Jugador",
          score: clampScore((p && p.score)!=null ? p.score : 0),
          group: p && p.group ? String(p.group).toUpperCase() : null,
          connected,
          isAdmin: state.hostId === pid
        };
      });

      if(items.length === 0){
        playersList.innerHTML = `<span class="muted">Nadie conectado a√∫n‚Ä¶</span>`;
      }else{
        const escSafe = (s)=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        playersList.innerHTML = items.map(x=>{
          const col = groupColor(x.group);
          const bg = rgba(col, 0.22);
          const bd = rgba(col, 0.55);
          return `
          <div class="playerChip" data-id="${x.id}" title="${escSafe(x.name)}${x.isAdmin?' ‚Ä¢ ADMIN':''}" style="--gc:${col}">
            <span class="dot" aria-label="${x.connected ? 'online' : 'offline'}" style="${x.connected ? '' : 'background:#94a3b8'}"></span>
            <span class="groupBadge" style="background:${bg};border-color:${bd}">${x.group ? `Grupo ${escSafe(x.group)}` : '‚Äî'}</span>
            <span class="name">
              ${escSafe(x.name)}
              ${x.isAdmin ? `<span class="role">ADMIN</span>` : ``}
            </span>

            <div class="scoreBox">
              <button class="scoreBtn" data-action="dec" data-id="${x.id}">‚àí</button>
              <span class="score" data-id="${x.id}">${x.score}</span>
              <button class="scoreBtn" data-action="inc" data-id="${x.id}">+</button>
            </div>
          </div>
        `}).join("");
      }

      const hostOrSolo = isHost || playersConnected <= 1;
      playersList.querySelectorAll('.scoreBtn').forEach(b=> b.disabled = !hostOrSolo);

      playersCard.style.display = lobbyCode ? 'block' : 'none';
    }

   // ======== Temporizador por lobby (compartido) ========
function fmt(t){
  const m = Math.floor(t/60), s = t%60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function clearTimerInterval(){ if(timerInterval){ clearInterval(timerInterval); timerInterval=null; } }

async function startTimer(durationSec){
  if(!lobbyCode || !(isHost || playersConnected<=1)) return;
  const startTime = Date.now();
  await update(ref(db, `lobbies/${lobbyCode}`), {
    timer: { startedAt: startTime, durationSec, canceled:false }
  });
}
async function cancelTimer(){
  if(!lobbyCode || !(isHost || playersConnected<=1)) return;
  await update(ref(db, `lobbies/${lobbyCode}/timer`), { canceled:true });
}

function handleTimerState(timer){
  clearTimerInterval();

  // reset sonido por sesi√≥n
  lastBeepSecond = null;
  timerActive = false;

  // si no hay timer o est√° cancelado
  if(!timer || timer.canceled){
    if(timerDisplay){
      timerDisplay.textContent='Iniciar';
      timerDisplay.classList.remove('running','warning');
      timerDisplay.style.color='';
    }
    try{ sndBeep.pause();  sndBeep.currentTime  = 0; }catch(e){}
    try{ sndAlarm.pause(); sndAlarm.currentTime = 0; }catch(e){}
    return;
  }

  // ‚Üê √∫nica vez
  const { startedAt, durationSec } = timer;
  if(!startedAt || !durationSec) return;

  // id de esta sesi√≥n para tocar la alarma una sola vez
  alarmPlayedForTimerId = startedAt;

  function tick(){
    const elapsed = Math.floor((Date.now()-startedAt)/1000);
    const remain  = Math.max(0, durationSec - elapsed);

    if(timerDisplay){
      timerDisplay.textContent = fmt(remain); // usa la fmt global
      timerDisplay.classList.add('running');
      if(remain <= 10){ timerDisplay.classList.add('warning'); }
      else{ timerDisplay.classList.remove('warning'); }
    }

    timerActive = remain > 0 && !timer.canceled;

    // üéµ Sonidos
try {
  // Reproducir el audio de 10 s una sola vez cuando queden exactamente 10 s
  if (remain === 10 && lastBeepSecond !== 10) {
    stopBeep();
    sndBeep.currentTime = 0;
    sndBeep.play().catch(()=>{});
    lastBeepSecond = 10;
  }

  // Cortar el beep si se cancela o termina el tiempo
  if (remain === 0 || timer?.canceled) {
    stopBeep(); // Detiene el audio de los beeps si segu√≠a sonando
  }

  // Alarma al llegar a 0 (solo una vez)
  if (remain === 0 && alarmPlayedForTimerId === startedAt) {
    sndAlarm.currentTime = 0;
    sndAlarm.play().catch(()=>{});
    alarmPlayedForTimerId = null;
  }
} catch (e) {}

    if(remain<=0){
      clearTimerInterval();
      if(timerDisplay) timerDisplay.classList.remove('running','warning');
      if(window.showToast) window.showToast('‚è∞ ¬°Tiempo!');
    }
  }

  tick();
  timerInterval = setInterval(tick, 1000);
}

timerDisplay?.addEventListener('click', ()=>{
  const hostOrSolo = isHost || playersConnected <= 1;
  if(!(hostOrSolo) || !lobbyCode) return;
  if (timerActive) {
    cancelTimer();
  } else {
    const sec = parseInt(timerSelect?.value||'60',10);
    startTimer(sec);
  }
});

timerSelect?.addEventListener('change', ()=>{
  if(!(isHost||playersConnected<=1)||!lobbyCode) return;
  const val = parseInt(timerSelect.value,10);
  update(ref(db, `lobbies/${lobbyCode}/timer`), { durationSec: val, startedAt: Date.now(), canceled:false });
});

    // ======== Generaci√≥n por grupo (usa el √∫ltimo estado del lobby) ========
    function buildGroupedOutput(mode){
      const state = lastLobbyState;
      const groups = getActiveGroupsFromState(state);
      if(!groups || groups.length===0) return null;

      const gens = {
        PVAL: window.genPVAL, PV: window.genPV, PA: window.genPA, PL: window.genPL,
        PAL: window.genPAL, PVA: window.genPVA, PVL: window.genPVL,
        FUSION: window.genFusion, P: window.genP, EVENTO: window.genEvento, ESCENA: window.genEscena
      };
      const fn = gens[mode] || gens["PVAL"];

      const now = Date.now();
      const linesHtml = [];
      const linesText = [];

      for(const g of groups){
        const R = rng(`${lobbyCode}-${g}-${now}`);
        const { html, text } = fn(R);

        const col = groupColor(g);
        const bg = rgba(col, 0.22);
        const bd = rgba(col, 0.55);

        linesHtml.push(`<div class="lineGroup">
          <span class="gBadge" style="background:${bg};border-color:${bd}">Grupo ${g}</span>
          <span>${html}</span>
        </div>`);
        linesText.push(`Grupo ${g}: ${text}`);
      }

      return { html: linesHtml.join(""), text: linesText.join("\n") };
    }
// Genera aleatoriamente uno de: PV / PA / PL (para un solo enunciado) ‚Äî VIVE EN EL M√ìDULO
function genRandPVPAorPL(R){
  const modes = ['PV','PA','PL'];
  const mode  = modes[Math.floor(R()*modes.length)];
  const fns   = { PV: window.genPV, PA: window.genPA, PL: window.genPL };
  return fns[mode](R);
}

// Versi√≥n por grupo: a cada grupo le toca aleatoriamente PV/PA/PL ‚Äî VIVE EN EL M√ìDULO
function buildGroupedOutputDouble(){
  const state  = lastLobbyState;
  const groups = getActiveGroupsFromState(state);
  if(!groups || groups.length===0) return null;

  const now = Date.now();
  const linesHtml = [];
  const linesText = [];

  for(const g of groups){
    const R = rng(`${lobbyCode}-${g}-${now}`); // semilla por grupo
    const modes = ['PV','PA','PL'];
    const mode  = modes[Math.floor(R()*modes.length)];
    const fns   = { PV: window.genPV, PA: window.genPA, PL: window.genPL };
    const { html, text } = fns[mode](R);

    const col = groupColor(g);
    const bg  = rgba(col, 0.22);
    const bd  = rgba(col, 0.55);

    linesHtml.push(`
      <div class="lineGroup">
        <span class="gBadge" style="background:${bg};border-color:${bd}">Grupo ${g}</span>
        <span>${html}</span>
      </div>
    `.trim());
    linesText.push(`Grupo ${g}: ${text}`);
  }

  return { html: linesHtml.join(""), text: linesText.join("\n") };
}
// Genera aleatoriamente uno de: PVA / PAL / PVL (para un solo enunciado, en ese orden)
function genRandTriple(R){
  const modes = ['PVA','PAL','PVL'];
  const mode  = modes[Math.floor(R()*modes.length)];
  const fns   = { PVA: window.genPVA, PAL: window.genPAL, PVL: window.genPVL };
  return fns[mode](R);
}

// Versi√≥n por grupo: a cada grupo le toca aleatoriamente PVA / PAL / PVL
function buildGroupedOutputTriple(){
  const state  = lastLobbyState;
  const groups = getActiveGroupsFromState(state);
  if(!groups || groups.length===0) return null;

  const now = Date.now();
  const linesHtml = [];
  const linesText = [];

  for(const g of groups){
    const R = rng(`${lobbyCode}-${g}-${now}`); // semilla por grupo
    const modes = ['PVA','PAL','PVL'];
    const mode  = modes[Math.floor(R()*modes.length)];
    const fns   = { PVA: window.genPVA, PAL: window.genPAL, PVL: window.genPVL };
    const { html, text } = fns[mode](R);

    const col = groupColor(g);
    const bg  = rgba(col, 0.22);
    const bd  = rgba(col, 0.55);

    linesHtml.push(`
      <div class="lineGroup">
        <span class="gBadge" style="background:${bg};border-color:${bd}">Grupo ${g}</span>
        <span>${html}</span>
      </div>
    `.trim());
    linesText.push(`Grupo ${g}: ${text}`);
  }

  return { html: linesHtml.join(""), text: linesText.join("\n") };
}
/* ====== Desaf√≠os del "Reto" ====== */
const CHALLENGES = [
  "Arte Abstracto: Todos deben dibujar sin levantar el plum√≥n de la pizarra.",
  "Arte Manco: Todos deben dibujar con su mano opuesta.",
  "Arte Ciego: Todos deben dibujar con los ojos cerrados.",
  "Arte Geom√©trico: Todos deben dibujar usando solo l√≠neas rectas.",
  "Arte Veloz: Todos tienen 20 segundos para dibujar."
];

function pickChallenge(){
  const i = Math.floor(Math.random() * CHALLENGES.length);
  return CHALLENGES[i];
}

function setChallengeNote(html){
  const el = document.getElementById("challengeNote");
  if(el) el.innerHTML = html || "";
}
    // Limpia el reto (nota/desaf√≠o) local y en Firebase (si eres admin o est√°s solo)
async function clearChallengeForAll(){
  // Limpia la nota local
  setChallengeNote("");

  // Limpia la nota compartida en la sala
  if(lobbyCode){
    const hostOrSolo = isHost || playersConnected <= 1;
    if(hostOrSolo){
      try{
        await update(ref(db, `lobbies/${lobbyCode}`), { currentChallengeHtml: "" });
      }catch(e){
        console.warn('No se pudo limpiar el reto:', e);
      }
    }
  }
}
    /* + / ‚àí puntaje */
    playersList?.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.scoreBtn');
      if(!btn) return;

      const hostOrSolo = isHost || playersConnected <= 1;
      if(!hostOrSolo) return;

      const pid = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      if(!pid || !action || !lobbyCode) return;

      try{
        const scoreEl = playersList.querySelector(`.score[data-id="${pid}"]`);
        let current = 0;
        if(scoreEl){
          current = parseInt(scoreEl.textContent,10);
          if(Number.isNaN(current)) current = 0;
        }else{
          const snap = await get(ref(db, `lobbies/${lobbyCode}/players/${pid}/score`));
          current = clampScore(snap.val() ?? 0);
        }

        const delta = action === 'inc' ? 1 : -1;
        const next = clampScore(current + delta);
        if(next === current) return;

        await update(ref(db, `lobbies/${lobbyCode}/players/${pid}`), { score: next });
      }catch(err){
        console.warn('No se pudo actualizar el score:', err);
        if(window.showToast) window.showToast('No se pudo actualizar el puntaje');
      }
    });

    function watchLobby(code){
      if (lobbyRef && lobbyCallback){
        off(lobbyRef, 'value', lobbyCallback);
        lobbyRef = null; lobbyCallback = null;
      }
      lobbyRef = ref(db, `lobbies/${code}`);
      lobbyCallback = (snap)=>{
        const state = snap.val();
        if(!state) return;

        lastLobbyState = state;

        prevIsHost = isHost;
        isHost = state.hostId === clientId;
        window.isHost = isHost;

        playersConnected = 0;
        if (state.players) {
          playersConnected = Object.values(state.players)
            .filter(p => p && p.connections && Object.keys(p.connections).length > 0).length;
        }

        if (!prevIsHost && isHost && window.showToast) window.showToast("Ahora eres ADMIN");

        badgeEl.style.display='inline-block'; badgeEl.textContent = `Sala: ${code}`;
        leaveRow.style.display='flex';

        if (statusEl) statusEl.textContent = `Sala: ${code} ‚Ä¢ ${isHost ? "Eres ADMIN" : "Jugador"} ‚Ä¢ Conectados: ${playersConnected}`;
        // === Hidratar pesos desde Firebase (si existen)
if (state.weights && typeof state.weights === 'object') {
  WEIGHTS = { ...DEFAULT_WEIGHTS, ...state.weights };
  try { localStorage.setItem('am_weights', JSON.stringify(WEIGHTS)); } catch(e){}
  // Refresca sliders si est√°n presentes (el admin los ver√°; jugadores no)
  if (typeof initWeightSliders === 'function') initWeightSliders();
}

        const salidaEl = document.getElementById("salida");
if (salidaEl && ('currentOutputHtml' in state)) {
  salidaEl.innerHTML = state.currentOutputHtml || "";
  window.lastCopyText = state.currentOutputText || "";
}
// Nota/desaf√≠o compartido
if ('currentChallengeHtml' in state) {
  setChallengeNote(state.currentChallengeHtml || "");
}
        // Timer shared state
        handleTimerState(state.timer);
// ==== Secretos personales por jugador
const mySecret = state.secrets && state.secrets[clientId];
if(mySecret && typeof mySecret.ts === 'number'){
  if(lastSecretTs !== mySecret.ts){
    lastSecretTs = mySecret.ts;
    if(!mySecret.ack){
      showSecretOverlay(
        mySecret.html || '',
        mySecret.title || 'üïµÔ∏è Enunciado secreto'
      );
    }
  }
}
        
        renderPlayers(state);
        updateHostUI();
      };
      onValue(lobbyRef, lobbyCallback);
    }

    async function createLobby(name){
      const code = makeCode();
      const state = {
        hostId: clientId,
        currentOutputHtml: "",
        currentOutputText: "",
        currentChallengeHtml: "",
        weights: { ...WEIGHTS }, 
        players: { [clientId]: { name: name||"Host", score: 0, connected: true } },
        createdAt: Date.now()
      };
      await set(ref(db, `lobbies/${code}`), state);
      setLobbyCode(code);
      watchLobby(code);
      setupPresence(code);
    }

    async function joinLobby(code, name){
      code = (code||"").toUpperCase().trim();
      if(!code) return alert("Escribe un c√≥digo de sala");
      const player = { name: name||"Jugador", score: 0, connected: true };
      await update(ref(db, `lobbies/${code}/players/${clientId}`), player);
      setLobbyCode(code);
      watchLobby(code);
      setupPresence(code);
    }

    async function publishOutput(html, text){
      const hostOrSolo = isHost || playersConnected <= 1;
      if(!lobbyCode || !hostOrSolo) return;
      await update(ref(db, `lobbies/${lobbyCode}`), {
        currentOutputHtml: html,
        currentOutputText: text
      });
    }

    async function clearOutput(){
  const salidaEl = document.getElementById("salida");

  // Modo sala: solo el ADMIN (o si est√°s solo) puede limpiar para todos
  if(lobbyCode){
    const hostOrSolo = isHost || playersConnected <= 1;
    if(!hostOrSolo){
      if(window.showToast) window.showToast('Solo el ADMIN puede limpiar en sala');
      return;
    }
    try{
      await update(ref(db, `lobbies/${lobbyCode}`), {
        currentOutputHtml: "",
        currentOutputText: "",
        currentChallengeHtml: ""   // <-- limpiar tambi√©n la nota del reto
      });
      if(salidaEl) salidaEl.innerHTML = "";
      if(typeof window.lastCopyText !== "undefined") window.lastCopyText = "";
      setChallengeNote("");        // <-- borra la nota localmente
      if(window.showToast) window.showToast('Enunciado limpiado');
    }catch(e){
      console.warn('No se pudo limpiar el enunciado:', e);
      if(window.showToast) window.showToast('No se pudo limpiar');
    }
    return;
  }

  // Modo local (sin sala)
  if(salidaEl) salidaEl.innerHTML = "";
  if(typeof window.lastCopyText !== "undefined") window.lastCopyText = "";
  setChallengeNote("");            // <-- tambi√©n borra la nota en modo local
  if(window.showToast) window.showToast('Enunciado limpiado');
}

function getActivePlayerIdsFromState(state){
  const playersObj = state?.players || {};
  return Object.entries(playersObj)
    .filter(([,p]) => p && p.connections && Object.keys(p.connections).length > 0)
    .map(([pid]) => pid);
}

// Genera P+V+A+L SEMPRE en ese orden, con una semilla propia por jugador
function genSecretForPlayer(pid){
  const seed = `${lobbyCode||'local'}-${pid}-${Date.now()}`;
  const R = rng(seed);
  const { html, text } = genPVAL(R); // ya respeta orden Personaje + Verbo + Adjetivo + Lugar
  return { html, text };
}

// Host dispara secretos a todos los conectados
async function sendSecretsToAll(){
  if(!lobbyCode) return;
  const hostOrSolo = isHost || playersConnected <= 1;
  if(!hostOrSolo){
    if(window.showToast) window.showToast('Solo el ADMIN puede enviar secretos en sala');
    return;
  }
  const state = lastLobbyState;
  const pids = getActivePlayerIdsFromState(state);
  if(pids.length === 0) return;

  const ts = Date.now();
  const updates = {};
  for(const pid of pids){
    const { html, text } = genSecretForPlayer(pid);
    updates[`lobbies/${lobbyCode}/secrets/${pid}`] = {
  html, text, ts, ack:false,
  title: 'üïµÔ∏è Enunciado secreto'
};
  }
  await update(ref(db), updates);
  if(window.showToast) window.showToast(`Se enviaron ${pids.length} secretos`);
}

// Solo para modo sin lobby: muestra uno al dispositivo actual
function sendLocalSecret(){
  const { html } = genPVAL(rng());
  showSecretOverlay(html, 'üïµÔ∏è Enunciado secreto');
}
// Genera un √∫nico P+V+A+L para toda la sala (misma semilla para todos)
function genSharedSecret(){
  const seed = `${lobbyCode||'local'}-MASTERPIECE-${Date.now()}`;
  const R = rng(seed);
  const { html, text } = genPVAL(R);
  return { html, text };
}

// Host: env√≠a el MISMO secreto a todos los conectados
async function sendMasterpieceToAll(){
  if(!lobbyCode) return;
  const hostOrSolo = isHost || playersConnected <= 1;
  if(!hostOrSolo){
    if(window.showToast) window.showToast('Solo el ADMIN puede enviar secretos en sala');
    return;
  }
  const state = lastLobbyState;
  const pids = getActivePlayerIdsFromState(state);
  if(pids.length === 0) return;

  const ts = Date.now();
  const shared = genSharedSecret(); // <- √∫nico enunciado para todos
  const updates = {};
  for(const pid of pids){
  updates[`lobbies/${lobbyCode}/secrets/${pid}`] = {
    html: shared.html,
    text: shared.text,
    ts,
    ack: false,
    title: 'üé® Dibuja tu Obra Maestra con este enunciado'
  };
}
  await update(ref(db), updates);
  if(window.showToast) window.showToast(`OBRA MAESTRA enviada a ${pids.length} jugadores`);
}

// Modo local: muestra uno en el dispositivo actual
function sendLocalMasterpiece(){
  const { html } = genPVAL(rng());
  showSecretOverlay(html, 'üé® Dibuja tu Obra Maestra con este enunciado');
}

    async function generarGrupos(){
      if (!lobbyCode) return;
      const hostOrSolo = isHost || playersConnected <= 1;
      if (!hostOrSolo) return;

      const snap = await get(ref(db, `lobbies/${lobbyCode}/players`));
      const playersObj = snap.val() || {};

      const activos = Object.entries(playersObj)
        .filter(([,p]) => p && p.name && p.connections && Object.keys(p.connections).length > 0)
        .map(([pid,p]) => ({ pid, name: p.name }));

      if (activos.length < 2 || activos.length % 2 !== 0) {
        alert("Agrega o quita un jugador para formar grupos parejos");
        return;
      }

      for (let i = activos.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [activos[i], activos[j]] = [activos[j], activos[i]];
      }

      const letras = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
const updates = {};
for (let i = 0; i < activos.length; i += 2) {
  const groupIndex = Math.floor(i / 2);
  const letter = letras[groupIndex] || letras[letras.length - 1]; // usa Z si se pasa
  const a = activos[i], b = activos[i+1];
  updates[`lobbies/${lobbyCode}/players/${a.pid}/group`] = letter;
  updates[`lobbies/${lobbyCode}/players/${b.pid}/group`] = letter;
}

      await update(ref(db), updates);
    }

    // ====== Botones de generaci√≥n ======
    const MAP = {
  btnPVAL:'PVAL', btnPV:'PV', btnPA:'PA', btnPL:'PL',
  btnPVA:'PVA', btnPAL:'PAL', btnPVL:'PVL',
  btnFusion:'FUSION', btnP:'P', btnEvento:'EVENTO', btnEscena:'ESCENA',
  btnDoble:'DOBLE', btnTriple:'TRIPLE',
  btnSecreto:'SECRETO', btnMasterpiece:'MASTERPIECE',
  btnReto: 'RETO',
  
};

    function genOne(mode){
      const R = (window.rng ? window.rng() : Math.random);
      const gens = {
        PVAL: window.genPVAL, PV: window.genPV, PA: window.genPA, PL: window.genPL,
        PAL: window.genPAL, PVA: window.genPVA, PVL: window.genPVL,
        FUSION: window.genFusion, P: window.genP, EVENTO: window.genEvento, ESCENA: window.genEscena
      };
      const fn = gens[mode] || gens["PVAL"];
      return fn(R);
    }

    async function handleGenerate(mode){
  // Si NO es RETO, borra cualquier reto anterior
  if(mode !== 'RETO'){
    await clearChallengeForAll();
  }
  // Nuevo modo: DOBLE (por grupo PV/PA/PL aleatorio)
  if(mode === 'DOBLE'){
    if(lobbyCode){
      const hostOrSolo = isHost || playersConnected <= 1;
      if(!hostOrSolo) return;

      const grouped = buildGroupedOutputDouble();
      if(grouped){
        publishOutput(grouped.html, grouped.text);
      }else{
        // Sin grupos activos: un enunciado aleatorio PV/PA/PL
        const R = rng();
        const { html, text } = genRandPVPAorPL(R);
        publishOutput(html, text || '');
      }
    }else{
      const grouped = buildGroupedOutputDouble();
      if(grouped){
        document.getElementById("salida").innerHTML = grouped.html;
        window.lastCopyText = grouped.text;
      }else{
        const R = rng();
        const { html, text } = genRandPVPAorPL(R);
        document.getElementById("salida").innerHTML = html;
        window.lastCopyText = text;
      }
    }
    return; // Importante: no sigas con el flujo est√°ndar
  }
// Nuevo modo: TRIPLE (por grupo PVA/PAL/PVL aleatorio)
if(mode === 'TRIPLE'){
  if(lobbyCode){
    const hostOrSolo = isHost || playersConnected <= 1;
    if(!hostOrSolo){
      if(window.showToast) window.showToast('Solo el ADMIN puede generar enunciados en sala');
      return;
    }

    const grouped = buildGroupedOutputTriple();
    if(grouped){
      publishOutput(grouped.html, grouped.text);
    }else{
      // Sin grupos activos: un enunciado aleatorio PVA/PAL/PVL
      const R = rng();
      const { html, text } = genRandTriple(R);
      publishOutput(html, text || '');
    }
  }else{
    const grouped = buildGroupedOutputTriple();
    if(grouped){
      document.getElementById("salida").innerHTML = grouped.html;
      window.lastCopyText = grouped.text;
    }else{
      const R = rng();
      const { html, text } = genRandTriple(R);
      document.getElementById("salida").innerHTML = html;
      window.lastCopyText = text;
    }
  }
  return; // Importante
}
      // Nuevo modo: RETO (igual que TRIPLE pero mostrando una nota)
if(mode === 'RETO'){
  let html, text;

  if(lobbyCode){
    const hostOrSolo = isHost || playersConnected <= 1;
    if(!hostOrSolo){
      if(window.showToast) window.showToast('Solo el ADMIN puede generar enunciados en sala');
      return;
    }
    const grouped = buildGroupedOutputTriple();
    if(grouped){ html = grouped.html; text = grouped.text; }
    else{
      const R = rng();
      const res = genRandTriple(R);
      html = res.html; text = res.text || '';
    }
    // Publica el enunciado
    publishOutput(html, text || '');
  }else{
    const grouped = buildGroupedOutputTriple();
    if(grouped){
      document.getElementById("salida").innerHTML = grouped.html;
      window.lastCopyText = grouped.text;
    }else{
      const R = rng();
      const res = genRandTriple(R);
      document.getElementById("salida").innerHTML = res.html;
      window.lastCopyText = res.text || '';
    }
  }

  // üëâ publicar/mostrar el desaf√≠o
  const note = pickChallenge();
  const noteHtml = `üìù <strong>RETO:</strong> ${note}`;
  if(lobbyCode){
    await update(ref(db, `lobbies/${lobbyCode}`), { currentChallengeHtml: noteHtml });
  }
  setChallengeNote(noteHtml);
  return;
}

// Nuevo modo: SECRETO (overlay P+V+A+L a cada jugador)
if(mode === 'SECRETO'){
  if(lobbyCode){
    sendSecretsToAll();
  }else{
    sendLocalSecret();
  }
  return;
}
      // Nuevo modo: OBRA MAESTRA (un mismo P+V+A+L para todos)
if(mode === 'MASTERPIECE'){
  if(lobbyCode){
    sendMasterpieceToAll();
  }else{
    sendLocalMasterpiece();
  }
  return;
}

  // Flujo est√°ndar (lo que ya ten√≠as)
  if(lobbyCode){
    const hostOrSolo = isHost || playersConnected <= 1;
    if(!hostOrSolo) return;

    const grouped = buildGroupedOutput(mode);
    if (grouped){
      publishOutput(grouped.html, grouped.text);
    }else{
      const { html, text } = genOne(mode);
      publishOutput(html, text || '');
    }
  }else{
    const grouped = buildGroupedOutput(mode);
    if (grouped){
      document.getElementById("salida").innerHTML = grouped.html;
    }else{
      const { html } = genOne(mode);
      document.getElementById("salida").innerHTML = html;
    }
  }
}

    Object.entries(MAP).forEach(([id,mode])=>{
      const btn = $(id);
      if(btn){ btn.onclick = ()=> handleGenerate(mode); }
    });

    // Bot√≥n de grupos en la tarjeta de jugadores
    btnGrupos?.addEventListener('click', generarGrupos);
    document.getElementById('btnClearOutput')?.addEventListener('click', clearOutput);

    // Atajos de teclado (bloquea si no eres host en lobby)
    document.addEventListener('keydown', (e)=>{
      if ((e.metaKey || e.ctrlKey) && ['1','2','3','4','5','6'].includes(e.key)) {
        if (lobbyCode){
          const hostOrSolo = isHost || playersConnected <= 1;
          if (!hostOrSolo) { e.preventDefault(); e.stopPropagation(); }
        }
      }
    }, true);

    // Deshabilitar timer si no hay lobby
if(!lobbyCode){
  if(timerSelect){
    timerSelect.disabled = true;
    timerSelect.style.opacity = 0.5;
  }
  if(timerDisplay){
    timerDisplay.style.pointerEvents = 'none';
    timerDisplay.style.opacity = 0.6;
  }
}

    // ====== Init ======
    (function initLobbyOnce(){
      const saved = localStorage.getItem(LS_CODE_KEY);
      if(saved){
        overlayEl.style.display = 'none';
        badgeEl.style.display='inline-block'; badgeEl.textContent = `Sala: ${saved}`;
        leaveRow.style.display='flex';
        lobbyCode = saved;
        playersCard.style.display='block';
        watchLobby(saved);
        setupPresence(saved);
      }else{
        overlayEl.style.display = 'flex';
        playersCard.style.display='none';
        setJoinMode(false); // üëà arranca mostrando Crear/Unirse
      }
    })();

    // Salir
    async function leaveLobby(){
      if (!lobbyCode) return;
      const code = lobbyCode;

      try{
        if (isHost) {
          const playersSnap = await get(ref(db, `lobbies/${code}/players`));
          const playersObj = playersSnap.val() || {};
          const candidatos = Object.entries(playersObj)
            .filter(([pid, p]) => pid !== clientId && p && p.connections && Object.keys(p.connections).length > 0)
            .map(([pid]) => pid);
          if (candidatos.length > 0) {
            const nuevoHostId = candidatos[0];
            await update(ref(db, `lobbies/${code}`), { hostId: nuevoHostId });
          } else {
            try { await remove(ref(db, `lobbies/${code}`)); } catch(e){}
          }
        }

        if (lobbyRef && lobbyCallback){
          off(lobbyRef, 'value', lobbyCallback);
          lobbyRef = null; lobbyCallback = null;
        }

        if (currentConnRef){
          try{ onDisconnect(currentConnRef).cancel(); }catch(e){}
          try{ await remove(currentConnRef); }catch(e){}
          currentConnRef = null;
        }

        try{ await remove(ref(db, `lobbies/${code}/players/${clientId}`)); }catch(e){}
      }catch(e){
        console.warn('Error al salir de la sala:', e);
      }

      lobbyCode = null;
      lastLobbyState = null;
      badgeEl.style.display='none'; badgeEl.textContent = 'Sala: -----';
      leaveRow.style.display='none';
      overlayEl.style.display='flex';
      playersCard.style.display='none';
      const s = document.getElementById("salida"); if (s) s.innerHTML = "";
      if (statusEl) statusEl.textContent = "";
      if (playersList) playersList.innerHTML = "";
      isHost = false; prevIsHost = false; playersConnected = 0;
      updateHostUI();
    }

    document.getElementById("btnLeave")?.addEventListener("click", (e)=>{
  e.preventDefault();
  openConfirmExit();
});

// === Confirmaci√≥n de salida ===
const confirmExitOverlay = document.getElementById('confirmExitOverlay');
const btnExitYes = document.getElementById('btnConfirmExitYes');
const btnExitNo  = document.getElementById('btnConfirmExitNo');

function openConfirmExit(){
  if(!confirmExitOverlay) return;
  confirmExitOverlay.classList.add('open');
  btnExitYes?.focus();
}

function closeConfirmExit(){
  if(!confirmExitOverlay) return;
  confirmExitOverlay.classList.remove('open');
}

// Cerrar al hacer clic fuera de la tarjeta
confirmExitOverlay?.addEventListener('click', (e)=>{
  if(e.target === confirmExitOverlay){
    closeConfirmExit();
  }
});

// Cerrar con la tecla ESC
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && confirmExitOverlay?.classList.contains('open')){
    closeConfirmExit();
  }
});

// Botones S√≠ / No
btnExitYes?.addEventListener('click', async ()=>{
  await leaveLobby(); // ejecuta tu funci√≥n existente
  closeConfirmExit();
});

btnExitNo?.addEventListener('click', ()=>{
  closeConfirmExit();
});
    window.showToast = (msg)=>{ const el=document.getElementById('toast'); if(!el) return; el.textContent=msg; el.classList.add('show'); clearTimeout(window.__tT); window.__tT=setTimeout(()=>el.classList.remove('show'),2200); };

// Overlay actions (flujo por pasos)
$("btnCreateLobby")?.addEventListener("click", ()=>{
  const name = $("playerName")?.value?.trim() || "";
  const err = $("nameError");
  const errLen = $("nameLengthError");

  // Validaci√≥n 1: vac√≠o
  if (!name.length) {
    if (err) err.style.display = "block";
    if (errLen) errLen.style.display = "none";
    return;
  }
  // Validaci√≥n 2: m√°s de 12 caracteres
  if (name.length > 10) {
    if (err) err.style.display = "none";
    if (errLen) errLen.style.display = "block";
    return;
  }

  // OK
  if (err) err.style.display = "none";
  if (errLen) errLen.style.display = "none";
  createLobby(name);
});

btnChooseJoin?.addEventListener("click", ()=>{
  setJoinMode(true);
  $("lobbyCodeInput")?.focus();
});

btnBackJoin?.addEventListener("click", ()=>{
  setJoinMode(false);
});

$("btnJoinLobby")?.addEventListener("click", ()=>{
  const name = $("playerName")?.value?.trim() || "";
  const code = ($("lobbyCodeInput")?.value || "").toUpperCase().trim();
  const err = $("nameError");
  const errLen = $("nameLengthError");
  const errCode = $("codeError");

  // Validaci√≥n 1: vac√≠o
  if (!name.length) {
    if (err) err.style.display = "block";
    if (errLen) errLen.style.display = "none";
    if (errCode) errCode.style.display = "none";
    return;
  }
  // Validaci√≥n 2: m√°s de 10 caracteres
  if (name.length > 10) {
    if (err) err.style.display = "none";
    if (errLen) errLen.style.display = "block";
    if (errCode) errCode.style.display = "none";
    return;
  }

  // OK
  if (err) err.style.display = "none";
  if (errLen) errLen.style.display = "none";

  // Validaci√≥n del c√≥digo
  if(!code){
    if (errCode) errCode.style.display = "block";
    return;
  }

  if (errCode) errCode.style.display = "none";
  joinLobby(code, name);
});

    $("playerName")?.addEventListener("input", ()=>{
  const val = $("playerName")?.value?.trim() || "";
  const err = $("nameError");
  const errLen = $("nameLengthError");

  if (val.length && err) err.style.display = "none";
  if (val.length <= 12 && errLen) errLen.style.display = "none";
});
  </script>
<script>
(function(){
  const btnAdv     = document.getElementById('btnToggleAdv');
  const btnFilters = document.getElementById('btnFilters');
  if(!btnAdv || !btnFilters) return;

  // El contenedor original donde viven hoy
  // (es el primer .inline dentro de #adminControls con todos los botones principales)
  const originalRow = document.querySelector('#adminControls .inline');
  if(!originalRow) return;

  // Creamos un contenedor en el header (una sola vez)
  const appbar = document.querySelector('header .appbar');
  if(!appbar) return;

  let headerActions = document.getElementById('headerActions');
  if(!headerActions){
    headerActions = document.createElement('div');
    headerActions.id = 'headerActions';
    headerActions.className = 'header-actions';

    // Lo insertamos antes del badge de sala, para que quede a la derecha
    const roomBadge = document.getElementById('roomBadge');
    if(roomBadge){
      appbar.insertBefore(headerActions, roomBadge);
    }else{
      // fallback: al final de la appbar
      appbar.appendChild(headerActions);
    }
  }

  // Guardamos orden para reinsertar en m√≥vil
  const mobileAnchor = document.createComment('mobile-anchor-btns');
  originalRow.appendChild(mobileAnchor);

  const mq = window.matchMedia('(min-width: 1024px)');

  function placeButtons(e){
    const isDesktop = e ? e.matches : mq.matches;

    if(isDesktop){
      // Mover al header
      if(btnAdv.parentElement !== headerActions){
        headerActions.appendChild(btnAdv);
        headerActions.appendChild(btnFilters);
      }
    }else{
      // Devolver a su fila original (despu√©s del anchor)
      if(btnAdv.parentElement !== originalRow){
        originalRow.insertBefore(btnAdv, mobileAnchor.nextSibling);
        originalRow.insertBefore(btnFilters, btnAdv.nextSibling);
      }
    }
  }

  // Ejecuta ahora y en cambios de tama√±o
  placeButtons();
  mq.addEventListener('change', placeButtons);

  // Si tu l√≥gica de permisos cambia display (updateHostUI), recolocamos igual
  // sin romper nada visual.
  const ro = new ResizeObserver(()=> placeButtons());
  ro.observe(document.body);
})();
</script>

</body>
</html>
