<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>ARTE MODERNO - Generador de Enunciados by ¬© 2025 Tabja Games</title>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{
      --bg:#0b1020;--panel:#111a2b;--muted:#99a3b4;--text:#e7eefc;
      --accent:#0ea5e9;--accent2:#22c55e;
      --verb:#ff4d4d; /* rojo */
      --adj:#7CFC00;  /* verde */
      --place:#ffe066;/* amarillo */
      --event:#b266ff; /* morado eventos */
      --scene:#ffb347; /* naranja escenas */
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
      color:var(--text);
      background:linear-gradient(180deg,#0b1020,#0b1428) fixed;
    }
    header{
      position:sticky;top:0;
      background:rgba(9,13,26,.7);backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,.05);z-index:10
    }
    .container{max-width:820px;margin:0 auto;padding:16px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:16px;
      padding:16px;box-shadow:0 6px 30px rgba(0,0,0,.25)
    }
    .title{font-size:20px;font-weight:700;display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted)}
    .btn{
      appearance:none;border:0;border-radius:12px;padding:12px 14px;
      font-weight:700;color:var(--text);background:transparent;
      border:1px solid rgba(255,255,255,.12);cursor:pointer;
      transition:background .15s,color .15s;
      font-size:14px; /* tama√±o m√°s compacto */
    }
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn:active{transform:translateY(1px)}
    .inline{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input{
      width:100%;background:#0f182a;color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;
      font-size:15px; /* evita zoom en iPhone sin verse grande */
    }
    .out{
      font-size:22px;line-height:1.45;background:#0b1426;border-radius:14px;
      padding:14px;border:1px dashed rgba(255,255,255,.15)
    }
    footer{
      opacity:.7;padding:24px 12px;text-align:center;font-size:12px;
      position:relative
    }
    .kbd{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:12px;border:1px solid rgba(255,255,255,.2);
      padding:2px 6px;border-radius:6px;background:#0e1628
    }
    .tag{
      display:inline-block;
      padding:.25rem .6rem;
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      margin:0.25rem;
      font-size:13px;
      color:var(--muted);
    }
    /* Colores por tipo de palabra (solo en Salida) */
    .char{ color:#4cc9f0; }   /* azul claro */
    .verb{ color:var(--verb); }
    .adj{ color:var(--adj); }
    .place{ color:var(--place); }
    .event{ color:var(--event); }
    .scene{ color:var(--scene); }

    #footerBtns{
      position:absolute;right:12px;bottom:8px;
      opacity:0;transition:opacity .3s;display:flex;gap:6px;
    }
    footer:hover #footerBtns{opacity:0.5;}
    #footerBtns .btn{
      font-size:10px;padding:4px 8px;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.05);
    }

    /* Letras coloreadas en los botones combinados */
    .btn span { font-weight: bold; }
    .letter-p { color: #4cc9f0; }   /* azul personajes */
    .letter-v { color: #ff4d4d; }   /* rojo verbos */
    .letter-a { color: #7CFC00; }   /* verde adjetivos */
    .letter-l { color: #ffe066; }   /* amarillo lugares */
  </style>
</head>
<body>
  <header>
    <div class="container inline" style="justify-content:space-between">
      <div class="title">üé® ARTE MODERNO - Generador de Enunciados <span class="muted">by ¬© 2025 Tabja Games</span></div>
      <div class="inline">
        <label class="muted" for="seed">Semilla</label>
        <input id="seed" placeholder="opcional" style="max-width:140px" />
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:18px">

    <!-- üîπ BLOQUE DE LOBBY -->
    <section class="card" style="margin-bottom:14px">
      <div class="inline" style="align-items:flex-end; gap:10px; flex-wrap:wrap">
        <div>
          <label class="muted" for="playerName">Tu nombre</label><br>
          <input id="playerName" placeholder="Ej: Tabja" style="max-width:160px">
        </div>
        <div>
          <label class="muted" for="lobbyCodeInput">C√≥digo de sala</label><br>
          <input id="lobbyCodeInput" placeholder="ABCD" style="max-width:120px;text-transform:uppercase">
        </div>
        <button class="btn" id="btnCreateLobby">Crear sala</button>
        <button class="btn" id="btnJoinLobby">Unirse</button>
        <div class="muted" id="lobbyStatus" style="min-width:200px"></div>
      </div>
    </section>
    <!-- üîπ FIN BLOQUE DE LOBBY -->

    <section class="card">
      <div style="display:grid;gap:10px">
        <!-- Fila 1: P, FUSI√ìN, EVENTOS, ESCENAS -->
        <div class="inline">
          <button class="btn" id="btnP">PERSONAJE</button>
          <button class="btn" id="btnFusion">FUSI√ìN</button>
          <button class="btn" id="btnEvento">EVENTOS</button>
          <button class="btn" id="btnEscena">ESCENAS</button>
        </div>
        <!-- Fila 2: combinaciones P+ -->
        <div class="inline">
          <button class="btn" id="btnPV">
            <span class="letter-p">P</span> + <span class="letter-v">V</span>
          </button>
          <button class="btn" id="btnPA">
            <span class="letter-p">P</span> + <span class="letter-a">A</span>
          </button>
          <button class="btn" id="btnPL">
            <span class="letter-p">P</span> + <span class="letter-l">L</span>
          </button>
          <button class="btn" id="btnPVA">
            <span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-a">A</span>
          </button>
          <button class="btn" id="btnPAL">
            <span class="letter-p">P</span> + <span class="letter-a">A</span> + <span class="letter-l">L</span>
          </button>
          <button class="btn" id="btnPVL">
            <span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-l">L</span>
          </button>
          <button class="btn" id="btnPVAL">
            <span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-a">A</span> + <span class="letter-l">L</span>
          </button>
        </div>
        <!-- Fila 3 -->
        <div class="inline">
          <button class="btn" id="btnGenerar5">Generar 5</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="title">Salida</div>
      <div id="salida" class="out" style="margin-top:10px;white-space:pre-wrap"></div>
      <div id="historial" style="margin-top:10px"></div>
      <div id="testlog" class="muted" style="margin-top:10px"></div>
    </section>
  </main>

  <footer>
    Hecho para m√≥vil y desktop.  
    Atajos: <span class="kbd">Ctrl/Cmd + 1..6</span>
    <div id="footerBtns">
      <button class="btn" id="btnCopiar">Copiar</button>
      <button class="btn" id="btnTest">Test</button>
    </div>
  </footer>

  <script>
    const PERSONAJES=['Goku','Vegeta','Piccolo','Freezer','Monkey D. Luffy','Roronoa Zoro','Sanji','Nami','Naruto Uzumaki','Sasuke Uchiha','Kakashi Hatake','Ichigo Kurusaki','Satoru Gojo','Eren Yeager','Levi Ackerman','Shigeo Kageyama','Saitama','Edward Elric','Tanjiro Kamado','Nezuko Kamado','Kenshin Himura','Joseph Joestar','Guts','Ash Ketchum','Yugi Muto','Bob Esponja','Patricio Estrella','Calamardo','Arnold Shortman','Aang','Timmy Turner','Jimmy Neutron','Johnny Bravo','Mojo Jojo','Perry El Ornitorrinco','Optimus Prime','Mickey Mouse','Bugs Bunny','El Pato Donald','Felix El Gato','Winnie-the-Pooh','Charlie Brown','Snoopy','Hello Kitty','Dora La Exploradora','Peppa Pig','Homero Simpson','Rick Sanchez','Morty Smith','Eric Cartman','Buzz Lightyear','Mike Wazowski','Shrek','Wall-E','Stitch','Nemo','Elsa','Simba','Luke Skywalker','Darth Vader','Yoda','E.T.','John Wick','Neo','Indiana Jones','El Terminator','Jack Sparrow','Borat','Charlie Chaplin','Jason Voorhees','Chucky','Freddy Krueger','Jigsaw','Pennywise','Edward Scissorhands','Jack Skellington','Godzilla','El Xenomorfo','Superman','Spider-Man','Batman','Wolverine','Hulk','Venom','Thor','El Joker','Albert Einstein','Leo Messi','Napole√≥n Bonaparte','Atahualpa','Hitler','Michael Jackson','Freddie Mercury','Beethoven','Pedro Castillo','Donald Trump','Gandalf','Frodo Baggins','Gollum','Harry Potter','Voldemort','Willy Wonka','Cenicienta','Rapunzel','Aladino','Dracula','Frankenstein','Wednesday Addams','El Jorobado de Notre Dame','James Bond','Don Quijote de la Mancha','El Gato con Botas','Robin Hood','Pinnochio','Tarz√°n','Tralalero Tralal√°','Brr Brr Patap√≠m','Chimpanzini Bananini','Tung Tung Tung Sahur','Bombardino Crocodilo','La Vaca Saturno Saturnita','Clippy','El Chavo del Ocho','Jon Snow','Walter White','La Rana Ren√©','Pikachu','Mario','Bowser','Yoshi','Donkey Kong','Kirby','Link','Zelda','Samus Aran','Sonic','Crash Bandicoot','Mega Man','Pac-Man','Leon S. Kennedy','Lara Croft','El Amongus','Santa Claus','Dios','Atlas','Zeus','Poseid√≥n','H√©rcules','Pegaso','El Kraken','El C√≠clope','El Minotauro','El Cerbero','El F√©nix','El Leviat√°n','El Fenrir','La Medusa','La Muerte','El Yeti','El Chupacabras','Un √Ångel','Un Demonio','Un Centauro','Un G√≥lem','Un Basilisco','Un Grifo','Un Ogro','Una Sirena','Una Arp√≠a','Una Hidra','Una Quimera','Un Lic√°ntropo','Un Unicornio','Una Bruja','Un Drag√≥n','Una Valquiria','Un Elfo','Un Gnomo','Un Duende','Un Hada','Un Fantasma','Un Vampiro','Un Zombie','Una Momia','Un Esqueleto','Un Mago'];
    const VERBOS=['leyendo','patinando','esquiando','surfeando','navegando','cabalgando','pedaleando','nadando','bailando','pescando','regando','componiendo','escribiendo','cocinando','conduciendo','cenando','trabajando','jugando','barriendo','corriendo','caminando','saltando','trepando','luchando','descansando','durmiendo','marchando','volando','bebiendo','fumando','vomitando','masturbando','orinando','cagando','copulando','muriendo','naciendo','pariendo','gritando','llorando','cantando','pensando','rezando','vendiendo','saludando','boxeando'];
    const ADJETIVOS=['content@','enojad@','asustad@','preocupad@','desnud@','cansad@','confundid@','excitad@','aburrid@','sorprendid@','doblad@','sentad@','parad@','arrodillad@','echad@','suspendid@','tembland@','derretid@','herid@','atad@','enamorad@','relajad@','borrach@','nervios@','enferm@','descalz@','tens@'];
    const LUGARES=['bajo el agua','bajo el sol','bajo la luna','bajo la lluvia','bajo la tierra','bajo las estrellas','bajo un √°rbol','bajo un puente','sobre un tren','sobre una torre','sobre una cama','sobre una mesa','sobre un techo','sobre las nubes','tras los arbustos','tras una roca','tras la ventana','tras las rejas','en el campo','en el mar','en el espacio','en el futuro','en el pasado','en el infierno','en el cielo','en la ciudad','en la monta√±a','en la playa','en la selva','en el Valhalla','en el Olimpo','en la corte','en el fin del mundo','en la prehistoria','en un ba√±o','en un bosque','en un colegio','en un desierto','en un gimnasio','en un zool√≥gico','en un pantano','en una tormenta','en una oficina','en un bar','en un hospital','en un cementerio','en un parque','en un balc√≥n','en una granja','en un teatro','en una biblioteca','en un cine','en un avi√≥n','en un helic√≥ptero','en un cohete','en un castillo','en un mercado','en una pradera','en un globo','en un burdel','en un laboratorio','en una prisi√≥n','en un jard√≠n','en Egipto','en Francia','en Jap√≥n','en Per√∫','en Australia','en la Ant√°rtida'];
    const EVENTOS=['El nacimiento de','La muerte de','La creaci√≥n de','La destrucci√≥n de','La victoria de','La derrota de','El sacrificio de','La furia de','La ca√≠da de','El sue√±o de','El regreso de','La invasi√≥n de','El ritual de','La persecuci√≥n de','La evoluci√≥n de','Los ojos de','El beso de','El rapto de','La danza de','La casa de','La habitaci√≥n de','El ba√±o de','Retrato de','La venganza de','La tortura de','El castigo de','La traici√≥n de','La ejecuci√≥n de','El asesinato de','La rebeli√≥n de','El entierro de','La confesi√≥n de','El cumplea√±os de','El concierto de','El bautizo de','El Baby Shower de','La aventura de'];
    const ESCENAS=['Guerra','Paz','Caos','Orden','Odio','Amor','Soledad','Invierno','Verano','Oto√±o','Primavera','Amanecer','Atardecer','Anochecer','Terror','Incendio','Duelo','Batalla','Matrimonio','Despedida','Bienvenida','Encuentro','Apocalipsis','Tragedia','Desastre','Cat√°strofe','Exterminio','Masacre','Tratado','Barbacoa','Picnic','Banquete','Fiesta','Excursi√≥n','Olimpiadas','Carnaval','Desfile','Venganza','Tortura','Castigo','Traici√≥n','Ejecuci√≥n','Asesinato','Revoluci√≥n','Funeral','Confesi√≥n','Cumplea√±os','Concierto','Bautizo','Baby Shower','Aventura'];

    const byId=id=>document.getElementById(id);
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
    function rng(seed){if(!seed)return Math.random;let n=0;for(let i=0;i<seed.length;i++)n=(n*31+seed.charCodeAt(i))>>>0;return mulberry32(n)}
    const pick=(arr,R)=>arr[Math.floor(R()*arr.length)];
    const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const wrapChar=name=>`<span class="char">${esc(name)}</span>`;
    const wrapVerb=v=>`<span class="verb">${esc(v)}</span>`;
    const wrapAdj=a=>`<span class="adj">${esc(a)}</span>`;
    const wrapPlace=l=>`<span class="place">${esc(l)}</span>`;
    const wrapEvent=e=>`<span class="event">${esc(e)}</span>`;
    const wrapScene=s=>`<span class="scene">${esc(s)}</span>`;

    function genPVAL(R){const p=pick(PERSONAJES,R),v=pick(VERBOS,R),a=pick(ADJETIVOS,R),l=pick(LUGARES,R);return{ text:`${p} ${v} ${a} ${l}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapAdj(a)} ${wrapPlace(l)}` }}
    function genPV(R){const p=pick(PERSONAJES,R),v=pick(VERBOS,R);return{ text:`${p} ${v}`, html:`${wrapChar(p)} ${wrapVerb(v)}` }}
    function genPA(R){const p=pick(PERSONAJES,R),a=pick(ADJETIVOS,R);return{ text:`${p} ${a}`, html:`${wrapChar(p)} ${wrapAdj(a)}` }}
    function genPL(R){const p=pick(PERSONAJES,R),l=pick(LUGARES,R);return{ text:`${p} ${l}`, html:`${wrapChar(p)} ${wrapPlace(l)}` }}
    function genPAL(R){const p=pick(PERSONAJES,R),a=pick(ADJETIVOS,R),l=pick(LUGARES,R);return{ text:`${p} ${a} ${l}`, html:`${wrapChar(p)} ${wrapAdj(a)} ${wrapPlace(l)}` }}
    function genPVA(R){const p=pick(PERSONAJES,R),v=pick(VERBOS,R),a=pick(ADJETIVOS,R);return{ text:`${p} ${v} ${a}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapAdj(a)}` }}
    function genPVL(R){const p=pick(PERSONAJES,R),v=pick(VERBOS,R),l=pick(LUGARES,R);return{ text:`${p} ${v} ${l}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapPlace(l)}` }}
    function genFusion(R){let p1=pick(PERSONAJES,R);let p2;do{p2=pick(PERSONAJES,R)}while(p2===p1);return{ text:`${p1} + ${p2}`, html:`${wrapChar(p1)} + ${wrapChar(p2)}` }}
    function genP(R){const p=pick(PERSONAJES,R);return{ text:`${p}`, html:`${wrapChar(p)}` }}
    function genEvento(R){const e=pick(EVENTOS,R),p=pick(PERSONAJES,R);return{ text:`${e} ${p}`, html:`${wrapEvent(e)} ${wrapChar(p)}` }}
    function genEscena(R){const s=pick(ESCENAS,R),l=pick(LUGARES,R);return{ text:`${s} ${l}`, html:`${wrapScene(s)} ${wrapPlace(l)}` }}

    const recent=[]; let lastCopyText='';

    function generarUno(mode){
      const R=rng((byId('seed').value||'').trim());
      switch(mode){
        case'PV':return genPV(R);
        case'PA':return genPA(R);
        case'PL':return genPL(R);
        case'PAL':return genPAL(R);
        case'PVA':return genPVA(R);
        case'PVL':return genPVL(R);
        case'FUSION':return genFusion(R);
        case'P':return genP(R);
        case'EVENTO':return genEvento(R);
        case'ESCENA':return genEscena(R);
        default:return genPVAL(R);
      }
    }

    function generarN(mode,n){
      const R=rng((byId('seed').value||'').trim());
      const gens={PVAL:genPVAL,PV:genPV,PA:genPA,PL:genPL,PAL:genPAL,PVA:genPVA,PVL:genPVL,FUSION:genFusion,P:genP,EVENTO:genEvento,ESCENA:genEscena};
      const fn=gens[mode]||genPVAL;
      const out=Array.from({length:n},()=>fn(R));
      byId('salida').innerHTML=out.map(o=>o.html).join('<br>');
      const texts=out.map(o=>o.text);
      lastCopyText=texts.join('\n');
      recent.push(...texts); renderHistorial();
    }

    function renderHistorial(){
      const last=recent.slice(-10).reverse();
      byId('historial').innerHTML=last.length ?
        ( `<div class="muted">√öltimos (${last.length}):</div>` + last.map(x=>`<span class="tag">${esc(x)}</span>`).join('') )
        : '';
    }

    // --- Sonido UI moderno (WebAudio, sin archivos externos)
    let __uiAudioCtx;
    function playClick(){
      try{
        if(!__uiAudioCtx){ __uiAudioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
        const ctx = __uiAudioCtx;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.value = 320; // tono corto, moderno
        gain.gain.setValueAtTime(0.0001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime + 0.005);
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.08);
        osc.connect(gain).connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.09);
      }catch(e){ /* silencio si el navegador no soporta */ }
    }

    byId('btnPVAL').onclick=()=>generarN('PVAL',1);
    byId('btnPV').onclick=()=>generarN('PV',1);
    byId('btnPA').onclick=()=>generarN('PA',1);
    byId('btnPL').onclick=()=>generarN('PL',1);
    byId('btnPAL').onclick=()=>generarN('PAL',1);
    byId('btnPVA').onclick=()=>generarN('PVA',1);
    byId('btnPVL').onclick=()=>generarN('PVL',1);
    byId('btnFusion').onclick=()=>generarN('FUSION',1);
    byId('btnP').onclick=()=>generarN('P',1);
    byId('btnEvento').onclick=()=>generarN('EVENTO',1);
    byId('btnEscena').onclick=()=>generarN('ESCENA',1);
    /* IMPORTANTE: no damos handler aqu√≠ a Generar 5; lo controlar√° Firebase abajo */

    // Reproducir sonido en TODOS los botones (captura temprana)
    (function(){
      const btns = document.querySelectorAll('button');
      btns.forEach(b=> b.addEventListener('click', playClick, {capture:true}));
    })();

    byId('btnCopiar').onclick=async()=>{
      if(!lastCopyText) return;
      await navigator.clipboard.writeText(lastCopyText);
    }

    byId('btnTest').onclick=()=>{
      const modes=['PVAL','PV','PA','PL','PAL','PVA','PVL','FUSION','P','EVENTO','ESCENA'];
      let report='Pruebas:';
      for(const m of modes){
        let ok=0,total=100;
        for(let i=0;i<total;i++){
          const {text,html}=generarUno(m);
          if(typeof text==='string'&&text.length>0&&typeof html==='string'&&html.length>0) ok++;
        }
        report+=`\n‚Ä¢ ${m}: ${ok}/${total} generados correctamente`;
      }
      byId('testlog').textContent=report;
    }

    document.addEventListener('keydown',e=>{
      if((e.metaKey||e.ctrlKey)){
        if(e.key==='1'){e.preventDefault();generarN('PVAL',1);} 
        if(e.key==='2'){e.preventDefault();generarN('PV',1);}   
        if(e.key==='3'){e.preventDefault();generarN('PA',1);}   
        if(e.key==='4'){e.preventDefault();generarN('PL',1);}   
        if(e.key==='5'){e.preventDefault();generarN('FUSION',1);} 
        if(e.key==='6'){e.preventDefault();generarN('P',1);}    
      }
    });

    generarN('PVAL',1);
  </script>

  <!-- üî• Firebase Realtime + LOBBY con presencia real -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, onDisconnect, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    /* ‚õ≥ Reemplaza por TU config real si a√∫n no lo hiciste */
    const firebaseConfig = {
      apiKey: "AIzaSyAHEBnKMHJt9npV6NeHzSjWdJtBE9EUmwQ",
      authDomain: "arte-moderno-5ff8a.firebaseapp.com",
      projectId: "arte-moderno-5ff8a",
      storageBucket: "arte-moderno-5ff8a.firebasestorage.app",
      messagingSenderId: "478321511301",
      appId: "1:478321511301:web:6b46294944397c0ce952ec",
      measurementId: "G-BP2SKW1881"
    };

    const appFB = initializeApp(firebaseConfig);
    const db = getDatabase(appFB);

    let lobbyCode = null;
    let isHost = false;
    let currentConnRef = null; // referencia a ESTA pesta√±a en el lobby

    function getClientId(){
      const k="am_client_id";
      let id=localStorage.getItem(k);
      if(!id){ id = Math.random().toString(36).slice(2); localStorage.setItem(k,id); }
      return id;
    }
    const clientId = getClientId();

    const $ = (id)=> document.getElementById(id);
    const statusEl = $("lobbyStatus");

    function makeCode(){
      const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      return Array.from({length:5},()=> chars[Math.floor(Math.random()*chars.length)]).join("");
    }

    /* üîó Presencia por pesta√±a (se borra sola al cerrar) */
    function setupPresence(code){
      if (!code) return;

      // Si cambiaste de sala, cancela onDisconnect anterior
      if (currentConnRef) { try { onDisconnect(currentConnRef).cancel(); } catch(e){} currentConnRef = null; }

      const infoRef = ref(db, ".info/connected");
      onValue(infoRef, (snap)=>{
        if (snap.val() === true) {
          // crea una conexi√≥n (una por pesta√±a)
          const connRef = push(ref(db, `lobbies/${code}/players/${clientId}/connections`));
          currentConnRef = connRef;
          set(connRef, true);
          onDisconnect(connRef).remove(); // el server la borra al desconectar
          // asegura el flag conectado del jugador
          update(ref(db, `lobbies/${code}/players/${clientId}`), { connected: true });
        }
      });
    }

    function updateHostUI(){
      const ids = [
        'btnP','btnFusion','btnEvento','btnEscena',
        'btnPV','btnPA','btnPL','btnPVA','btnPAL','btnPVL','btnPVAL',
        'btnGenerar5'
      ];
      const disabled = (lobbyCode && !isHost);
      ids.forEach(id=>{
        const el = $(id);
        if(!el) return;
        el.disabled = disabled;
        el.style.opacity = disabled ? 0.5 : '';
        el.style.pointerEvents = disabled ? 'none' : '';
      });
    }

    function watchLobby(code){
      onValue(ref(db, `lobbies/${code}`), (snap)=>{
        const state = snap.val();
        if(!state) return;
        lobbyCode = code;
        isHost = state.hostId === clientId;

        // Cuenta SOLO jugadores con >=1 conexi√≥n
        if (statusEl) {
          let players = 0;
          if (state.players) {
            players = Object.values(state.players)
              .filter(p => p && p.connections && Object.keys(p.connections).length > 0).length;
          }
          statusEl.textContent = `Sala: ${code} ‚Ä¢ ${isHost ? "Eres ADMIN" : "Jugador"} ‚Ä¢ Conectados: ${players}`;
        }

        if (state.seed != null && $("seed")) $("seed").value = state.seed;
        if (state.currentOutputHtml && $("salida")) $("salida").innerHTML = state.currentOutputHtml;

        updateHostUI(); // bloquear/permitir seg√∫n rol
      });
    }

    async function createLobby(name){
      const code = makeCode();
      const state = {
        hostId: clientId,
        seed: ($("seed")?.value||""),
        currentOutputHtml: "",
        currentOutputText: "",
        players: { [clientId]: { name: name||"Host", score: 0, connected: true } },
        createdAt: Date.now()
      };
      await set(ref(db, `lobbies/${code}`), state);
      watchLobby(code);
      setupPresence(code); // üëà presencia
    }

    async function joinLobby(code, name){
      code = (code||"").toUpperCase().trim();
      if(!code) return alert("Escribe un c√≥digo de sala");
      const player = { name: name||"Jugador", score: 0, connected: true };
      await update(ref(db, `lobbies/${code}/players/${clientId}`), player);
      watchLobby(code);
      setupPresence(code); // üëà presencia
    }

    async function publishOutput(html, text){
      if(!lobbyCode || !isHost) return;
      await update(ref(db, `lobbies/${lobbyCode}`), {
        seed: ($("seed")?.value||""),
        currentOutputHtml: html,
        currentOutputText: text
      });
    }

    $("btnCreateLobby")?.addEventListener("click", ()=>{
      const name = $("playerName")?.value || "Host";
      createLobby(name);
    });
    $("btnJoinLobby")?.addEventListener("click", ()=>{
      const name = $("playerName")?.value || "Jugador";
      const code = $("lobbyCodeInput")?.value;
      joinLobby(code, name);
    });

    // --- Enrutamos TODOS los generadores por una sola funci√≥n con control de rol ---
    const MAP = {
      btnPVAL:'PVAL', btnPV:'PV', btnPA:'PA', btnPL:'PL',
      btnPVA:'PVA', btnPAL:'PAL', btnPVL:'PVL',
      btnFusion:'FUSION', btnP:'P', btnEvento:'EVENTO', btnEscena:'ESCENA'
    };

    function genOne(mode){
      const R = window.rng?.(($("seed")?.value||"").trim()) || Math.random;
      const gens = {
        PVAL: window.genPVAL, PV: window.genPV, PA: window.genPA, PL: window.genPL,
        PAL: window.genPAL, PVA: window.genPVA, PVL: window.genPVL,
        FUSION: window.genFusion, P: window.genP, EVENTO: window.genEvento, ESCENA: window.genEscena
      };
      const fn = gens[mode] || gens["PVAL"];
      return fn(R);
    }

    function handleGenerate(mode){
      if(lobbyCode){
        if(!isHost) return; // solo admin
        const { html, text } = genOne(mode);
        publishOutput(html, text);
      }else{
        const { html } = genOne(mode);
        $("salida").innerHTML = html;
      }
    }

    // Sobrescribimos handlers .onclick (no addEventListener) para evitar duplicados
    Object.entries(MAP).forEach(([id,mode])=>{
      const btn = $(id);
      if(btn){
        btn.onclick = ()=> handleGenerate(mode);
      }
    });

    // Generar 5 controlado por rol (sobrescribe cualquier handler previo)
    if ($("btnGenerar5")) {
      $("btnGenerar5").onclick = ()=>{
        if (lobbyCode && !isHost) return; // bloqueado para no-host
        const R = window.rng?.(($("seed")?.value||"").trim()) || Math.random;
        const out = Array.from({length:5}, ()=> window.genPVAL(R));
        const html = out.map(o=>o.html).join("<br>");
        const text = out.map(o=>o.text).join("\n");
        if (lobbyCode && isHost) publishOutput(html, text);
        else $("salida").innerHTML = html;
      };
    }

    // Bloqueo de atajos de teclado para no-host (Ctrl/‚åò + 1..6)
    document.addEventListener('keydown', (e)=>{
      if ((e.metaKey || e.ctrlKey) && ['1','2','3','4','5','6'].includes(e.key)) {
        if (lobbyCode && !isHost) {
          e.preventDefault();
          e.stopPropagation();
        }
      }
    }, true);
  </script>

</body>
</html>
