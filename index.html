<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>ARTE MODERNO - Generador de Enunciados by © 2025 Tabja Games</title>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{
      --bg:#0b1020;--panel:#111a2b;--muted:#99a3b4;--text:#e7eefc;
      --accent:#0ea5e9;--accent2:#22c55e;
      --verb:#ff4d4d; --adj:#7CFC00; --place:#ffe066; --event:#b266ff; --scene:#ffb347;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
      color:var(--text);background:linear-gradient(180deg,#0b1020,#0b1428) fixed;
    }
    header{
      position:sticky;top:0;background:rgba(9,13,26,.7);backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,.05);z-index:10
    }
    .container{max-width:820px;margin:0 auto;padding:16px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 6px 30px rgba(0,0,0,.25)
    }
    .title{font-size:20px;font-weight:700;display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted)}
    .btn{
      appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:700;color:var(--text);
      background:transparent;border:1px solid rgba(255,255,255,.12);cursor:pointer;transition:background .15s,color .15s;font-size:14px;
    }
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn:active{transform:translateY(1px)}
    .inline{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input{
      width:100%;background:#0f182a;color:var(--text);border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;font-size:15px;
    }
    .out{
      font-size:22px;line-height:1.45;background:#0b1426;border-radius:14px;padding:14px;border:1px dashed rgba(255,255,255,.15)
    }
    footer{opacity:.7;padding:24px 12px;text-align:center;font-size:12px;position:relative}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;border:1px solid rgba(255,255,255,.2);padding:2px 6px;border-radius:6px;background:#0e1628}
    .tag{display:inline-block;padding:.25rem .6rem;border:1px solid rgba(255,255,255,.18);border-radius:999px;margin:0.25rem;font-size:13px;color:var(--muted);}
    .char{ color:#4cc9f0; } .verb{ color:var(--verb); } .adj{ color:var(--adj); } .place{ color:var(--place); } .event{ color:var(--event); } .scene{ color:var(--scene); }

    #footerBtns{position:absolute;right:12px;bottom:8px;opacity:0;transition:opacity .3s;display:flex;gap:6px;}
    footer:hover #footerBtns{opacity:0.5;}
    #footerBtns .btn{font-size:10px;padding:4px 8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);}
    .btn span { font-weight: bold; }
    .letter-p{color:#4cc9f0}.letter-v{color:#ff4d4d}.letter-a{color:#7CFC00}.letter-l{color:#ffe066}

    /* Overlay inicial */
    #lobbyOverlay{position:fixed; inset:0; background:rgba(11,16,32,.92);backdrop-filter: blur(8px); display:none; align-items:center; justify-content:center; z-index:1000;}

    /* Toast */
    #toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
      background:rgba(20,28,48,.96); border:1px solid rgba(255,255,255,.15); color:var(--text);
      padding:10px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);
      opacity:0; transition:opacity .25s, transform .25s; z-index:1200; pointer-events:none; font-weight:700;
    }
    #toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    /* Chips de jugadores */
    .players-wrap{display:flex;flex-wrap:wrap;gap:8px}
    .playerChip{
      display:flex;align-items:center;gap:8px;
      padding:6px 10px;border:1px solid rgba(255,255,255,.14);
      border-radius:999px;background:rgba(255,255,255,.04)
    }
    .playerChip .avatar{
      width:26px;height:26px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:800;background:#0e1628;border:1px solid rgba(255,255,255,.18);
      font-size:12px;color:var(--text)
    }
    .playerChip .dot{
      width:8px;height:8px;border-radius:50%;background:var(--accent2)
    }
    .playerChip .name{font-weight:700}
    .playerChip .role{
      font-size:10px;border:1px solid rgba(255,255,255,.2);
      padding:2px 6px;border-radius:999px;opacity:.9
    }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;flex-direction:column;gap:6px">
      <div class="inline" style="justify-content:space-between; gap:12px">
        <div class="title" style="flex:1; min-width:0">
          🎨 ARTE MODERNO - Generador de Enunciados
          <span class="muted">by © 2025 Tabja Games</span>
        </div>
        <span id="roomBadge" class="muted" style="display:none;font-weight:700;padding:4px 10px;border:1px solid rgba(255,255,255,.15);border-radius:999px;">Sala: -----</span>
      </div>
      <div id="leaveRow" class="inline" style="display:none;justify-content:flex-end;">
        <button class="btn" id="btnLeave">Salir de la sala</button>
      </div>
    </div>
  </header>

  <!-- Overlay de inicio -->
  <div id="lobbyOverlay">
    <section class="card" style="max-width:520px; width:92%; padding:20px">
      <div class="title" style="margin-bottom:10px">Crear o unirse a una sala</div>
      <div class="inline" style="align-items:flex-end; gap:10px; flex-wrap:wrap">
        <div>
          <label class="muted" for="playerName">Tu nombre</label><br>
          <input id="playerName" placeholder="Ej: Tabja" style="max-width:180px">
        </div>
        <div>
          <label class="muted" for="lobbyCodeInput">Código de sala</label><br>
          <input id="lobbyCodeInput" placeholder="ABCD2" style="max-width:140px;text-transform:uppercase">
        </div>
        <button class="btn" id="btnCreateLobby">Crear sala</button>
        <button class="btn" id="btnJoinLobby">Unirse</button>
      </div>
      <div class="muted" id="lobbyStatus" style="margin-top:10px; min-height:20px"></div>
    </section>
  </div>

  <main class="container" style="padding-top:18px">
    <section class="card">
      <div style="display:grid;gap:10px">
        <div class="inline">
          <button class="btn" id="btnP">PERSONAJE</button>
          <button class="btn" id="btnFusion">FUSIÓN</button>
          <button class="btn" id="btnEvento">EVENTOS</button>
          <button class="btn" id="btnEscena">ESCENAS</button>
        </div>
        <div class="inline">
          <button class="btn" id="btnPV"><span class="letter-p">P</span> + <span class="letter-v">V</span></button>
          <button class="btn" id="btnPA"><span class="letter-p">P</span> + <span class="letter-a">A</span></button>
          <button class="btn" id="btnPL"><span class="letter-p">P</span> + <span class="letter-l">L</span></button>
          <button class="btn" id="btnPVA"><span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-a">A</span></button>
          <button class="btn" id="btnPAL"><span class="letter-p">P</span> + <span class="letter-a">A</span> + <span class="letter-l">L</span></button>
          <button class="btn" id="btnPVL"><span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-l">L</span></button>
          <button class="btn" id="btnPVAL"><span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-a">A</span> + <span class="letter-l">L</span></button>
        </div>
        <div class="inline">
          <button class="btn" id="btnGenerar5">Generar 5</button>
          <button class="btn" id="btnGrupos">Generar Grupos</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="title">Enunciado a dibujar</div>
      <div id="salida" class="out" style="margin-top:10px;white-space:pre-wrap"></div>
      <div id="historial" style="margin-top:10px"></div>
      <div id="testlog" class="muted" style="margin-top:10px"></div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="title">Grupos</div>
      <div id="grupos" class="out" style="margin-top:10px;white-space:pre-wrap"></div>
    </section>

    <!-- NUEVO: Jugadores conectados -->
    <section class="card" id="playersCard" style="margin-top:14px; display:none">
      <div class="title">Jugadores conectados</div>
      <div id="playersList" class="players-wrap" style="margin-top:10px"></div>
    </section>
  </main>

  <footer>
    Hecho para móvil y desktop.  
    Atajos: <span class="kbd">Ctrl/Cmd + 1..6</span>
    <div id="footerBtns">
      <button class="btn" id="btnCopiar">Copiar</button>
      <button class="btn" id="btnTest">Test</button>
    </div>
  </footer>

  <!-- Toast element -->
  <div id="toast"></div>

  <script>
    const PERSONAJES=['Goku','Vegeta','Piccolo','Freezer','Monkey D. Luffy','Roronoa Zoro','Sanji','Nami','Naruto Uzumaki','Sasuke Uchiha','Kakashi Hatake','Ichigo Kurusaki','Satoru Gojo','Eren Yeager','Levi Ackerman','Shigeo Kageyama','Saitama','Edward Elric','Tanjiro Kamado','Nezuko Kamado','Kenshin Himura','Joseph Joestar','Guts','Ash Ketchum','Yugi Muto','Bob Esponja','Patricio Estrella','Calamardo','Arnold Shortman','Aang','Timmy Turner','Jimmy Neutron','Johnny Bravo','Mojo Jojo','Perry El Ornitorrinco','Optimus Prime','Mickey Mouse','Bugs Bunny','El Pato Donald','Felix El Gato','Winnie-the-Pooh','Charlie Brown','Snoopy','Hello Kitty','Dora La Exploradora','Peppa Pig','Homero Simpson','Rick Sanchez','Morty Smith','Eric Cartman','Buzz Lightyear','Mike Wazowski','Shrek','Wall-E','Stitch','Nemo','Elsa','Simba','Luke Skywalker','Darth Vader','Yoda','E.T.','John Wick','Neo','Indiana Jones','El Terminator','Jack Sparrow','Borat','Charlie Chaplin','Jason Voorhees','Chucky','Freddy Krueger','Jigsaw','Pennywise','Edward Scissorhands','Jack Skellington','Godzilla','El Xenomorfo','Superman','Spider-Man','Batman','Wolverine','Hulk','Venom','Thor','El Joker','Albert Einstein','Leo Messi','Napoleón Bonaparte','Atahualpa','Hitler','Michael Jackson','Freddie Mercury','Beethoven','Pedro Castillo','Donald Trump','Gandalf','Frodo Baggins','Gollum','Harry Potter','Voldemort','Willy Wonka','Cenicienta','Rapunzel','Aladino','Dracula','Frankenstein','Wednesday Addams','El Jorobado de Notre Dame','James Bond','Don Quijote de la Mancha','El Gato con Botas','Robin Hood','Pinnochio','Tarzán','Tralalero Tralalá','Brr Brr Patapím','Chimpanzini Bananini','Tung Tung Tung Sahur','Bombardino Crocodilo','La Vaca Saturno Saturnita','Clippy','El Chavo del Ocho','Jon Snow','Walter White','La Rana René','Pikachu','Mario','Bowser','Yoshi','Donkey Kong','Kirby','Link','Zelda','Samus Aran','Sonic','Crash Bandicoot','Mega Man','Pac-Man','Leon S. Kennedy','Lara Croft','El Amongus','Santa Claus','Dios','Atlas','Zeus','Poseidón','Hércules','Pegaso','El Kraken','El Cíclope','El Minotauro','El Cerbero','El Fénix','El Leviatán','El Fenrir','La Medusa','La Muerte','El Yeti','El Chupacabras','Un Ángel','Un Demonio','Un Centauro','Un Gólem','Un Basilisco','Un Grifo','Un Ogro','Una Sirena','Una Arpía','Una Hidra','Una Quimera','Un Licántropo','Un Unicornio','Una Bruja','Un Dragón','Una Valquiria','Un Elfo','Un Gnomo','Un Duende','Un Hada','Un Fantasma','Un Vampiro','Un Zombie','Una Momia','Un Esqueleto','Un Mago'];
    const VERBOS=['leyendo','patinando','esquiando','surfeando','navegando','cabalgando','pedaleando','nadando','bailando','pescando','regando','componiendo','escribiendo','cocinando','conduciendo','cenando','trabajando','jugando','barriendo','corriendo','caminando','saltando','trepando','luchando','descansando','durmiendo','marchando','volando','bebiendo','fumando','vomitando','masturbando','orinando','cagando','copulando','muriendo','naciendo','pariendo','gritando','llorando','cantando','pensando','rezando','vendiendo','saludando','boxeando'];
    const ADJETIVOS=['content@','enojad@','asustad@','preocupad@','desnud@','cansad@','confundid@','excitad@','aburrid@','sorprendid@','doblad@','sentad@','parad@','arrodillad@','echad@','suspendid@','tembland@','derretid@','herid@','atad@','enamorad@','relajad@','borrach@','nervios@','enferm@','descalz@','tens@'];
    const LUGARES=['bajo el agua','bajo el sol','bajo la luna','bajo la lluvia','bajo la tierra','bajo las estrellas','bajo un árbol','bajo un puente','sobre un tren','sobre una torre','sobre una cama','sobre una mesa','sobre un techo','sobre las nubes','tras los arbustos','tras una roca','tras la ventana','tras las rejas','en el campo','en el mar','en el espacio','en el futuro','en el pasado','en el infierno','en el cielo','en la ciudad','en la montaña','en la playa','en la selva','en el Valhalla','en el Olimpo','en la corte','en el fin del mundo','en la prehistoria','en un baño','en un bosque','en un colegio','en un desierto','en un gimnasio','en un zoológico','en un pantano','en una tormenta','en una oficina','en un bar','en un hospital','en un cementerio','en un parque','en un balcón','en una granja','en un teatro','en una biblioteca','en un cine','en un avión','en un helicóptero','en un cohete','en un castillo','en un mercado','en una pradera','en un globo','en un burdel','en un laboratorio','en una prisión','en un jardín','en Egipto','en Francia','en Japón','en Perú','en Australia','en la Antártida'];
    const EVENTOS=['El nacimiento de','La muerte de','La creación de','La destrucción de','La victoria de','La derrota de','El sacrificio de','La furia de','La caída de','El sueño de','El regreso de','La invasión de','El ritual de','La persecución de','La evolución de','Los ojos de','El beso de','El rapto de','La danza de','La casa de','La habitación de','El baño de','Retrato de','La venganza de','La tortura de','El castigo de','La traición de','La ejecución de','El asesinato de','La rebelión de','El entierro de','La confesión de','El cumpleaños de','El concierto de','El bautizo de','El Baby Shower de','La aventura de'];
    const ESCENAS=['Guerra','Paz','Caos','Orden','Odio','Amor','Soledad','Invierno','Verano','Otoño','Primavera','Amanecer','Atardecer','Anochecer','Terror','Incendio','Duelo','Batalla','Matrimonio','Despedida','Bienvenida','Encuentro','Apocalipsis','Tragedia','Desastre','Catástrofe','Exterminio','Masacre','Tratado','Barbacoa','Picnic','Banquete','Fiesta','Excursión','Olimpiadas','Carnaval','Desfile','Venganza','Tortura','Castigo','Traición','Ejecución','Asesinato','Revolución','Funeral','Confesión','Cumpleaños','Concierto','Bautizo','Baby Shower','Aventura'];

    const byId=id=>document.getElementById(id);
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
    function rng(seed){if(!seed)return Math.random;let n=0;for(let i=0;i<seed.length;i++)n=(n*31+seed.charCodeAt(i))>>>0;return mulberry32(n)}
    const pick=(arr,R)=>arr[Math.floor(R()*arr.length)];
    const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const wrapChar=name=>`<span class="char">${esc(name)}</span>`;
    const wrapVerb=v=>`<span class="verb">${esc(v)}</span>`;
    const wrapAdj=a=>`<span class="adj">${esc(a)}</span>`;
    const wrapPlace=l=>`<span class="place">${esc(l)}</span>`;
    const wrapEvent=e=>`<span class="event">${esc(e)}</span>`;
    const wrapScene=s=>`<span class="scene">${esc(s)}</span>`;

    function genPVAL(R){const p=pick(PERSONAJES,R),v=pick(VERBOS,R),a=pick(ADJETIVOS,R),l=pick(LUGARES,R);return{ text:`${p} ${v} ${a} ${l}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapAdj(a)} ${wrapPlace(l)}` }}
    function genPV(R){const p=pick(PERSONAJES,R),v=pick(VERBOS,R);return{ text:`${p} ${v}`, html:`${wrapChar(p)} ${wrapVerb(v)}` }}
    function genPA(R){const p=pick(PERSONAJES,R),a=pick(ADJETIVOS,R);return{ text:`${p} ${a}`, html:`${wrapChar(p)} ${wrapAdj(a)}` }}
    function genPL(R){const p=pick(PERSONAJES,R),l=pick(LUGARES,R);return{ text:`${p} ${l}`, html:`${wrapChar(p)} ${wrapPlace(l)}` }}
    function genPAL(R){const p=pick(PERSONAJES,R),a=pick(ADJETIVOS,R),l=pick(LUGARES,R);return{ text:`${p} ${a} ${l}`, html:`${wrapChar(p)} ${wrapAdj(a)} ${wrapPlace(l)}` }}
    function genPVA(R){const p=pick(PERSONAJES,R),v=pick(VERBOS,R),a=pick(ADJETIVOS,R);return{ text:`${p} ${v} ${a}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapAdj(a)}` }}
    function genPVL(R){const p=pick(PERSONAJES,R),v=pick(VERBOS,R),l=pick(LUGARES,R);return{ text:`${p} ${v} ${l}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapPlace(l)}` }}
    function genFusion(R){let p1=pick(PERSONAJES,R);let p2;do{p2=pick(PERSONAJES,R)}while(p2===p1);return{ text:`${p1} + ${p2}`, html:`${wrapChar(p1)} + ${wrapChar(p2)}` }}
    function genP(R){const p=pick(PERSONAJES,R);return{ text:`${p}`, html:`${wrapChar(p)}` }}
    function genEvento(R){const e=pick(EVENTOS,R),p=pick(PERSONAJES,R);return{ text:`${e} ${p}`, html:`${wrapEvent(e)} ${wrapChar(p)}` }}
    function genEscena(R){const s=pick(ESCENAS,R),l=pick(LUGARES,R);return{ text:`${s} ${l}`, html:`${wrapScene(s)} ${wrapPlace(l)}` }}

    const recent=[]; let lastCopyText='';

    function generarUno(mode){
      const R=rng();
      switch(mode){
        case'PV':return genPV(R);
        case'PA':return genPA(R);
        case'PL':return genPL(R);
        case'PAL':return genPAL(R);
        case'PVA':return genPVA(R);
        case'PVL':return genPVL(R);
        case'FUSION':return genFusion(R);
        case'P':return genP(R);
        case'EVENTO':return genEvento(R);
        case'ESCENA':return genEscena(R);
        default:return genPVAL(R);
      }
    }

    function generarN(mode,n){
      const R=rng();
      const gens={PVAL:genPVAL,PV:genPV,PA:genPA,PL:genPL,PAL:genPAL,PVA:genPVA,PVL:genPVL,FUSION:genFusion,P:genP,EVENTO:genEvento,ESCENA:genEscena};
      const fn=gens[mode]||genPVAL;
      const out=Array.from({length:n},()=>fn(R));
      byId('salida').innerHTML=out.map(o=>o.html).join('<br>');
      const texts=out.map(o=>o.text);
      lastCopyText=texts.join('\n');
      recent.push(...texts); renderHistorial();
    }

    function renderHistorial(){
      const last=recent.slice(-10).reverse();
      byId('historial').innerHTML=last.length ?
        ( `<div class="muted">Últimos (${last.length}):</div>` + last.map(x=>`<span class="tag">${esc(x)}</span>`).join('') )
        : '';
    }

    // Toast helper
    const toastEl = document.getElementById('toast');
    let toastTimer=null;
    function showToast(msg){
      if(!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 2200);
    }

    let __uiAudioCtx;
    function playClick(){
      try{
        if(!__uiAudioCtx){ __uiAudioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
        const ctx = __uiAudioCtx;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'triangle'; osc.frequency.value = 320;
        gain.gain.setValueAtTime(0.0001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime + 0.005);
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.08);
        osc.connect(gain).connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.09);
      }catch(e){}
    }

    byId('btnPVAL').onclick=()=>generarN('PVAL',1);
    byId('btnPV').onclick=()=>generarN('PV',1);
    byId('btnPA').onclick=()=>generarN('PA',1);
    byId('btnPL').onclick==>generarN('PL',1);
    byId('btnPAL').onclick=()=>generarN('PAL',1);
    byId('btnPVA').onclick=()=>generarN('PVA',1);
    byId('btnPVL').onclick=()=>generarN('PVL',1);
    byId('btnFusion').onclick=()=>generarN('FUSION',1);
    byId('btnP').onclick=()=>generarN('P',1);
    byId('btnEvento').onclick=()=>generarN('EVENTO',1);
    byId('btnEscena').onclick=()=>generarN('ESCENA',1);
    /* Generar 5 y Grupos los maneja Firebase abajo */

    (function(){
      const btns = document.querySelectorAll('button');
      btns.forEach(b=> b.addEventListener('click', playClick, {capture:true}));
    })();

    byId('btnCopiar').onclick=async()=>{
      if(!lastCopyText) return;
      await navigator.clipboard.writeText(lastCopyText);
    }

    byId('btnTest').onclick=()=>{
      const modes=['PVAL','PV','PA','PL','PAL','PVA','PVL','FUSION','P','EVENTO','ESCENA'];
      let report='Pruebas:';
      for(const m of modes){
        let ok=0,total=100;
        for(let i=0;i<total;i++){
          const {text,html}=generarUno(m);
          if(typeof text==='string'&&text.length>0&&typeof html==='string'&&html.length>0) ok++;
        }
        report+=`\n• ${m}: ${ok}/${total} generados correctamente`;
      }
      byId('testlog').textContent=report;
    }

    document.addEventListener('keydown',e=>{
      if((e.metaKey||e.ctrlKey)){
        if(e.key==='1'){e.preventDefault();generarN('PVAL',1);} 
        if(e.key==='2'){e.preventDefault();generarN('PV',1);}   
        if(e.key==='3'){e.preventDefault();generarN('PA',1);}   
        if(e.key==='4'){e.preventDefault();generarN('PL',1);}   
        if(e.key==='5'){e.preventDefault();generarN('FUSION',1);} 
        if(e.key==='6'){e.preventDefault();generarN('P',1);}    
      }
    });

    generarN('PVAL',1);
  </script>

  <!-- 🔥 Firebase Realtime + LOBBY con overlay, presencia, grupos, salir y transferencia de host + TOAST admin + JUGADORES -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, onDisconnect, push, get, off, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAHEBnKMHJt9npV6NeHzSjWdJtJBE9EUmwQ",
      authDomain: "arte-moderno-5ff8a.firebaseapp.com",
      projectId: "arte-moderno-5ff8a",
      storageBucket: "arte-moderno-5ff8a.firebasestorage.app",
      messagingSenderId: "478321511301",
      appId: "1:478321511301:web:6b46294944397c0ce952ec",
      measurementId: "G-BP2SKW1881"
    };

    const appFB = initializeApp(firebaseConfig);
    const db = getDatabase(appFB);

    let lobbyCode = null;
    let isHost = false;
    let prevIsHost = false;
    let currentConnRef = null;
    let lobbyRef = null;
    let lobbyCallback = null;

    function getClientId(){
      const k="am_client_id";
      let id=localStorage.getItem(k);
      if(!id){ id = Math.random().toString(36).slice(2); localStorage.setItem(k,id); }
      return id;
    }
    const clientId = getClientId();

    const $ = (id)=> document.getElementById(id);
    const statusEl = $("lobbyStatus");
    const badgeEl  = $("roomBadge");
    const overlayEl = $("lobbyOverlay");
    const leaveRow = $("leaveRow");
    const playersCard = $("playersCard");
    const playersList = $("playersList");

    const LS_CODE_KEY = "am_lobby_code";

    function makeCode(){
      const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      return Array.from({length:5},()=> chars[Math.floor(Math.random()*chars.length)]).join("");
    }

    function setLobbyCode(code){
      lobbyCode = code;
      localStorage.setItem(LS_CODE_KEY, code);
      if (badgeEl){ badgeEl.style.display='inline-block'; badgeEl.textContent = `Sala: ${code}`; }
      if (leaveRow){ leaveRow.style.display='flex'; }
      if (overlayEl){ overlayEl.style.display='none'; }
      if (playersCard){ playersCard.style.display='block'; }
    }
    function clearLobbyCode(){
      lobbyCode = null;
      localStorage.removeItem(LS_CODE_KEY);
      if (badgeEl){ badgeEl.style.display='none'; badgeEl.textContent = 'Sala: -----'; }
      if (leaveRow){ leaveRow.style.display='none'; }
      if (overlayEl){ overlayEl.style.display='flex'; }
      if (playersCard){ playersCard.style.display='none'; }
    }

    /* Presencia por pestaña */
    function setupPresence(code){
      if (!code) return;

      if (currentConnRef) { try { onDisconnect(currentConnRef).cancel(); } catch(e){} currentConnRef = null; }

      const infoRef = ref(db, ".info/connected");
      onValue(infoRef, (snap)=>{
        if (snap.val() === true) {
          const connRef = push(ref(db, `lobbies/${code}/players/${clientId}/connections`));
          currentConnRef = connRef;
          set(connRef, true);
          onDisconnect(connRef).remove();
          update(ref(db, `lobbies/${code}/players/${clientId}`), { connected: true });
        }
      });
    }

    function updateHostUI(){
      const ids = [
        'btnP','btnFusion','btnEvento','btnEscena',
        'btnPV','btnPA','btnPL','btnPVA','btnPAL','btnPVL','btnPVAL',
        'btnGenerar5','btnGrupos'
      ];
      const disabled = (lobbyCode && !isHost);
      ids.forEach(id=>{
        const el = $(id);
        if(!el) return;
        el.disabled = disabled;
        el.style.opacity = disabled ? 0.5 : '';
        el.style.pointerEvents = disabled ? 'none' : '';
      });
    }

    function renderGroups(groupsHtml){
      const g = $("grupos");
      if (!g) return;
      g.innerHTML = groupsHtml || "";
    }

    /* NUEVO: render de jugadores conectados */
    function initials(name){
      if(!name) return "?";
      const parts = String(name).trim().split(/\s+/);
      if(parts.length === 1) return parts[0][0]?.toUpperCase() || "?";
      return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
    }
    function renderPlayers(state){
      if(!playersCard || !playersList) return;

      const playersObj = state.players || {};
      const items = Object.entries(playersObj).map(([pid,p])=>{
        const connected = !!(p && p.connections && Object.keys(p.connections).length > 0);
        return {
          id: pid,
          name: (p && p.name) || "Jugador",
          connected,
          isAdmin: state.hostId === pid
        };
      }).filter(x=>x.connected);

      if(items.length === 0){
        playersList.innerHTML = `<span class="muted">Nadie conectado aún…</span>`;
      }else{
        playersList.innerHTML = items.map(x=>`
          <div class="playerChip" title="${x.name}${x.isAdmin?' • ADMIN':''}">
            <span class="dot" aria-label="online"></span>
            <span class="avatar">${initials(x.name)}</span>
            <span class="name">${esc(x.name)}</span>
            ${x.isAdmin ? `<span class="role">ADMIN</span>` : ``}
          </div>
        `).join("");
      }

      playersCard.style.display = lobbyCode ? 'block' : 'none';
    }

    function watchLobby(code){
      // limpiar listener anterior
      if (lobbyRef && lobbyCallback){
        off(lobbyRef, 'value', lobbyCallback);
        lobbyRef = null; lobbyCallback = null;
      }
      lobbyRef = ref(db, `lobbies/${code}`);
      lobbyCallback = (snap)=>{
        const state = snap.val();
        if(!state) return;

        prevIsHost = isHost;
        isHost = state.hostId === clientId;

        if (!prevIsHost && isHost && window.showToast) {
          window.showToast("Ahora eres ADMIN");
        }

        if (badgeEl){ badgeEl.style.display='inline-block'; badgeEl.textContent = `Sala: ${code}`; }
        if (leaveRow){ leaveRow.style.display='flex'; }

        let players = 0;
        if (state.players) {
          players = Object.values(state.players)
            .filter(p => p && p.connections && Object.keys(p.connections).length > 0).length;
        }
        if (statusEl) statusEl.textContent = `Sala: ${code} • ${isHost ? "Eres ADMIN" : "Jugador"} • Conectados: ${players}`;

        if (state.currentOutputHtml && $("salida")) $("salida").innerHTML = state.currentOutputHtml;
        renderGroups(state.groupsHtml);
        renderPlayers(state);               /* ← NUEVO */

        updateHostUI();
      };
      onValue(lobbyRef, lobbyCallback);
    }

    async function createLobby(name){
      const code = makeCode();
      const state = {
        hostId: clientId,
        currentOutputHtml: "",
        currentOutputText: "",
        groupsHtml: "",
        players: { [clientId]: { name: name||"Host", score: 0, connected: true } },
        createdAt: Date.now()
      };
      await set(ref(db, `lobbies/${code}`), state);
      setLobbyCode(code);
      watchLobby(code);
      setupPresence(code);
    }

    async function joinLobby(code, name){
      code = (code||"").toUpperCase().trim();
      if(!code) return alert("Escribe un código de sala");
      const player = { name: name||"Jugador", score: 0, connected: true };
      await update(ref(db, `lobbies/${code}/players/${clientId}`), player);
      setLobbyCode(code);
      watchLobby(code);
      setupPresence(code);
    }

    async function publishOutput(html, text){
      if(!lobbyCode || !isHost) return;
      await update(ref(db, `lobbies/${lobbyCode}`), {
        currentOutputHtml: html,
        currentOutputText: text
      });
    }

    async function leaveLobby(){
      if (!lobbyCode) return;
      const code = lobbyCode;

      try{
        if (isHost) {
          const playersSnap = await get(ref(db, `lobbies/${code}/players`));
          const playersObj = playersSnap.val() || {};
          const candidatos = Object.entries(playersObj)
            .filter(([pid, p]) => pid !== clientId && p && p.connections && Object.keys(p.connections).length > 0)
            .map(([pid]) => pid);

          if (candidatos.length > 0) {
            const nuevoHostId = candidatos[0];
            await update(ref(db, `lobbies/${code}`), { hostId: nuevoHostId });
          } else {
            try { await remove(ref(db, `lobbies/${code}`)); } catch(e){}
          }
        }

        if (lobbyRef && lobbyCallback){
          off(lobbyRef, 'value', lobbyCallback);
          lobbyRef = null; lobbyCallback = null;
        }

        if (currentConnRef){
          try{ onDisconnect(currentConnRef).cancel(); }catch(e){}
          try{ await remove(currentConnRef); }catch(e){}
          currentConnRef = null;
        }

        try{ await remove(ref(db, `lobbies/${code}/players/${clientId}`)); }catch(e){}
      }catch(e){
        console.warn('Error al salir de la sala:', e);
      }

      clearLobbyCode();
      const g = $("grupos"); if (g) g.innerHTML = "";
      const s = $("salida"); if (s) s.innerHTML = "";
      if (statusEl) statusEl.textContent = "";
      if (playersList) playersList.innerHTML = "";   /* ← NUEVO: limpia lista */
      isHost = false; prevIsHost = false;
      updateHostUI();
    }

    // Exponer toast global para el otro script
    window.showToast = (msg)=>{ const el=document.getElementById('toast'); if(!el) return; el.textContent=msg; el.classList.add('show'); clearTimeout(window.__tT); window.__tT=setTimeout(()=>el.classList.remove('show'),2200); };

    // Botones overlay
    $("btnCreateLobby")?.addEventListener("click", ()=>{
      const name = $("playerName")?.value || "Host";
      createLobby(name);
    });
    $("btnJoinLobby")?.addEventListener("click", ()=>{
      const name = $("playerName")?.value || "Jugador";
      const code = $("lobbyCodeInput")?.value;
      joinLobby(code, name);
    });

    // Botón salir
    $("btnLeave")?.addEventListener("click", leaveLobby);

    // Generadores con control de rol
    const MAP = {
      btnPVAL:'PVAL', btnPV:'PV', btnPA:'PA', btnPL:'PL',
      btnPVA:'PVA', btnPAL:'PAL', btnPVL:'PVL',
      btnFusion:'FUSION', btnP:'P', btnEvento:'EVENTO', btnEscena:'ESCENA'
    };

    function genOne(mode){
      const R = (window.rng ? window.rng() : Math.random);
      const gens = {
        PVAL: window.genPVAL, PV: window.genPV, PA: window.genPA, PL: window.genPL,
        PAL: window.genPAL, PVA: window.genPVA, PVL: window.genPVL,
        FUSION: window.genFusion, P: window.genP, EVENTO: window.genEvento, ESCENA: window.genEscena
      };
      const fn = gens[mode] || gens["PVAL"];
      return fn(R);
    }

    function handleGenerate(mode){
      if(lobbyCode){
        if(!isHost) return;
        const { html, text } = genOne(mode);
        publishOutput(html, text);
      }else{
        const { html } = genOne(mode);
        $("salida").innerHTML = html;
      }
    }

    Object.entries(MAP).forEach(([id,mode])=>{
      const btn = $(id);
      if(btn){ btn.onclick = ()=> handleGenerate(mode); }
    });

    if ($("btnGenerar5")) {
      $("btnGenerar5").onclick = ()=>{
        if (lobbyCode && !isHost) return;
        const R = (window.rng ? window.rng() : Math.random);
        const out = Array.from({length:5}, ()=> window.genPVAL(R));
        const html = out.map(o=>o.html).join("<br>");
        const text = out.map(o=>o.text).join("\n");
        if (lobbyCode && isHost) publishOutput(html, text);
        else $("salida").innerHTML = html;
      };
    }

    async function generarGrupos(){
      if (!lobbyCode || !isHost) return;

      const snap = await get(ref(db, `lobbies/${lobbyCode}/players`));
      const playersObj = snap.val() || {};

      const activos = Object.values(playersObj)
        .filter(p => p && p.name)
        .filter(p => p.connections && Object.keys(p.connections).length > 0)
        .map(p => p.name);

      if (activos.length < 2 || activos.length % 2 !== 0) {
        alert("Agrega o quita un jugador para formar grupos parejos");
        return;
      }

      for (let i = activos.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [activos[i], activos[j]] = [activos[j], activos[i]];
      }

      const letras = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const grupos = [];
      for (let i = 0; i < activos.length; i += 2) {
        const idx = i / 2;
        const nombreGrupo = `Grupo ${letras[idx] || (idx+1)}`;
        grupos.push({ nombre: nombreGrupo, miembros: [activos[i], activos[i+1]] });
      }

      const gruposHtml = grupos.map(g => {
        const [a,b] = g.miembros;
        return `<div style="margin-bottom:8px"><strong>${g.nombre}:</strong> ${esc(a)} y ${esc(b)}</div>`;
      }).join("");

      await update(ref(db, `lobbies/${lobbyCode}`), { groupsHtml: gruposHtml });
    }

    if ($("btnGrupos")) {
      $("btnGrupos").onclick = ()=> {
        if (lobbyCode && !isHost) return;
        generarGrupos();
      };
    }

    document.addEventListener('keydown', (e)=>{
      if ((e.metaKey || e.ctrlKey) && ['1','2','3','4','5','6'].includes(e.key)) {
        if (lobbyCode && !isHost) {
          e.preventDefault();
          e.stopPropagation();
        }
      }
    }, true);

    // Init: entrar si hay sala guardada; si no, mostrar overlay
    (function initLobbyOnce(){
      const saved = localStorage.getItem(LS_CODE_KEY);
      if(saved){
        if (overlayEl) overlayEl.style.display = 'none';
        if (badgeEl){ badgeEl.style.display='inline-block'; badgeEl.textContent = `Sala: ${saved}`; }
        if (leaveRow){ leaveRow.style.display='flex'; }
        lobbyCode = saved;
        if (playersCard){ playersCard.style.display='block'; }
        watchLobby(saved);
        setupPresence(saved);
      }else{
        if (overlayEl) overlayEl.style.display = 'flex';
        if (playersCard){ playersCard.style.display='none'; }
      }
    })();
  </script>

</body>
</html>
