<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>ARTE MODERNO</title>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    /* ===============================
   VARIABLES & BASE
=================================*/
:root{
  --bg:#0b1020; --panel:#111a2b; --muted:#99a3b4; --text:#e7eefc;
  --accent:#0ea5e9; --accent2:#22c55e;
  --verb:#ff4d4d; --adj:#7CFC00; --place:#ffe066; --event:#b266ff; --scene:#ffb347;
}
*{ box-sizing:border-box }
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
  color:var(--text);
  background:linear-gradient(180deg,#0b1020,#0b1428) fixed;
}
.container{ max-width:820px; margin:0 auto; padding:16px }
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px;
  padding:16px;
  box-shadow:0 6px 30px rgba(0,0,0,.25);
}
.title{
  font-size:18px; font-weight:800;
  display:flex; gap:10px; align-items:center; justify-content:space-between;
}
.muted{ color:var(--muted) }

/* Typography accents */
.char{ color:#4cc9f0 } .verb{ color:var(--verb) } .adj{ color:var(--adj) }
.place{ color:#ffe066 } .event{ color:#b266ff } .scene{ color:#ffb347 }

/* ===============================
   HEADER / APPBAR
=================================*/
header{
  position:sticky; top:0; z-index:10;
  background:rgba(9,13,26,.7);
  backdrop-filter:blur(8px);
  border-bottom:1px solid rgba(255,255,255,.06);
}
.appbar{
  max-width:820px; margin:0 auto;
  padding:8px 12px; /* compacto */
  display:flex; align-items:center; gap:10px;
  min-height:48px;
}
.brand{
  display:flex; align-items:center; gap:8px; min-width:0; white-space:nowrap;
  font-weight:800; font-size:16px;
}
.spacer{ flex:1 }
#roomBadge{
  display:none; font-weight:700; font-size:12px;
  padding:4px 10px; border:1px solid rgba(255,255,255,.15); border-radius:999px;
  white-space:nowrap;
}
#leaveRow{ display:none }
#btnLeave{ padding:8px 10px; font-size:13px; border-radius:10px }

/* Acciones header solo desktop */
.header-actions{ display:none }
@media (min-width:1024px){
  .header-actions{ display:flex; gap:8px; align-items:center; }
}

/* Bot√≥n flotante ‚ÄúVer instrucciones del juego‚Äù en m√≥vil */
@media (max-width:820px){
  header a[title="Ver instrucciones del juego"]{
    top:10px !important; bottom:auto !important; right:16px !important; z-index:2000 !important;
    width:30px !important; height:30px !important; font-size:18px !important;
    opacity:.9 !important; background:rgba(255,255,255,.08) !important;
    border-color:rgba(255,255,255,.2) !important;
    box-shadow:0 2px 8px rgba(0,0,0,.35) !important;
  }
  header a[title="Ver instrucciones del juego"]:hover{
    opacity:1 !important; background:rgba(255,255,255,.16) !important;
  }
}

/* ===============================
   BOTONES / CONTROLES
=================================*/
.btn{
  appearance:none; border:0; border-radius:12px; padding:12px 14px;
  font-weight:700; color:var(--text);
  background:transparent; border:1px solid rgba(255,255,255,.12);
  cursor:pointer; transition:background .15s,color .15s,font-weight .05s; font-size:14px;
}
.btn:hover{ background:rgba(255,255,255,.08) }
.btn:active{ transform:translateY(1px) }

.btn-chip{
  margin-left:auto; padding:8px 10px; font-size:12px; opacity:.85;
}
.btn-chip .chev{ display:inline-block; transition:transform .15s ease }
.btn-chip[aria-expanded="true"] .chev{ transform:rotate(180deg) }

.inline{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
input{
  width:100%; background:#0f182a; color:var(--text);
  border:1px solid rgba(255,255,255,.14); border-radius:12px; padding:10px 12px; font-size:15px;
}

/* Secundarios: M√°s opciones + Filtros (mismo look) */
:is(#btnToggleAdv, #btnFilters){
  padding:8px 10px !important;
  font-size:12px !important; line-height:1 !important;
  background:linear-gradient(180deg, rgba(148,163,184,.16), rgba(148,163,184,.10)) !important;
  border:1px solid rgba(148,163,184,.45) !important;
  color:#d9e1ee !important; opacity:1 !important;
  box-shadow:inset 0 0 0 1px rgba(0,0,0,.08);
}
:is(#btnToggleAdv, #btnFilters):hover{
  background:linear-gradient(180deg, rgba(148,163,184,.24), rgba(148,163,184,.16)) !important;
  border-color:rgba(148,163,184,.60) !important;
}
:is(#btnToggleAdv, #btnFilters):active{
  transform:translateY(1px);
  background:rgba(148,163,184,.28) !important;
  border-color:rgba(148,163,184,.70) !important;
}
#btnToggleAdv{ margin-left:auto }
#btnFilters{ margin-left:2px }
#btnToggleAdv .chev{ opacity:.95 }

/* Ajuste m√≥vil de secundarios */
@media (max-width:820px){
  :is(#btnToggleAdv, #btnFilters){
    background:linear-gradient(180deg, rgba(148,163,184,.14), rgba(148,163,184,.08)) !important;
    border-color:rgba(148,163,184,.38) !important;
  }
}

/* Letras ‚ÄúP‚Äù / ‚ÄúP+P‚Äù en blanco */
#btnP .letter-p,
#btnFusion .letter-p{ color:var(--text) !important }

/* ===============================
   SALA / LOBBY / OVERLAYS
=================================*/
#lobbyOverlay{
  position:fixed; inset:0;
  background:rgba(11,16,32,.92);
  backdrop-filter:blur(8px);
  display:flex; align-items:center; justify-content:center;
  z-index:1000;
}

/* Overlay de Filtros */
#filtersOverlay{
  position:fixed; inset:0; z-index:1200;
  display:flex; align-items:center; justify-content:center;
  background:rgba(11,16,32,.92); backdrop-filter:blur(8px);
  padding:16px; opacity:0; pointer-events:none; transition:opacity .25s ease;
  overflow:auto; /* scroll si no entra */
}
#filtersOverlay.open{ opacity:1; pointer-events:auto }
#filtersOverlay .card{
  background:rgba(20,25,40,.98); border-radius:12px; padding:18px;
  max-height:calc(100vh - 32px); overflow:auto; -webkit-overflow-scrolling:touch;
}
#filtersOverlay .card .title{
  position:sticky; top:0; z-index:2;
  background:rgba(20,25,40,.98); border-bottom:1px solid rgba(255,255,255,.08);
  margin:-18px -18px 0; padding:10px 18px;
}

/* Overlay Confirmar Salir */
#confirmExitOverlay{ opacity:0; pointer-events:none }
#confirmExitOverlay.open{ opacity:1; pointer-events:auto }
#confirmExitOverlay.open .card{ transform:scale(1) }
#confirmExitOverlay .card{ transform:scale(.98); transition:transform .25s ease }

/* ===============================
   TOAST
=================================*/
#toast{
  position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
  background:rgba(20,28,48,.96); border:1px solid rgba(255,255,255,.15); color:var(--text);
  padding:10px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);
  opacity:0; transition:opacity .25s, transform .25s; z-index:1200; pointer-events:none; font-weight:700;
}
#toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }
/* Toast un poco m√°s abajo en m√≥viles */
@media (max-width:820px){ #toast{ bottom:14px !important } }

/* ===============================
   JUGADORES / PUNTAJE / GRUPOS
=================================*/
.players-wrap{ display:flex; flex-direction:column; gap:8px }
.players-title-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }

.playerChip{
  position:relative; display:flex; align-items:center; gap:10px;
  padding:10px 12px; border:1px solid rgba(255,255,255,.14);
  border-radius:12px; background:rgba(255,255,255,.04); width:100%;
  --gc:#64748b;
}
.playerChip::before{
  content:""; position:absolute; left:0; top:0; bottom:0; width:4px;
  background:var(--gc);
  border-top-left-radius:12px; border-bottom-left-radius:12px; opacity:.95;
}
.playerChip .dot{ width:8px; height:8px; border-radius:50%; background:var(--accent2) }
.groupBadge{
  padding:2px 8px; border:1px solid rgba(255,255,255,.18); border-radius:8px;
  background:#0e1628; font-weight:800; font-size:12px; white-space:nowrap;
}
.playerChip .name{ font-weight:700; display:flex; align-items:center; gap:8px }
.playerChip .role{
  font-size:10px; border:1px solid rgba(255,255,255,.2);
  padding:2px 6px; border-radius:999px; opacity:.9;
}
.scoreBox{
  margin-left:auto; display:flex; align-items:center; gap:6px;
  font-variant-numeric:tabular-nums; user-select:none;
}
.score{
  min-width:36px; text-align:right; font-weight:800; padding:2px 6px;
  border:1px solid rgba(255,255,255,.18); border-radius:8px; background:#0e1628;
}
.scoreBtn{
  width:28px; height:28px; display:flex; align-items:center; justify-content:center;
  border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06);
  border-radius:8px; cursor:pointer; font-weight:900; font-size:14px;
}
.scoreBtn[disabled]{ opacity:.35; cursor:not-allowed }

/* Enunciado por grupo */
.lineGroup{ display:flex; align-items:center; gap:10px; margin:6px 0 }
.lineGroup .gBadge{
  padding:2px 8px; border:1px solid rgba(255,255,255,.18); border-radius:8px;
  background:#0e1628; font-weight:800; font-size:12px; white-space:nowrap;
}

/* ===============================
   OUTPUT / NOTAS / FOOTER
=================================*/
.out{
  font-size:22px; line-height:1.45;
  background:#0b1426; border-radius:14px; padding:14px;
  border:1px dashed rgba(255,255,255,.15);
}
.challengeNote{
  color:var(--muted); font-size:13px; line-height:1.35;
  border-left:3px solid var(--accent); padding-left:8px; opacity:.95;
}
footer{
  opacity:.8; padding:16px 12px; text-align:center; font-size:12px; position:relative;
}
.kbd{
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  font-size:12px; border:1px solid rgba(255,255,255,.2); padding:2px 6px; border-radius:6px; background:#0e1628;
}
#footerBtns{
  position:absolute; right:12px; bottom:8px; opacity:0; transition:opacity .3s; display:flex; gap:6px;
}
footer:hover #footerBtns{ opacity:.5 }
#footerBtns .btn{ font-size:10px; padding:4px 8px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.05) }
.btn span{ font-weight:bold }
.letter-p{ color:#4cc9f0 } .letter-v{ color:#ff4d4d } .letter-a{ color:#7CFC00 } .letter-l{ color:#ffe066 }
footer .copyright{ margin-top:8px; text-align:center; font-size:12px; opacity:.75 }

/* ===============================
   TEMPORIZADOR
   (Consolidado respetando el cascade final)
=================================*/
/* Contenedor y select */
#timerWrap{ justify-content:center !important; gap:6px } /* gap final */
#timerSelect{
  position:relative; left:-6px; /* ajuste de posici√≥n */
  background:#0e1628; color:#fff;
  border:1px solid rgba(255,255,255,.2);
  border-radius:10px; padding:8px 12px;
  font-size:15px; font-weight:600; cursor:pointer;
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  transition:background .2s, border-color .2s;
}
#timerSelect:hover{ background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.3) }
#timerSelect:disabled{ opacity:.5; cursor:not-allowed }
#timerSelect option{ background:#0e1628; color:#fff }

/* Display (base y estados) */
#timerDisplay{
  /* valores ‚Äúfinales‚Äù del cascade original */
  display:inline-flex; align-items:center; justify-content:center;
  min-width:140px;  /* gan√≥ sobre 90px */
  font-size:16px !important; /* cuando NO est√° corriendo (ver override abajo) */
  line-height:1; font-variant-numeric:tabular-nums;
  padding:12px 16px; border-radius:14px;
  background:#0e1628; border:1px solid rgba(255,255,255,.20);
  cursor:pointer; user-select:none;
  color:#fff !important;              /* forzado blanco en todos los estados */
  transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease, color .25s ease;
}
#timerDisplay:hover{ transform:translateY(-1px) }
#timerDisplay:active{ transform:translateY(0) }

#timerDisplay.running{
  /* visual animado + realce */
  font-weight:800;
  font-size:18px;                      /* override cuando corre */
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.08), 0 8px 26px rgba(0,0,0,.35);
  border-color:rgba(255,255,255,.28);
  /* nota: color queda blanco (forzado) */
}

#timerDisplay.warning{
  color:#ff4d4d !important;            /* rojo de alerta */
  animation:timerPulse 1000ms ease-in-out infinite;
}

@keyframes timerPulse{
  0%{ transform:scale(1) }
  50%{ transform:scale(1.045) }
  100%{ transform:scale(1) }
}

/* ===============================
   AJUSTES M√ìVILES ESPEC√çFICOS
=================================*/
/* Ocultar Copiar/Test */
@media (max-width:820px){
  #btnCopiar, #btnTest{ display:none !important }
}
/* Mover ‚ÄúSala/Salir‚Äù un poco a la izquierda y respetar safe area */
@media (max-width:820px){
  #leaveRow{
    margin-right:calc(env(safe-area-inset-right, 0px) + 48px) !important;
    margin-left:6px !important;
  }
}
</style>
</head>
<body>
  <!-- Appbar compacto -->
  <header>
    <div class="appbar">
      <div class="brand">üé® ARTE MODERNO</div>
      <div class="spacer"></div>
      <span id="roomBadge">Sala: -----</span>
      <div id="leaveRow" class="inline" style="margin-left:8px">
        <button class="btn" id="btnLeave">Salir</button>
      </div>
    </div>

    <!-- Bot√≥n de ayuda (posicionado fijo) -->
    <a
      href="https://docs.google.com/document/d/1Y5aZf2fiynNV-wOyLERSH7mDVyFipPWosW3VVZwmEYE/edit?tab=t.0"
      target="_blank"
      title="Ver instrucciones del juego"
      style="
        position:fixed; top:12px; right:16px; z-index:2000;
        display:flex; align-items:center; justify-content:center;
        width:30px; height:30px; border-radius:50%;
        font-size:18px; font-weight:600; text-decoration:none;
        color:#cbd5e1; background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.15);
        backdrop-filter:blur(6px);
        transition:background .2s, border-color .2s, color .2s, transform .15s;
        box-shadow:0 2px 6px rgba(0,0,0,0.4);
      "
      onmouseover="
        this.style.background='rgba(255,255,255,0.15)';
        this.style.borderColor='rgba(255,255,255,0.25)';
        this.style.color='#e2e8f0';
        this.style.transform='scale(1.08)';
      "
      onmouseout="
        this.style.background='rgba(255,255,255,0.05)';
        this.style.borderColor='rgba(255,255,255,0.15)';
        this.style.color='#cbd5e1';
        this.style.transform='scale(1)';
      "
    >?</a>
  </header>

  <!-- Overlay de inicio -->
  <div id="lobbyOverlay">
    <section class="card" style="max-width:520px; width:92%; padding:20px">
      <!-- T√≠tulo principal del men√∫ -->
      <div
        style="
          margin-bottom:20px; text-align:center;
          display:flex; flex-direction:column; align-items:center; justify-content:center;
        "
      >
        <div
          style="
            font-size:26px; font-weight:900; letter-spacing:.3px;
            color:#ffffff; margin-bottom:6px;
          "
        >
          ¬°Bienvenidos a <span style="color:#0ea5e9">Arte Moderno üé®</span>!
        </div>
        <div style="font-size:13px; opacity:.75; color:#94a3b8">¬© 2025 Tabja Games</div>
        <div
          style="
            height:2px; width:80%;
            background:linear-gradient(90deg, transparent, #0ea5e9, transparent);
            margin-top:10px; border-radius:2px; opacity:.6;
          "
        ></div>
      </div>

      <!-- Nombre (siempre visible) -->
      <div class="inline" style="align-items:flex-end; gap:10px; flex-wrap:wrap; margin-bottom:10px">
        <div style="min-width:180px; flex:1">
          <input id="playerName" placeholder="Tu nombre" aria-label="Tu nombre" style="max-width:100%">
          <small id="nameError" style="color:#dc2626; display:none">Por favor coloca tu nombre.</small>
          <small id="nameLengthError" style="color:#dc2626; display:none">M√°ximo 10 caracteres permitidos.</small>
        </div>
      </div>

      <!-- Paso 1: elegir acci√≥n -->
      <div id="choiceRow" class="inline" style="gap:10px; flex-wrap:wrap; margin-bottom:6px">
        <button class="btn" id="btnCreateLobby">Crear sala</button>
        <button class="btn" id="btnChooseJoin">Unirse a una sala</button>
      </div>

      <!-- Paso 2 (solo si eligen Unirse): ingresar c√≥digo -->
      <div id="joinRow" class="inline" style="align-items:flex-end; gap:10px; flex-wrap:wrap; display:none">
        <div style="flex:1; min-width:200px">
          <input id="lobbyCodeInput" placeholder="C√≥digo de sala" aria-label="C√≥digo de sala" style="width:100%; text-transform:uppercase">
          <small id="codeError" style="color:#dc2626; display:none">Escribe un c√≥digo de sala.</small>
        </div>
        <button class="btn" id="btnJoinLobby">Entrar</button>
        <button class="btn" id="btnBackJoin">‚Üê Atr√°s</button>
      </div>

      <div class="muted" id="lobbyStatus" style="margin-top:10px; min-height:20px"></div>
    </section>
  </div>

  <!-- Overlay Enunciado Secreto -->
  <div
    id="secretOverlay"
    style="
      display:none; position:fixed; inset:0; z-index:1200;
      align-items:center; justify-content:center;
      background:rgba(11,16,32,.92); backdrop-filter:blur(8px); padding:16px;
    "
  >
    <section class="card" style="max-width:520px; width:92%; padding:20px; text-align:center">
      <div id="secretTitle" style="font-weight:900; font-size:20px; margin-bottom:8px">üïµÔ∏è Enunciado secreto</div>
      <div id="secretContent" class="out" style="margin-top:10px; white-space:pre-wrap"></div>
      <div class="inline" style="justify-content:center; margin-top:14px">
        <button class="btn" id="btnSecretOK">Entendido</button>
      </div>
    </section>
  </div>

  <!-- Overlay Confirmar Salida -->
  <div
    id="confirmExitOverlay"
    style="
      position:fixed; inset:0; z-index:1300; display:flex; align-items:center; justify-content:center;
      background:rgba(11,16,32,.92); backdrop-filter:blur(8px); padding:16px;
      transition:opacity .25s ease; opacity:0; pointer-events:none;
    "
  >
    <section class="card" style="max-width:520px; width:92%; padding:20px; text-align:center">
      <div style="font-weight:900; font-size:18px; margin-bottom:10px">¬øEst√°s seguro de salir?</div>
      <div class="muted" style="margin-bottom:16px">Perder√°s todo tu puntaje acumulado.</div>
      <div class="inline" style="justify-content:center; gap:10px">
        <button class="btn" id="btnConfirmExitYes">S√≠</button>
        <button class="btn" id="btnConfirmExitNo">No</button>
      </div>
    </section>
  </div>

  <!-- Overlay Filtros (solo admin en sala; cualquiera en modo local) -->
  <div
    id="filtersOverlay"
    style="
      position:fixed; inset:0; z-index:1200; display:flex; align-items:center; justify-content:center;
      background:rgba(11,16,32,.92); backdrop-filter:blur(8px); padding:16px;
    "
  >
    <section class="card" style="max-width:520px; width:92%; padding:18px">
      <div class="title" style="align-items:center">
        <span>Frecuencia de Personajes</span>
        <div class="inline">
          <button class="btn" id="btnCloseFilters" aria-label="Cerrar">‚úï</button>
        </div>
      </div>

      <div class="inline" style="flex-direction:column; gap:14px; margin-top:16px">
        <!-- Anime -->
        <label style="width:100%">
          <div class="inline" style="justify-content:space-between">
            <span class="muted">Anime</span>
            <span class="kbd" id="wAnimeVal">1</span>
          </div>
          <input id="wAnime" type="range" min="0" max="5" step="1" value="1">
        </label>

        <!-- Caricaturas -->
        <label style="width:100%">
          <div class="inline" style="justify-content:space-between">
            <span class="muted">Caricaturas</span>
            <span class="kbd" id="wCaricaturasVal">1</span>
          </div>
          <input id="wCaricaturas" type="range" min="0" max="5" step="1" value="1">
        </label>

        <!-- Cine -->
        <label style="width:100%">
          <div class="inline" style="justify-content:space-between">
            <span class="muted">Cine</span>
            <span class="kbd" id="wCineVal">1</span>
          </div>
          <input id="wCine" type="range" min="0" max="5" step="1" value="1">
        </label>

        <!-- Literatura -->
        <label style="width:100%">
          <div class="inline" style="justify-content:space-between">
            <span class="muted">Literatura</span>
            <span class="kbd" id="wLiteraturaVal">1</span>
          </div>
          <input id="wLiteratura" type="range" min="0" max="5" step="1" value="1">
        </label>

        <!-- Videojuegos -->
        <label style="width:100%">
          <div class="inline" style="justify-content:space-between">
            <span class="muted">Videojuegos</span>
            <span class="kbd" id="wVideojuegosVal">1</span>
          </div>
          <input id="wVideojuegos" type="range" min="0" max="5" step="1" value="1">
        </label>

        <!-- Mitolog√≠a & Folclore -->
        <label style="width:100%">
          <div class="inline" style="justify-content:space-between">
            <span class="muted">Mitolog√≠a & Folclore</span>
            <span class="kbd" id="wMitoVal">1</span>
          </div>
          <input id="wMito" type="range" min="0" max="5" step="1" value="1">
        </label>

        <!-- Animales -->
        <label style="width:100%">
          <div class="inline" style="justify-content:space-between">
            <span class="muted">Animales</span>
            <span class="kbd" id="wAnimalesVal">1</span>
          </div>
          <input id="wAnimales" type="range" min="0" max="5" step="1" value="1">
        </label>

        <!-- Arquetipos -->
        <label style="width:100%">
          <div class="inline" style="justify-content:space-between">
            <span class="muted">Arquetipos</span>
            <span class="kbd" id="wArquetiposVal">1</span>
          </div>
          <input id="wArquetipos" type="range" min="0" max="5" step="1" value="1">
        </label>

        <!-- Famosos -->
        <label style="width:100%">
          <div class="inline" style="justify-content:space-between">
            <span class="muted">Famosos</span>
            <span class="kbd" id="wFamososVal">1</span>
          </div>
          <input id="wFamosos" type="range" min="0" max="5" step="1" value="1">
        </label>

        <!-- Otros -->
        <label style="width:100%">
          <div class="inline" style="justify-content:space-between">
            <span class="muted">Otros</span>
            <span class="kbd" id="wOtrosVal">1</span>
          </div>
          <input id="wOtros" type="range" min="0" max="5" step="1" value="1">
        </label>

        <!-- Simulador -->
        <div class="inline" style="width:100%; justify-content:space-between; margin-top:10px">
          <div class="inline">
            <button class="btn" id="btnResetWeights" title="Restablecer a 1">Reset</button>
            <button class="btn" id="btnSimDist" title="Simular 2,000 picks seg√∫n los pesos">Test</button>
          </div>
          <span class="muted" id="simDistResult">‚Äî</span>
        </div>
      </div>
    </section>
  </div>

  <main class="container" style="padding-top:18px">
    <!-- Controles admin -->
    <section class="card" id="adminControls">
      <div class="controlsGrid" style="display:grid; gap:10px">
        <!-- Fila 1: botones principales -->
        <div class="inline">
          <button class="btn" id="btnP"><span class="letter-p">P</span></button>
          <button class="btn" id="btnFusion"><span class="letter-p">P</span> + <span class="letter-p">P</span></button>
          <button class="btn" id="btnDoble">x2</button>
          <button class="btn" id="btnTriple">x3</button>
          <button class="btn" id="btnReto">RETO</button>
          <button class="btn" id="btnEvento">EVENTO</button>
          <button class="btn" id="btnEscena">ESCENA</button>
          <button class="btn" id="btnSecreto">SECRETO</button>
          <button class="btn" id="btnMasterpiece">OBRA MAESTRA</button>
          <button
            class="btn btn-chip"
            id="btnToggleAdv"
            aria-expanded="false"
            title="Mostrar/ocultar opciones avanzadas"
          >
            M√°s opciones <span class="chev">‚ñæ</span>
          </button>
          <button class="btn" id="btnFilters" title="Ajustar pesos por categor√≠a">Filtros</button>
        </div>

        <!-- Fila 2 (plegable): opciones avanzadas -->
        <div class="inline" id="advRow" style="display:none; margin-top:6px">
          <button class="btn" id="btnPV"><span class="letter-p">P</span> + <span class="letter-v">V</span></button>
          <button class="btn" id="btnPA"><span class="letter-p">P</span> + <span class="letter-a">A</span></button>
          <button class="btn" id="btnPL"><span class="letter-p">P</span> + <span class="letter-l">L</span></button>
          <button class="btn" id="btnPVA"><span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-a">A</span></button>
          <button class="btn" id="btnPAL"><span class="letter-p">P</span> + <span class="letter-a">A</span> + <span class="letter-l">L</span></button>
          <button class="btn" id="btnPVL"><span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-l">L</span></button>
          <button class="btn" id="btnPVAL"><span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-a">A</span> + <span class="letter-l">L</span></button>
        </div>
      </div>
    </section>

    <!-- Enunciado -->
    <section class="card" style="margin-top:14px">
      <div class="title" style="align-items:center">
        <span>Enunciado a dibujar</span>
        <div class="inline">
          <button class="btn" id="btnClearOutput" title="Limpiar enunciado mostrado">Limpiar</button>
        </div>
      </div>
      <div id="salida" class="out" style="margin-top:10px; white-space:pre-wrap"></div>
      <div id="challengeNote" class="challengeNote" style="margin-top:8px"></div>
      <div id="testlog" class="muted" style="margin-top:10px"></div>
    </section>

    <!-- Jugadores conectados -->
    <section class="card" id="playersCard" style="margin-top:10px; display:none">
      <div class="players-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
        <span id="playersTitle" style="font-size:1rem; font-weight:500; color:#9ca3af">Jugadores conectados</span>
        <div class="players-title-actions">
          <button class="btn" id="btnGrupos" title="Formar parejas asignando Grupo A, B, C‚Ä¶">Generar grupos</button>
        </div>
      </div>
      <div id="playersList" class="players-wrap" style="margin-top:6px"></div>
    </section>
  </main>

  <footer>
    <div id="footerBtns">
      <button class="btn" id="btnCopiar">Copiar</button>
      <button class="btn" id="btnTest">Test</button>
    </div>

    <div id="timerWrap" class="inline" style="margin-top:10px; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap">
      <select id="timerSelect" class="btn" style="padding:8px 10px">
        <option value="30">30s</option>
        <option value="60">60s</option>
        <option value="90">90s</option>
        <option value="120">120s</option>
      </select>

      <!-- El reloj AHORA es el bot√≥n -->
      <button
        id="timerDisplay"
        class="kbd"
        type="button"
        aria-label="Iniciar o cancelar temporizador"
        title="Iniciar / Cancelar"
      >Iniciar</button>
    </div>

    <div class="copyright">¬© 2025 Tabja Games</div>
  </footer>

  <!-- Toast -->
  <div id="toast"></div>

  <script>
    /* === Generadores locales (refactor sin cambios de l√≥gica/UX) === */

/* ---------- 1) Datos base ---------- */
const PERSONAJES = [
  // ==== Originales ====
  "Goku","Vegeta","Piccolo","Freezer","Monkey D. Luffy","Roronoa Zoro","Sanji","Nami",
  "Naruto Uzumaki","Sasuke Uchiha","Kakashi Hatake","Ichigo Kurusaki","Satoru Gojo","Eren Yeager","Levi Ackerman",
  "Shigeo Kageyama","Saitama","Edward Elric","Tanjiro Kamado","Nezuko Kamado","Kenshin Himura","Joseph Joestar",
  "Guts","Ash Ketchum","Yugi Muto","Bob Esponja","Patricio Estrella","Calamardo","Arnold Shortman","Aang",
  "Timmy Turner","Jimmy Neutron","Johnny Bravo","Mojo Jojo","Perry El Ornitorrinco","Optimus Prime","Mickey Mouse",
  "Bugs Bunny","El Pato Donald","Felix El Gato","Winnie-the-Pooh","Charlie Brown","Snoopy","Hello Kitty",
  "Dora La Exploradora","Peppa Pig","Homero Simpson","Rick Sanchez","Morty Smith","Eric Cartman","Buzz Lightyear",
  "Mike Wazowski","Shrek","Wall-E","Stitch","Nemo","Elsa","Simba","Luke Skywalker","Darth Vader","Yoda","E.T.",
  "John Wick","Neo","Indiana Jones","El Terminator","Jack Sparrow","Borat","Charlie Chaplin","Jason Voorhees",
  "Chucky","Freddy Krueger","Jigsaw","Pennywise","Edward Scissorhands","Jack Skellington","Godzilla","El Xenomorfo",
  "Superman","Spider-Man","Batman","Wolverine","Hulk","Venom","Thor","El Joker","Albert Einstein","Messi",
  "Napole√≥n Bonaparte","Atahualpa","Hitler","Michael Jackson","Freddie Mercury","Beethoven","Pedro Castillo",
  "Donald Trump","Gandalf","Frodo Baggins","Gollum","Harry Potter","Voldemort","Willy Wonka","Cenicienta","Rapunzel",
  "Aladino","Dracula","Frankenstein","Wednesday Addams","El Jorobado de Notre Dame","James Bond",
  "Don Quijote de la Mancha","El Gato con Botas","Robin Hood","Pinnochio","Tarz√°n","Tralalero Tralal√°",
  "Brr Brr Patap√≠m","Chimpanzini Bananini","Tung Tung Tung Sahur","Bombardino Crocodilo","La Vaca Saturno Saturnita",
  "Clippy","El Chavo del Ocho","Jon Snow","Walter White","La Rana Ren√©","Pikachu","Mario","Bowser","Yoshi",
  "Donkey Kong","Kirby","Link","Zelda","Samus Aran","Sonic","Crash Bandicoot","Mega Man","Pac-Man",
  "Leon S. Kennedy","Lara Croft","El Amongus","Santa Claus","Dios","Atlas","Zeus","Poseid√≥n","H√©rcules","Pegaso",
  "El Kraken","El C√≠clope","El Minotauro","El Cerbero","El F√©nix","El Leviat√°n","El Fenrir","La Medusa","La Muerte",
  "El Yeti","El Chupacabras","Un √Ångel","Un Demonio","Un Centauro","Un G√≥lem","Un Basilisco","Un Grifo","Un Ogro",
  "Una Sirena","Una Arp√≠a","Una Hidra","Una Quimera","Un Lic√°ntropo","Un Unicornio","Una Bruja","Un Drag√≥n",
  "Una Valquiria","Un Elfo","Un Gnomo","Un Duende","Un Hada","Un Fantasma","Un Vampiro","Un Zombie","Una Momia",
  "Un Esqueleto","Un Mago", "Una Mujer","Un Hombre","Un Perro","Un Gato","Un Le√≥n","Un Mono","Una Vaca","Un Elefante","Un Caballo","Un Camello",
  "Una Jirafa","Una Oveja","Un Cerdo","Un Oso","Un Canguro","Un Conejo","Una Ardilla","Un Rat√≥n","Una Serpiente",
  "Un Cocodrilo","Una Rana","Una Ara√±a","Un Escorpi√≥n","Una Hormiga","Una Cucaracha","Un Caracol","Un Zancudo",
  "Un Pez","Un Delf√≠n","Un Tibur√≥n","Una Ballena","Una Tortuga","Un Cangrejo","Una Langosta","Un Pulpo","Un Calamar",
  "Una Malagua","Un Ping√ºino","Un Pato","Un Flamenco","Un √Åguila","Un B√∫ho","Un Murci√©lago","Un Virus","Un Dinosaurio",
  "La Salchicha","La Hamburguesa","La Pi√±a","El Pl√°tano","La Zanahoria","El Aguacate","El Huevo","La Galleta",
  "El Burrito","El Nugget","El H√©roe","El Rey","El Caballero","Un Profeta","El Verdugo","Un Viajero","Un Gladiador",
  "Un Esclavo","Un Samurai","Un Ninja","Un N√≥mada","Un Vikingo","Un Soldado","Un Buf√≥n","Un Pirata","Un Vaquero",
  "Un Le√±ador","Un Detective","Un Payaso","Un Chef","Un M√∫sico","Un Pintor","Un Carpintero","Un Cient√≠fico",
  "Un Astronauta","Un Marciano","Un Robot","Una Prostituta","Un Monje","Yo","El √Årbol","El Zapato","La Mochila",
  "El Libro","La Bomba At√≥mica","La Computadora","El Tel√©fono","El Calcet√≠n","El Mu√±eco de Nieve","Un Pok√©mon",
  "Blancanieves","Severus Snape","Sherlock Holmes","El Capit√°n Am√©rica","Peter Pan","Luigi","Barbie","Popeye",
  "El Pato Lucas","Betty Boop","Iron Man","Un Guerrero","Doomguy","El Grinch",
  "Michael Scott","Ronald McDonald","Tom Sawyer","El Jinete sin Cabeza","Quasimodo","Sailor Moon","Michael Myers",
  "Astroboy","Izuku Midoriya","Itachi Uchiha","Frieren","Fern","Yor Forger","Deadpool","Mal√©fica","Peter Griffin",
  "Danny Phantom","Groot","Knuckles","Ryu","Sephiroth","Cloud Strife","Steve","Nier","Bomberman","Diddy Kong",
  "Toad","Fox McCloud","Mewtwo","Cuphead","Agumon","Rayman","Hollow Knight","Wario","Waluigi","La Princesa Peach","2B"
];

/* ---------- 2) Categor√≠as (misma taxonom√≠a) ---------- */
// Nombres can√≥nicos reutilizables
const CATS = ['anime','caricaturas','cine','literatura','videojuegos','mito','animales','arquetipos','famosos','otros'];

// === Sets exactos ===
const CAT_ANIME = new Set([
  "Goku","Vegeta","Piccolo","Freezer","Monkey D. Luffy","Roronoa Zoro","Sanji","Nami",
  "Naruto Uzumaki","Sasuke Uchiha","Kakashi Hatake","Ichigo Kurusaki","Satoru Gojo",
  "Eren Yeager","Levi Ackerman","Shigeo Kageyama","Saitama","Edward Elric",
  "Tanjiro Kamado","Nezuko Kamado","Kenshin Himura","Joseph Joestar","Guts",
  "Ash Ketchum","Yugi Muto","Agumon","Sailor Moon","Astroboy",
  "Izuku Midoriya","Itachi Uchiha","Frieren","Fern","Yor Forger"
]);
const CAT_CARICATURAS = new Set([
  "Bob Esponja","Patricio Estrella","Calamardo","Arnold Shortman","Aang","Timmy Turner","Jimmy Neutron",
  "Johnny Bravo","Mojo Jojo","Perry El Ornitorrinco","Optimus Prime","Mickey Mouse",
  "Bugs Bunny","El Pato Donald","Felix El Gato","Winnie-the-Pooh","Charlie Brown",
  "Snoopy","Hello Kitty","Dora La Exploradora","Peppa Pig","Homero Simpson","Rick Sanchez",
  "Morty Smith","Eric Cartman","Buzz Lightyear","Popeye","El Pato Lucas","Betty Boop",
  "Danny Phantom"
]);
const CAT_CINE = new Set([
  "Mike Wazowski","Shrek","Wall-E","Stitch","Nemo","Elsa","Simba","Luke Skywalker",
  "Darth Vader","Yoda","E.T.","John Wick","Neo","Indiana Jones","El Terminator",
  "Jack Sparrow","Borat","Jason Voorhees","Chucky","Freddy Krueger","Jigsaw",
  "Edward Scissorhands","Jack Skellington","Godzilla","El Xenomorfo","El Chavo del Ocho",
  "Walter White","La Rana Ren√©","Cenicienta","Rapunzel","Aladino","Wednesday Addams",
  "Superman","Spider-Man","Batman","Wolverine","Hulk","Venom","Thor","El Joker",
  "El Capit√°n Am√©rica","Peter Pan","Blancanieves","Barbie","Iron Man","Mal√©fica",
  "Peter Griffin","El Grinch","Michael Scott","Michael Myers","Groot","Deadpool"
]);
const CAT_LITERATURA = new Set([
  "Gandalf","Frodo Baggins","Gollum","Harry Potter","Voldemort","Willy Wonka","Dracula",
  "Frankenstein","James Bond","El Gato con Botas","Robin Hood","Pinnochio","Tarz√°n",
  "Pennywise","Jon Snow","Severus Snape","Sherlock Holmes","Quasimodo",
  "Don Quijote de la Mancha","Tom Sawyer","El Jinete sin Cabeza"
]);
const CAT_VIDEOJUEGOS = new Set([
  "Pikachu","Mewtwo","Mario","Bowser","Yoshi","Donkey Kong","Kirby","Link","Zelda",
  "Samus Aran","Sonic","Crash Bandicoot","Mega Man","Pac-Man","Leon S. Kennedy",
  "Lara Croft","Knuckles","Ryu","Sephiroth","Cloud Strife","Steve","Nier","Bomberman",
  "Diddy Kong","Toad","Fox McCloud","Cuphead","Rayman","Hollow Knight","Wario","Waluigi",
  "Luigi","La Princesa Peach","2B","Doomguy","El Amongus"
]);
const CAT_MITO = new Set([
  "Santa Claus","Dios","Atlas","Zeus","Poseid√≥n","H√©rcules","Pegaso",
  "El Kraken","El C√≠clope","El Minotauro","El Cerbero","El F√©nix","El Leviat√°n",
  "El Fenrir","La Medusa","La Muerte","El Yeti","El Chupacabras","Un √Ångel","Un Demonio",
  "Un Centauro","Un G√≥lem","Un Basilisco","Un Grifo","Un Ogro","Una Sirena","Una Arp√≠a",
  "Una Hidra","Una Quimera","Un Lic√°ntropo","Un Unicornio","Una Bruja","Un Drag√≥n",
  "Una Valquiria","Un Elfo","Un Gnomo","Un Duende","Un Hada","Un Fantasma","Un Vampiro",
  "Un Zombie","Una Momia","Un Esqueleto","Un Mago","Un Marciano"
]);
const CAT_ANIMALES = new Set([
  "Una Mujer","Un Hombre","Un Perro","Un Gato","Un Le√≥n","Un Mono","Una Vaca",
  "Un Elefante","Un Caballo","Un Camello","Una Jirafa","Una Oveja","Un Cerdo","Un Oso",
  "Un Canguro","Un Conejo","Una Ardilla","Un Rat√≥n","Una Serpiente","Un Cocodrilo",
  "Una Rana","Una Ara√±a","Un Escorpi√≥n","Una Hormiga","Una Cucaracha","Un Caracol",
  "Un Zancudo","Un Pez","Un Delf√≠n","Un Tibur√≥n","Una Ballena","Una Tortuga","Un Cangrejo",
  "Una Langosta","Un Pulpo","Un Calamar","Una Malagua","Un Ping√ºino","Un Pato",
  "Un Flamenco","Un √Åguila","Un B√∫ho","Un Murci√©lago","Un Virus","Un Dinosaurio"
]);
const CAT_ARQUETIPOS = new Set([
  "El H√©roe","El Rey","El Caballero","Un Profeta","El Verdugo","Un Viajero","Un Gladiador",
  "Un Esclavo","Un Samurai","Un Ninja","Un N√≥mada","Un Vikingo","Un Soldado","Un Buf√≥n",
  "Un Pirata","Un Vaquero","Un Le√±ador","Un Detective","Un Carpintero","Un Robot",
  "Un Payaso","Un Chef","Un M√∫sico","Un Pintor","Una Prostituta","Un Monje",
  "Un Cient√≠fico","Un Astronauta","Un Guerrero","Yo"
]);
const CAT_FAMOSOS = new Set([
  "Albert Einstein","Messi","Napole√≥n Bonaparte","Atahualpa","Hitler","Michael Jackson",
  "Freddie Mercury","Beethoven","Pedro Castillo","Donald Trump","Ronald McDonald",
  "Charlie Chaplin"
]);

// Mapa categor√≠a ‚Üí Set (reduce repetici√≥n)
const CAT_MAP = {
  anime: CAT_ANIME,
  caricaturas: CAT_CARICATURAS,
  cine: CAT_CINE,
  literatura: CAT_LITERATURA,
  videojuegos: CAT_VIDEOJUEGOS,
  mito: CAT_MITO,
  animales: CAT_ANIMALES,
  arquetipos: CAT_ARQUETIPOS,
  famosos: CAT_FAMOSOS
};

/* ---------- 3) Buckets y utilidades de categor√≠a ---------- */
const BUCKETS = Object.fromEntries(CATS.map(c => [c, []]));

for (const name of PERSONAJES) {
  let cat = 'otros';
  for (const [key, set] of Object.entries(CAT_MAP)) {
    if (set.has(name)) { cat = key; break; }
  }
  BUCKETS[cat].push(name);
}

function categoriaDe(nombre){
  for (const [key, set] of Object.entries(CAT_MAP)) {
    if (set.has(nombre)) return key;
  }
  return 'otros';
}

/* ---------- 4) Pesos con persistencia ---------- */
const DEFAULT_WEIGHTS = Object.fromEntries(CATS.map(c => [c, 1]));

let WEIGHTS = (() => {
  try {
    const saved = JSON.parse(localStorage.getItem('am_weights')) || {};
    return { ...DEFAULT_WEIGHTS, ...saved };
  } catch { return { ...DEFAULT_WEIGHTS }; }
})();

function setWeight(cat, val){
  WEIGHTS[cat] = Math.max(0, Number(val) || 0);
  try { localStorage.setItem('am_weights', JSON.stringify(WEIGHTS)); } catch {}
}
function getWeight(cat){ return Number(WEIGHTS[cat] ?? 1); }

/* ---------- 5) RNG / helpers ---------- */
const byId = id => document.getElementById(id);
function mulberry32(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t>>>15), t|1);
    t ^= t + Math.imul(t ^ (t>>>7), t|61);
    return ((t ^ (t>>>14)) >>> 0) / 4294967296;
  };
}
function rng(seed){
  if (!seed) return Math.random;
  let n = 0;
  for (let i=0;i<seed.length;i++) n = (n*31 + seed.charCodeAt(i)) >>> 0;
  return mulberry32(n);
}
const pick = (arr, R) => arr[Math.floor(R() * arr.length)];
const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

const wrapChar  = name => `<span class="char">${esc(name)}</span>`;
const wrapVerb  = v    => `<span class="verb">${esc(v)}</span>`;
const wrapAdj   = a    => `<span class="adj">${esc(a)}</span>`;
const wrapPlace = l    => `<span class="place">${esc(l)}</span>`;
const wrapEvent = e    => `<span class="event">${esc(e)}</span>`;
const wrapScene = s    => `<span class="scene">${esc(s)}</span>`;

/* ---------- 6) Elecci√≥n ponderada ---------- */
function pickCategoryByWeight(R){
  const alive = CATS.filter(c => BUCKETS[c].length > 0);
  let total = 0;
  const cum = [];
  for (const c of alive){ total += Math.max(0, getWeight(c)); cum.push(total); }
  if (total <= 0) return alive[Math.floor(R()*alive.length)];
  const t = R()*total;
  for (let i=0;i<cum.length;i++){ if (t < cum[i]) return alive[i]; }
  return alive[alive.length-1];
}

function pickPersonaje(R){
  const cat = pickCategoryByWeight(R);
  const arr = BUCKETS[cat];
  if (!arr || arr.length === 0) return PERSONAJES[Math.floor(R()*PERSONAJES.length)];
  return arr[Math.floor(R()*arr.length)];
}

// export helpers
window.pickPersonaje = pickPersonaje;
window.setWeight     = setWeight;
window.getWeight     = getWeight;

/* ---------- 7) UI de pesos ---------- */
function setSliderVal(idSlider, idBadge, v){
  const s = byId(idSlider), b = byId(idBadge);
  if (s) s.value = v;
  if (b) b.textContent = String(v);
}

// Habilitar/deshabilitar sliders (seg√∫n rol)
window.setWeightsEnabled = function setWeightsEnabled(on){
  const ids = ['wAnime','wCaricaturas','wCine','wLiteratura','wVideojuegos','wMito','wAnimales','wArquetipos','wFamosos','wOtros'];
  ids.forEach(id=>{
    const el = byId(id);
    if (!el) return;
    el.disabled = !on;
    el.style.opacity = on ? '' : '0.6';
    el.style.pointerEvents = on ? '' : 'none';
  });
};

function initWeightSliders(){
  // Cargar valores
  setSliderVal('wAnime','wAnimeVal',              getWeight('anime'));
  setSliderVal('wCaricaturas','wCaricaturasVal',  getWeight('caricaturas'));
  setSliderVal('wCine','wCineVal',                getWeight('cine'));
  setSliderVal('wLiteratura','wLiteraturaVal',    getWeight('literatura'));
  setSliderVal('wVideojuegos','wVideojuegosVal',  getWeight('videojuegos'));
  setSliderVal('wMito','wMitoVal',                getWeight('mito'));
  setSliderVal('wAnimales','wAnimalesVal',        getWeight('animales'));
  setSliderVal('wArquetipos','wArquetiposVal',    getWeight('arquetipos'));
  setSliderVal('wFamosos','wFamososVal',          getWeight('famosos'));
  setSliderVal('wOtros','wOtrosVal',              getWeight('otros'));

  // Helper para ‚Äúinput‚Äù
  const hook = (idSlider, idBadge, cat)=>{
    const s = byId(idSlider);
    if(!s) return;
    s.addEventListener('input', async ()=>{
      const v = parseInt(s.value,10);
      setWeight(cat, v);
      const b = byId(idBadge);
      if (b) b.textContent = String(v);

      // Publicar a Firebase si corresponde
      if (window.lobbyCode && window.isHost && window.db && window.fbRef && window.fbUpdate) {
        try {
          const path = `lobbies/${window.lobbyCode}/weights`;
          await window.fbUpdate(window.fbRef(window.db, path), { ...WEIGHTS });
          if (window.showToast) window.showToast('Pesos guardados');
        } catch (e) { console.warn('No se pudieron publicar los pesos:', e); }
      }
    });
  };

  // Hooks
  hook('wAnime','wAnimeVal','anime');
  hook('wCaricaturas','wCaricaturasVal','caricaturas');
  hook('wCine','wCineVal','cine');
  hook('wLiteratura','wLiteraturaVal','literatura');
  hook('wVideojuegos','wVideojuegosVal','videojuegos');
  hook('wMito','wMitoVal','mito');
  hook('wAnimales','wAnimalesVal','animales');
  hook('wArquetipos','wArquetiposVal','arquetipos');
  hook('wFamosos','wFamososVal','famosos');
  hook('wOtros','wOtrosVal','otros');

  // Reset
  const btnReset = byId('btnResetWeights');
  if(btnReset){
    btnReset.addEventListener('click', async ()=>{
      CATS.forEach(cat => setWeight(cat, 1));
      initWeightSliders();

      if (window.lobbyCode && window.isHost && window.db && window.fbRef && window.fbUpdate) {
        try{
          const path = `lobbies/${window.lobbyCode}/weights`;
          await window.fbUpdate(window.fbRef(window.db, path), { ...WEIGHTS });
          if (window.showToast) window.showToast('Pesos restablecidos (sala)');
        }catch(e){ console.warn('No se pudieron publicar los pesos (reset):', e); }
      } else {
        if (window.showToast) window.showToast('Pesos restablecidos');
      }
    });
  }
}

// Inicializaci√≥n (una sola vez)
document.addEventListener('DOMContentLoaded', initWeightSliders);

/* ---------- 8) Simulador de distribuci√≥n ---------- */
function simularDistribucion(n=2000){
  const R = rng('sim-'+Date.now());
  const tally = Object.fromEntries(CATS.map(c => [c, 0]));
  for(let i=0;i<n;i++){
    const p = pickPersonaje(R);
    tally[categoriaDe(p)]++;
  }
  const pct = Object.fromEntries(Object.entries(tally).map(([k,v])=> [k, Math.round(v*100/n)]));
  return { tally, pct, n };
}
function attachSimBtn(){
  const btn = byId('btnSimDist');
  const out = byId('simDistResult');
  if(!btn || !out) return;
  btn.addEventListener('click', ()=>{
    const { pct, n } = simularDistribucion(2000);
    out.textContent =
      `Anime ${pct.anime}% ‚Ä¢ Caricaturas ${pct.caricaturas}% ‚Ä¢ Cine ${pct.cine}% ‚Ä¢ Literatura ${pct.literatura}% ‚Ä¢ `+
      `Videojuegos ${pct.videojuegos}% ‚Ä¢ Mitolog√≠a & Folclore ${pct.mito}% ‚Ä¢ Animales ${pct.animales}% ‚Ä¢ `+
      `Arquetipos ${pct.arquetipos}% ‚Ä¢ Famosos ${pct.famosos}% ‚Ä¢ Otros ${pct.otros}% (n=${n})`;
    if(window.showToast) window.showToast('Simulaci√≥n lista');
  });
}
attachSimBtn();

/* ---------- 9) Generadores de enunciados ---------- */
const VERBOS=['leyendo','patinando','esquiando','surfeando','navegando','cabalgando','pedaleando','nadando','bailando','pescando','regando','componiendo','escribiendo','cocinando','conduciendo','cenando','trabajando','jugando','barriendo','corriendo','caminando','saltando','trepando','luchando','descansando','durmiendo','marchando','volando','bebiendo','fumando','vomitando','masturbando','orinando','cagando','copulando','muriendo','naciendo','pariendo','gritando','llorando','cantando','pensando','rezando','vendiendo','saludando','boxeando'];
const ADJETIVOS=['content@','enojad@','asustad@','preocupad@','desnud@','cansad@','confundid@','excitad@','aburrid@','sorprendid@','doblad@','sentad@','parad@','arrodillad@','echad@','suspendid@','tembland@','derretid@','herid@','atad@','enamorad@','relajad@','borrach@','nervios@','enferm@','descalz@','tens@'];
const LUGARES=['bajo el agua','bajo el sol','bajo la luna','bajo la lluvia','bajo la tierra','bajo las estrellas','bajo un √°rbol','bajo un puente','sobre un tren','sobre una torre','sobre una cama','sobre una mesa','sobre un techo','sobre las nubes','tras los arbustos','tras una roca','tras la ventana','tras las rejas','en el campo','en el mar','en el espacio','en el futuro','en el pasado','en el infierno','en el cielo','en la ciudad','en la monta√±a','en la playa','en la selva','en el Valhalla','en el Olimpo','en la corte','en el fin del mundo','en la prehistoria','en un ba√±o','en un bosque','en un colegio','en un desierto','en un gimnasio','en un zool√≥gico','en un pantano','en una tormenta','en una oficina','en un bar','en un hospital','en un cementerio','en un parque','en un balc√≥n','en una granja','en un teatro','en una biblioteca','en un cine','en un avi√≥n','en un helic√≥ptero','en un cohete','en un castillo','en un mercado','en una pradera','en un globo','en un burdel','en un laboratorio','en una prisi√≥n','en un jard√≠n','en Egipto','en Francia','en Jap√≥n','en Per√∫','en Australia','en la Ant√°rtida','en su casa','en su habitaci√≥n'];
const EVENTOS=['El nacimiento de','La muerte de','La creaci√≥n de','La destrucci√≥n de','La victoria de','La derrota de','El sacrificio de','La furia de','La ca√≠da de','El sue√±o de','El regreso de','La invasi√≥n de','El ritual de','La persecuci√≥n de','La evoluci√≥n de','Los ojos de','El beso de','El rapto de','La danza de','La casa de','La habitaci√≥n de','El ba√±o de','Retrato de','La venganza de','La tortura de','El castigo de','La traici√≥n de','La ejecuci√≥n de','El asesinato de','La rebeli√≥n de','El entierro de','La confesi√≥n de','El cumplea√±os de','El concierto de','El bautizo de','El Baby Shower de','La aventura de'];
const ESCENAS=['Guerra','Paz','Caos','Orden','Odio','Amor','Soledad','Invierno','Verano','Oto√±o','Primavera','Amanecer','Atardecer','Anochecer','Terror','Incendio','Duelo','Batalla','Matrimonio','Despedida','Bienvenida','Encuentro','Apocalipsis','Tragedia','Desastre','Cat√°strofe','Exterminio','Masacre','Tratado','Barbacoa','Picnic','Banquete','Fiesta','Excursi√≥n','Olimpiadas','Carnaval','Desfile','Venganza','Tortura','Castigo','Traici√≥n','Ejecuci√≥n','Asesinato','Revoluci√≥n','Funeral','Confesi√≥n','Cumplea√±os','Concierto','Bautizo','Baby Shower','Aventura'];

function genPVAL(R){const p=pickPersonaje(R),v=pick(VERBOS,R),a=pick(ADJETIVOS,R),l=pick(LUGARES,R);return{ text:`${p} ${v} ${a} ${l}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapAdj(a)} ${wrapPlace(l)}` }}
function genPV(R){const p=pickPersonaje(R),v=pick(VERBOS,R);return{ text:`${p} ${v}`, html:`${wrapChar(p)} ${wrapVerb(v)}` }}
function genPA(R){const p=pickPersonaje(R),a=pick(ADJETIVOS,R);return{ text:`${p} ${a}`, html:`${wrapChar(p)} ${wrapAdj(a)}` }}
function genPL(R){const p=pickPersonaje(R),l=pick(LUGARES,R);return{ text:`${p} ${l}`, html:`${wrapChar(p)} ${wrapPlace(l)}` }}
function genPAL(R){const p=pickPersonaje(R),a=pick(ADJETIVOS,R),l=pick(LUGARES,R);return{ text:`${p} ${a} ${l}`, html:`${wrapChar(p)} ${wrapAdj(a)} ${wrapPlace(l)}` }}
function genPVA(R){const p=pickPersonaje(R),v=pick(VERBOS,R),a=pick(ADJETIVOS,R);return{ text:`${p} ${v} ${a}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapAdj(a)}` }}
function genPVL(R){const p=pickPersonaje(R),v=pick(VERBOS,R),l=pick(LUGARES,R);return{ text:`${p} ${v} ${l}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapPlace(l)}` }}
function genFusion(R){
  let p1 = pickPersonaje(R), p2;
  do{ p2 = pickPersonaje(R); }while(p2 === p1);
  return { text:`${p1} + ${p2}`, html:`${wrapChar(p1)} + ${wrapChar(p2)}` }
}
function genP(R){const p=pickPersonaje(R);return{ text:`${p}`, html:`${wrapChar(p)}` }}
function genEvento(R){const e=pick(EVENTOS,R),p=pickPersonaje(R);return{ text:`${e} ${p}`, html:`${wrapEvent(e)} ${wrapChar(p)}` }}
function genEscena(R){const s=pick(ESCENAS,R),l=pick(LUGARES,R);return{ text:`${s} ${l}`, html:`${wrapScene(s)} ${wrapPlace(l)}` }}

/* ---------- 10) Interacci√≥n UI b√°sica ---------- */
let lastCopyText = '';

function generarUno(mode){
  const R = rng();
  switch(mode){
    case 'PV':     return genPV(R);
    case 'PA':     return genPA(R);
    case 'PL':     return genPL(R);
    case 'PAL':    return genPAL(R);
    case 'PVA':    return genPVA(R);
    case 'PVL':    return genPVL(R);
    case 'FUSION': return genFusion(R);
    case 'P':      return genP(R);
    case 'EVENTO': return genEvento(R);
    case 'ESCENA': return genEscena(R);
    default:       return genPVAL(R);
  }
}

function generarN(mode,n){
  const R = rng();
  const gens = { PVAL:genPVAL, PV:genPV, PA:genPA, PL:genPL, PAL:genPAL, PVA:genPVA, PVL:genPVL, FUSION:genFusion, P:genP, EVENTO:genEvento, ESCENA:genEscena };
  const fn = gens[mode] || genPVAL;
  const out = Array.from({length:n}, () => fn(R));
  byId('salida').innerHTML = out.map(o => o.html).join('<br>');
  lastCopyText = out.map(o => o.text).join('\n');
}

// Toast + sonidos (misma mec√°nica)
const toastEl = byId('toast');
let toastTimer = null, __uiAudioCtx; // __uiAudioCtx reservado (compatibilidad)
function showToast(msg){
  if(!toastEl) return;
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 2200);
}
function playClick(){
  try{
    const a = window.sndButton || new Audio('sfx/button_press.mp3');
    a.currentTime = 0;
    const p = a.play();
    if (p && p.catch) p.catch(()=>{});
  }catch{}
}
// captura en fase de captura para que siempre suene
(()=>{ document.querySelectorAll('button').forEach(b => b.addEventListener('click', playClick, {capture:true})); })();

// Bot√≥n Copiar
byId('btnCopiar').onclick = async ()=>{
  if(!lastCopyText) return;
  await navigator.clipboard.writeText(lastCopyText);
};

// Bot√≥n Test
byId('btnTest').onclick = ()=>{
  const modes=['PVAL','PV','PA','PL','PAL','PVA','PVL','FUSION','P','EVENTO','ESCENA'];
  let report='Pruebas:';
  for(const m of modes){
    let ok=0,total=100;
    for(let i=0;i<total;i++){
      const {text,html}=generarUno(m);
      if(typeof text==='string'&&text.length>0&&typeof html==='string'&&html.length>0) ok++;
    }
    report+=`\n‚Ä¢ ${m}: ${ok}/${total} generados correctamente`;
  }
  byId('testlog').textContent = report;
};

// Atajos de teclado (igual que antes)
document.addEventListener('keydown',e=>{
  if((e.metaKey||e.ctrlKey)){
    if(e.key==='1'){e.preventDefault();generarN('PVAL',1);} 
    if(e.key==='2'){e.preventDefault();generarN('PV',1);}   
    if(e.key==='3'){e.preventDefault();generarN('PA',1);}   
    if(e.key==='4'){e.preventDefault();generarN('PL',1);}   
    if(e.key==='5'){e.preventDefault();generarN('FUSION',1);} 
    if(e.key==='6'){e.preventDefault();generarN('P',1);}    
  }
});

// Primer enunciado
generarN('PVAL',1);

  </script>

<!-- üî• Firebase Realtime (grupos, colores, score y generaci√≥n por grupo) -->
<script type="module">
  /* ===========================
     0) Firebase SDK & Setup
  ============================*/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getDatabase, ref, onValue, set, update, onDisconnect, push, get, off, remove
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAHEBnKMHJt9npV6NeHzSjWdJtBE9EUmwQ",
    authDomain: "arte-moderno-5ff8a.firebaseapp.com",
    projectId: "arte-moderno-5ff8a",
    storageBucket: "arte-moderno-5ff8a.firebasestorage.app",
    messagingSenderId: "478321511301",
    appId: "1:478321511301:web:6b46294944397c0ce952ec",
    measurementId: "G-BP2SKW1881"
  };

  const appFB = initializeApp(firebaseConfig);
  const db = getDatabase(appFB);

  // Exponer Firebase helpers para el script no-module
  window.db = db;
  window.fbRef = ref;
  window.fbUpdate = update;

  /* ===========================
     1) Audio / SFX
  ============================*/
  // RNG del m√≥dulo anterior
  const rng = window.rng;

  // Temporizador
  const sndBeep  = new Audio('sfx/timer_beep.mp3');   // beep (10s restantes)
  const sndAlarm = new Audio('sfx/timer_alarm.mp3');  // alarma al llegar a 0
  sndBeep.preload  = 'auto';  sndBeep.volume  = 0.7;
  sndAlarm.preload = 'auto';  sndAlarm.volume = 1.0;

  // Bot√≥n
  const sndButton = new Audio('sfx/button_press.mp3');
  sndButton.preload = 'auto';
  sndButton.volume  = 0.8;
  window.sndButton  = sndButton;

  function stopBeep(){
    try { sndBeep.pause(); sndBeep.currentTime = 0; } catch {}
  }

  /* ===========================
     2) Estado global de Lobby
  ============================*/
  const $ = (id)=> document.getElementById(id);
  const statusEl     = "lobbyStatus" in window ? window.lobbyStatus : $('lobbyStatus');
  const badgeEl      = $('roomBadge');
  const overlayEl    = $('lobbyOverlay');
  const leaveRow     = $('leaveRow');
  const playersCard  = $('playersCard');
  const playersList  = $('playersList');
  const btnGrupos    = $('btnGrupos');
  const clearBtn     = $('btnClearOutput');
  const adminControls= $('adminControls');

  const choiceRow     = $('choiceRow');
  const joinRow       = $('joinRow');
  const btnChooseJoin = $('btnChooseJoin');
  const btnBackJoin   = $('btnBackJoin');

  const timerSelect  = $('timerSelect');
  const timerDisplay = $('timerDisplay');

  let lobbyCode = null;
  let isHost = false;
  window.lobbyCode = lobbyCode;
  window.isHost    = isHost;

  let prevIsHost = false;
  let playersConnected = 0;
  let currentConnRef = null;
  let lobbyRef = null;
  let lobbyCallback = null;
  let lastLobbyState = null;

  const LS_CODE_KEY = "am_lobby_code";

  // ID de cliente
  function getClientId(){
    const k="am_client_id";
    let id=localStorage.getItem(k);
    if(!id){ id = Math.random().toString(36).slice(2); localStorage.setItem(k,id); }
    return id;
  }
  const clientId = getClientId();

  /* ===========================
     3) Filtros (overlay)
  ============================*/
  const filtersOverlay  = $('filtersOverlay');
  const btnFilters      = $('btnFilters');
  const btnCloseFilters = $('btnCloseFilters');

  // Guard: abrir solo si eres host en sala o si est√°s en modo local
  function canControlWeights(){ return (!lobbyCode || isHost); }

  function openFilters(){
    if(!canControlWeights()){
      if(window.showToast) window.showToast('Solo el ADMIN puede abrir Filtros en sala');
      return;
    }
    filtersOverlay?.classList.add('open');
    if (typeof window.initWeightSliders === 'function') window.initWeightSliders();
  }
  function closeFilters(){ filtersOverlay?.classList.remove('open'); }

  btnFilters?.addEventListener('click', openFilters);
  btnCloseFilters?.addEventListener('click', closeFilters);

  // Esc para cerrar
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && filtersOverlay?.classList.contains('open')) closeFilters();
  });

  // Cerrar clic ‚Äúfuera‚Äù
  let mouseDownInside = false;
  filtersOverlay?.addEventListener('mousedown', (e)=>{
    mouseDownInside = !e.target.classList.contains('card') && e.target === filtersOverlay;
  });
  filtersOverlay?.addEventListener('mouseup', (e)=>{
    if(mouseDownInside && e.target === filtersOverlay) closeFilters();
    mouseDownInside = false;
  });

  /* ===========================
     4) UI: Join/Leave / Badge
  ============================*/
  function setLobbyCode(code){
    lobbyCode = code;
    localStorage.setItem(LS_CODE_KEY, code);
    badgeEl.style.display='inline-block'; badgeEl.textContent = `Sala: ${code}`;
    leaveRow.style.display='flex';
    overlayEl.style.display='none';
    playersCard.style.display='block';
    window.lobbyCode = lobbyCode;
  }
  function clearLobbyCode(){
    lobbyCode = null;
    localStorage.removeItem(LS_CODE_KEY);
    badgeEl.style.display='none'; badgeEl.textContent = 'Sala: -----';
    leaveRow.style.display='none';
    overlayEl.style.display='flex';
    playersCard.style.display='none';
    lastLobbyState = null;
    window.lobbyCode = lobbyCode;
  }

  let joinMode = false;
  function setJoinMode(on){
    joinMode = !!on;
    if (choiceRow) choiceRow.style.display = on ? "none" : "flex";
    if (joinRow)   joinRow.style.display   = on ? "flex" : "none";
    if (!on) {
      const input = $('lobbyCodeInput');
      if (input) input.value = "";
      if (statusEl) statusEl.textContent = "";
    }
  }

  /* ===========================
     5) Presencia por pesta√±a
  ============================*/
  function setupPresence(code){
    if (!code) return;
    if (currentConnRef) { try { onDisconnect(currentConnRef).cancel(); } catch {} currentConnRef = null; }

    const infoRef = ref(db, ".info/connected");
    onValue(infoRef, (snap)=>{
      if (snap.val() === true) {
        const connRef = push(ref(db, `lobbies/${code}/players/${clientId}/connections`));
        currentConnRef = connRef;
        set(connRef, true);
        onDisconnect(connRef).remove();
        update(ref(db, `lobbies/${code}/players/${clientId}`), { connected: true });
      }
    });
  }

  /* ===========================
     6) Host UI / Controles
  ============================*/
  function updateHostUI(){
    const inLobby = !!lobbyCode;

    // Mostrar controles admin: solo si NO hay lobby o si eres ADMIN
    if (adminControls) adminControls.style.display = (!inLobby || isHost) ? "" : "none";
    if (clearBtn)      clearBtn.style.display      = (!inLobby || isHost) ? "" : "none";
    if (btnGrupos)     btnGrupos.style.display     = (!inLobby || isHost) ? "" : "none";

    // Select del timer solo admin en sala
    if (timerSelect) {
      timerSelect.style.display = (!inLobby || isHost) ? "" : "none";
      const disableSel = !(isHost && inLobby);
      timerSelect.disabled = disableSel;
      timerSelect.style.opacity = disableSel ? 0.5 : '';
    }

    // Display del timer siempre visible; controlable si admin o solo
    if (timerDisplay) {
      const canControlTimer = (!inLobby) ? false : (isHost || playersConnected <= 1);
      timerDisplay.style.display = "";
      timerDisplay.tabIndex = canControlTimer ? 0 : -1;
      timerDisplay.style.opacity = canControlTimer ? '' : '0.6';
      timerDisplay.style.pointerEvents = canControlTimer ? '' : 'none';
    }

    // Botones de puntaje (+/-) solo admin o solo
    const hostOrSolo = isHost || playersConnected <= 1;
    if (playersList) playersList.querySelectorAll('.scoreBtn').forEach(b => b.disabled = !hostOrSolo);

    // Plegado de ‚ÄúM√°s opciones‚Äù y bot√≥n Filtros
    const btnToggleAdv = $('btnToggleAdv');
    const advRow       = $('advRow');
    if(btnToggleAdv)  btnToggleAdv.style.display = (!inLobby || isHost) ? "" : "none";
    if(advRow){
      if(inLobby && !isHost){
        advRow.style.display = "none";
      }else{
        const pref = (localStorage.getItem("am_adv_open") === "1");
        advRow.style.display = pref ? "" : "none";
      }
    }
    const btnFiltersEl = $('btnFilters');
    if (btnFiltersEl) btnFiltersEl.style.display = (!inLobby || isHost) ? '' : 'none';

    // Si pierdes permisos y estaba abierto, ci√©rralo
    const wasOpen = filtersOverlay?.classList.contains('open');
    const stillCan = (!inLobby || isHost);
    if (wasOpen && !stillCan) closeFilters();
    upsertRerollButtons();
  }

  // Toggle de opciones avanzadas (persistencia local)
  (function initAdvPref(){
    const btnToggleAdv = $('btnToggleAdv');
    const advRow       = $('advRow');
    function setAdvOpen(open){
      if(!advRow || !btnToggleAdv) return;
      advRow.style.display = open ? "" : "none";
      btnToggleAdv.setAttribute("aria-expanded", open ? "true" : "false");
      try{ localStorage.setItem("am_adv_open", open ? "1" : "0"); }catch{}
    }
    btnToggleAdv?.addEventListener("click", ()=>{
      const open = btnToggleAdv.getAttribute("aria-expanded") !== "true";
      setAdvOpen(open);
    });
    setAdvOpen(localStorage.getItem("am_adv_open") === "1");
  })();

  updateHostUI(); // estado inicial

  /* ===========================
     7) Players UI / Score
  ============================*/
  const clampScore = (n)=> Math.max(0, Math.min(999, n|0));
  const escSafe = (s)=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  const GROUP_PALETTE = ['#60a5fa','#f472b6','#34d399','#fbbf24','#a78bfa','#fb7185','#22d3ee','#f59e0b','#4ade80','#e879f9'];
  const hexToRgb = (hex)=>{ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:{r:100,g:100,b:100}; };
  const rgba = (hex, a)=>{ const {r,g,b}=hexToRgb(hex); return `rgba(${r}, ${g}, ${b}, ${a})`; };
  const groupColor = (letter)=>{
    if(!letter) return '#64748b';
    const idx = Math.max(0, letter.charCodeAt(0) - 65);
    return GROUP_PALETTE[idx % GROUP_PALETTE.length];
  };

  function getActiveGroupsFromState(state){
    const playersObj = state?.players || {};
    return [...new Set(
      Object.values(playersObj)
        .filter(p=>p && p.connections && Object.keys(p.connections).length>0)
        .map(p=> p.group ? String(p.group).toUpperCase() : null)
        .filter(Boolean)
    )].sort();
  }

  function renderPlayers(state){
    if(!playersCard || !playersList) return;

    const playersObj = state.players || {};
    const items = Object.entries(playersObj).map(([pid,p])=>{
      const connected = !!(p && p.connections && Object.keys(p.connections).length > 0);
      return {
        id: pid,
        name: (p && p.name) || "Jugador",
        score: clampScore((p && p.score)!=null ? p.score : 0),
        group: p && p.group ? String(p.group).toUpperCase() : null,
        connected,
        isAdmin: state.hostId === pid
      };
    });

    if(items.length === 0){
      playersList.innerHTML = `<span class="muted">Nadie conectado a√∫n‚Ä¶</span>`;
    }else{
      playersList.innerHTML = items.map(x=>{
        const col = groupColor(x.group);
        const bg = rgba(col, 0.22);
        const bd = rgba(col, 0.55);
        return `
          <div class="playerChip" data-id="${x.id}" title="${escSafe(x.name)}${x.isAdmin?' ‚Ä¢ ADMIN':''}" style="--gc:${col}">
            <span class="dot" aria-label="${x.connected ? 'online' : 'offline'}" style="${x.connected ? '' : 'background:#94a3b8'}"></span>
            <span class="groupBadge" style="background:${bg};border-color:${bd}">${x.group ? `Grupo ${escSafe(x.group)}` : '‚Äî'}</span>
            <span class="name">
              ${escSafe(x.name)}
              ${x.isAdmin ? `<span class="role">ADMIN</span>` : ``}
            </span>

            <div class="scoreBox">
              <button class="scoreBtn" data-action="dec" data-id="${x.id}">‚àí</button>
              <span class="score" data-id="${x.id}">${x.score}</span>
              <button class="scoreBtn" data-action="inc" data-id="${x.id}">+</button>
            </div>
          </div>
        `;
      }).join("");
    }

    const hostOrSolo = isHost || playersConnected <= 1;
    playersList.querySelectorAll('.scoreBtn').forEach(b=> b.disabled = !hostOrSolo);
    playersCard.style.display = lobbyCode ? 'block' : 'none';
  }

  // +/- puntaje
  playersList?.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.scoreBtn');
    if(!btn) return;

    const hostOrSolo = isHost || playersConnected <= 1;
    if(!hostOrSolo) return;

    const pid = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    if(!pid || !action || !lobbyCode) return;

    try{
      const scoreEl = playersList.querySelector(`.score[data-id="${pid}"]`);
      let current = 0;
      if(scoreEl){
        current = parseInt(scoreEl.textContent,10);
        if(Number.isNaN(current)) current = 0;
      }else{
        const snap = await get(ref(db, `lobbies/${lobbyCode}/players/${pid}/score`));
        current = clampScore(snap.val() ?? 0);
      }

      const delta = action === 'inc' ? 1 : -1;
      const next = clampScore(current + delta);
      if(next === current) return;

      await update(ref(db, `lobbies/${lobbyCode}/players/${pid}`), { score: next });
    }catch(err){
      console.warn('No se pudo actualizar el score:', err);
      if(window.showToast) window.showToast('No se pudo actualizar el puntaje');
    }
  });

  /* ===========================
     8) Temporizador compartido
  ============================*/
  let timerActive   = false;
  let timerInterval = null;
  let lastBeepSecond = null;
  let alarmPlayedForTimerId = null;

  const fmt = (t)=> `${String(Math.floor(t/60)).padStart(2,'0')}:${String(t%60).padStart(2,'0')}`;
  function clearTimerInterval(){ if(timerInterval){ clearInterval(timerInterval); timerInterval=null; } }

  async function startTimer(durationSec){
    if(!lobbyCode || !(isHost || playersConnected<=1)) return;
    const startTime = Date.now();
    await update(ref(db, `lobbies/${lobbyCode}`), {
      timer: { startedAt: startTime, durationSec, canceled:false }
    });
  }
  async function cancelTimer(){
    if(!lobbyCode || !(isHost || playersConnected<=1)) return;
    await update(ref(db, `lobbies/${lobbyCode}/timer`), { canceled:true });
  }

  function handleTimerState(timer){
    clearTimerInterval();

    // Reset sonido por sesi√≥n
    lastBeepSecond = null;
    timerActive = false;

    if(!timer || timer.canceled){
      if(timerDisplay){
        timerDisplay.textContent='Iniciar';
        timerDisplay.classList.remove('running','warning');
        timerDisplay.style.color='';
      }
      try{ sndBeep.pause();  sndBeep.currentTime  = 0; }catch{}
      try{ sndAlarm.pause(); sndAlarm.currentTime = 0; }catch{}
      return;
    }

    const { startedAt, durationSec } = timer;
    if(!startedAt || !durationSec) return;
    alarmPlayedForTimerId = startedAt;

    function tick(){
      const elapsed = Math.floor((Date.now()-startedAt)/1000);
      const remain  = Math.max(0, durationSec - elapsed);

      if(timerDisplay){
        timerDisplay.textContent = fmt(remain);
        timerDisplay.classList.add('running');
        if(remain <= 10){ timerDisplay.classList.add('warning'); }
        else            { timerDisplay.classList.remove('warning'); }
      }

      timerActive = remain > 0 && !timer.canceled;

      // üéµ Sonidos
      try {
        if (remain === 10 && lastBeepSecond !== 10) {
          stopBeep();
          sndBeep.currentTime = 0;
          sndBeep.play().catch(()=>{});
          lastBeepSecond = 10;
        }
        if (remain === 0 || timer?.canceled) {
          stopBeep();
        }
        if (remain === 0 && alarmPlayedForTimerId === startedAt) {
          sndAlarm.currentTime = 0;
          sndAlarm.play().catch(()=>{});
          alarmPlayedForTimerId = null;
        }
      } catch {}

      if(remain<=0){
        clearTimerInterval();
        if(timerDisplay) timerDisplay.classList.remove('running','warning');
        if(window.showToast) window.showToast('‚è∞ ¬°Tiempo!');
      }
    }

    tick();
    timerInterval = setInterval(tick, 1000);
  }

  timerDisplay?.addEventListener('click', ()=>{
    const hostOrSolo = isHost || playersConnected <= 1;
    if(!(hostOrSolo) || !lobbyCode) return;
    if (timerActive) {
      cancelTimer();
    } else {
      const sec = parseInt(timerSelect?.value||'60',10);
      startTimer(sec);
    }
  });

  timerSelect?.addEventListener('change', ()=>{
    if(!(isHost||playersConnected<=1)||!lobbyCode) return;
    const val = parseInt(timerSelect.value,10);
    update(ref(db, `lobbies/${lobbyCode}/timer`), { durationSec: val, startedAt: Date.now(), canceled:false });
  });

  /* ===========================
     9) ‚ÄúEnunciado secreto‚Äù
  ============================*/
  let lastSecretTs = null;
  function showSecretOverlay(html, title='üïµÔ∏è Enunciado secreto'){
    const wrap = $('secretOverlay');
    const cont = $('secretContent');
    const titleEl = $('secretTitle');
    if(!wrap || !cont) return;
    cont.innerHTML = html;
    if(titleEl) titleEl.textContent = title;
    wrap.style.display = 'flex';
  }
  function hideSecretOverlay(){ const wrap = $('secretOverlay'); if(!wrap) return; wrap.style.display = 'none'; }
  $('btnSecretOK')?.addEventListener('click', async ()=>{
    hideSecretOverlay();
    try{
      if(lobbyCode){
        await update(ref(db, `lobbies/${lobbyCode}/secrets/${clientId}`), { ack: true });
      }
    }catch{}
  });

  /* ===========================
     10) Generaci√≥n por grupo
  ============================*/
  function buildGroupedOutput(mode){
    const state  = lastLobbyState;
    const groups = getActiveGroupsFromState(state);
    if(!groups || groups.length===0) return null;

    const gens = {
      PVAL: window.genPVAL, PV: window.genPV, PA: window.genPA, PL: window.genPL,
      PAL: window.genPAL, PVA: window.genPVA, PVL: window.genPVL,
      FUSION: window.genFusion, P: window.genP, EVENTO: window.genEvento, ESCENA: window.genEscena
    };
    const fn = gens[mode] || gens["PVAL"];

    const now = Date.now();
    const linesHtml = [];
    const linesText = [];

    for(const g of groups){
      const R = rng(`${lobbyCode}-${g}-${now}`);
      const { html, text } = fn(R);

      const col = groupColor(g);
      const bg = rgba(col, 0.22);
      const bd = rgba(col, 0.55);

      linesHtml.push(`<div class="lineGroup">
        <span class="gBadge" style="background:${bg};border-color:${bd}">Grupo ${g}</span>
        <span>${html}</span>
      </div>`);
      linesText.push(`Grupo ${g}: ${text}`);
    }

    return { html: linesHtml.join(""), text: linesText.join("\n") };
  }

  // 1√ó: aleatorio entre PV / PA / PL (para un enunciado)
  function genRandPVPAorPL(R){
    const modes = ['PV','PA','PL'];
    const mode  = modes[Math.floor(R()*modes.length)];
    const fns   = { PV: window.genPV, PA: window.genPA, PL: window.genPL };
    return fns[mode](R);
  }

  // Versi√≥n por grupo: PV / PA / PL aleatorio para cada grupo
  function buildGroupedOutputDouble(){
    const state  = lastLobbyState;
    const groups = getActiveGroupsFromState(state);
    if(!groups || groups.length===0) return null;

    const now = Date.now();
    const linesHtml = [];
    const linesText = [];

    for(const g of groups){
      const R = rng(`${lobbyCode}-${g}-${now}`);
      const modes = ['PV','PA','PL'];
      const mode  = modes[Math.floor(R()*modes.length)];
      const fns   = { PV: window.genPV, PA: window.genPA, PL: window.genPL };
      const { html, text } = fns[mode](R);

      const col = groupColor(g);
      const bg  = rgba(col, 0.22);
      const bd  = rgba(col, 0.55);

      linesHtml.push(`
        <div class="lineGroup">
          <span class="gBadge" style="background:${bg};border-color:${bd}">Grupo ${g}</span>
          <span>${html}</span>
        </div>
      `.trim());
      linesText.push(`Grupo ${g}: ${text}`);
    }

    return { html: linesHtml.join(""), text: linesText.join("\n") };
  }

  // 1√ó: aleatorio entre PVA / PAL / PVL
  function genRandTriple(R){
    const modes = ['PVA','PAL','PVL'];
    const mode  = modes[Math.floor(R()*modes.length)];
    const fns   = { PVA: window.genPVA, PAL: window.genPAL, PVL: window.genPVL };
    return fns[mode](R);
  }

  // Versi√≥n por grupo: PVA / PAL / PVL aleatorio para cada grupo
  function buildGroupedOutputTriple(){
    const state  = lastLobbyState;
    const groups = getActiveGroupsFromState(state);
    if(!groups || groups.length===0) return null;

    const now = Date.now();
    const linesHtml = [];
    const linesText = [];

    for(const g of groups){
      const R = rng(`${lobbyCode}-${g}-${now}`);
      const modes = ['PVA','PAL','PVL'];
      const mode  = modes[Math.floor(R()*modes.length)];
      const fns   = { PVA: window.genPVA, PAL: window.genPAL, PVL: window.genPVL };
      const { html, text } = fns[mode](R);

      const col = groupColor(g);
      const bg  = rgba(col, 0.22);
      const bd  = rgba(col, 0.55);

      linesHtml.push(`
        <div class="lineGroup">
          <span class="gBadge" style="background:${bg};border-color:${bd}">Grupo ${g}</span>
          <span>${html}</span>
        </div>
      `.trim());
      linesText.push(`Grupo ${g}: ${text}`);
    }
    return { html: linesHtml.join(""), text: linesText.join("\n") };
  }

  /* ===========================
     11) Reto / Challenge
  ============================*/
  const CHALLENGES = [
    "Arte Abstracto: Todos deben dibujar sin levantar el plum√≥n de la pizarra.",
    "Arte Manco: Todos deben dibujar con su mano opuesta.",
    "Arte Ciego: Todos deben dibujar con los ojos cerrados.",
    "Arte Geom√©trico: Todos deben dibujar usando solo l√≠neas rectas.",
    "Arte Veloz: Todos tienen 20 segundos para dibujar."
  ];
  function pickChallenge(){ return CHALLENGES[Math.floor(Math.random() * CHALLENGES.length)]; }

  function setChallengeNote(html){
    const el = $('challengeNote');
    if(el) el.innerHTML = html || "";
  }

  // Limpia el reto local y en Firebase (si eres admin o est√°s solo)
  async function clearChallengeForAll(){
    setChallengeNote("");
    if(lobbyCode){
      const hostOrSolo = isHost || playersConnected <= 1;
      if(hostOrSolo){
        try{ await update(ref(db, `lobbies/${lobbyCode}`), { currentChallengeHtml: "" }); }
        catch(e){ console.warn('No se pudo limpiar el reto:', e); }
      }
    }
  }

  /* ===========================
     12) Watcher del Lobby
  ============================*/
  function watchLobby(code){
    if (lobbyRef && lobbyCallback){
      off(lobbyRef, 'value', lobbyCallback);
      lobbyRef = null; lobbyCallback = null;
    }
    lobbyRef = ref(db, `lobbies/${code}`);
    lobbyCallback = (snap)=>{
      const state = snap.val();
      if(!state) return;

      lastLobbyState = state;

      prevIsHost = isHost;
      isHost = state.hostId === clientId;
      window.isHost = isHost;

      playersConnected = 0;
      if (state.players) {
        playersConnected = Object.values(state.players)
          .filter(p => p && p.connections && Object.keys(p.connections).length > 0).length;
      }

      if (!prevIsHost && isHost && window.showToast) window.showToast("Ahora eres ADMIN");

      badgeEl.style.display='inline-block'; badgeEl.textContent = `Sala: ${code}`;
      leaveRow.style.display='flex';

      if (statusEl) statusEl.textContent = `Sala: ${code} ‚Ä¢ ${isHost ? "Eres ADMIN" : "Jugador"} ‚Ä¢ Conectados: ${playersConnected}`;

      // Pesos desde Firebase (hidratar sliders/localStorage)
      if (state.weights && typeof state.weights === 'object') {
        window.WEIGHTS = { ...window.DEFAULT_WEIGHTS, ...state.weights };
        try { localStorage.setItem('am_weights', JSON.stringify(window.WEIGHTS)); } catch{}
        if (typeof window.initWeightSliders === 'function') window.initWeightSliders();
      }

      // Salida actual compartida
      const salidaEl = $('salida');
      if (salidaEl && ('currentOutputHtml' in state)) {
        salidaEl.innerHTML = state.currentOutputHtml || "";
        window.lastCopyText = state.currentOutputText || "";
      }
      // Inserta / quita los botones ‚Üª seg√∫n rol y ronda
      upsertRerollButtons();

      // Nota/desaf√≠o compartido
      if ('currentChallengeHtml' in state) {
        setChallengeNote(state.currentChallengeHtml || "");
      }

      // Timer compartido
      handleTimerState(state.timer);

      // Secretos personales por jugador
      const mySecret = state.secrets && state.secrets[clientId];
      if(mySecret && typeof mySecret.ts === 'number'){
        if(lastSecretTs !== mySecret.ts){
          lastSecretTs = mySecret.ts;
          if(!mySecret.ack){
            showSecretOverlay(
              mySecret.html || '',
              mySecret.title || 'üïµÔ∏è Enunciado secreto'
            );
          }
        }
      }

      // Render de jugadores + controles
      renderPlayers(state);
      updateHostUI();
    };
    onValue(lobbyRef, lobbyCallback);
  }

  /* ===========================
     13) Exports √∫tiles (si otros m√≥dulos los necesitan)
  ============================*/
  window.openFilters              = openFilters;
  window.closeFilters             = closeFilters;
  window.setChallengeNote         = setChallengeNote;
  window.clearChallengeForAll     = clearChallengeForAll;
  window.buildGroupedOutput       = buildGroupedOutput;
  window.buildGroupedOutputDouble = buildGroupedOutputDouble;
  window.buildGroupedOutputTriple = buildGroupedOutputTriple;

    /* ===========================
   14) Crear / Unirse / Publicar
===========================*/
function makeCode(){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  return Array.from({length:5}, () => chars[Math.floor(Math.random()*chars.length)]).join("");
}
async function createLobby(name){
  const code = makeCode();
  const safeWeights =
    (typeof window.WEIGHTS === 'object' && window.WEIGHTS) ||
    (typeof window.DEFAULT_WEIGHTS === 'object' && window.DEFAULT_WEIGHTS) || {
      anime:1, caricaturas:1, cine:1, literatura:1, videojuegos:1,
      mito:1, animales:1, arquetipos:1, famosos:1, otros:1
    };

  const state = {
    hostId: clientId,
    currentOutputHtml: "",
    currentOutputText: "",
    currentChallengeHtml: "",
    weights: { ...safeWeights },
    players: { [clientId]: { name: name || "Host", score: 0, connected: true } },
    createdAt: Date.now()
  };
  await set(ref(db, `lobbies/${code}`), state);
  setLobbyCode(code);
  watchLobby(code);
  setupPresence(code);
}

async function joinLobby(code, name){
  code = (code || "").toUpperCase().trim();
  if(!code) return alert("Escribe un c√≥digo de sala");
  const player = { name: name || "Jugador", score: 0, connected: true };
  await update(ref(db, `lobbies/${code}/players/${clientId}`), player);
  setLobbyCode(code);
  watchLobby(code);
  setupPresence(code);
}

async function publishOutput(html, text){
  const hostOrSolo = isHost || playersConnected <= 1;
  if(!lobbyCode || !hostOrSolo) return;
  await update(ref(db, `lobbies/${lobbyCode}`), {
    currentOutputHtml: html,
    currentOutputText: text
  });
}

/* ===========================
   15) Limpiar enunciado
===========================*/
async function clearOutput(){
  const salidaEl = document.getElementById("salida");

  // En sala: solo ADMIN o solo
  if(lobbyCode){
    const hostOrSolo = isHost || playersConnected <= 1;
    if(!hostOrSolo){
      if(window.showToast) window.showToast('Solo el ADMIN puede limpiar en sala');
      return;
    }
    try{
      await update(ref(db, `lobbies/${lobbyCode}`), {
        currentOutputHtml: "",
        currentOutputText: "",
        currentChallengeHtml: "" // limpia tambi√©n la nota del reto
      });
      if(salidaEl) salidaEl.innerHTML = "";
      if(typeof window.lastCopyText !== "undefined") window.lastCopyText = "";
      setChallengeNote("");
      if(window.showToast) window.showToast('Enunciado limpiado');
    }catch(e){
      console.warn('No se pudo limpiar el enunciado:', e);
      if(window.showToast) window.showToast('No se pudo limpiar');
    }
    return;
  }

  // Modo local
  if(salidaEl) salidaEl.innerHTML = "";
  if(typeof window.lastCopyText !== "undefined") window.lastCopyText = "";
  setChallengeNote("");
  if(window.showToast) window.showToast('Enunciado limpiado');
}

/* ===========================
   16) Secretos (P+V+A+L)
===========================*/
function getActivePlayerIdsFromState(state){
  const playersObj = state?.players || {};
  return Object.entries(playersObj)
    .filter(([,p]) => p && p.connections && Object.keys(p.connections).length > 0)
    .map(([pid]) => pid);
}

// Genera P+V+A+L (orden fijo) con semilla por jugador
function genSecretForPlayer(pid){
  const seed = `${lobbyCode || 'local'}-${pid}-${Date.now()}`;
  const R = rng(seed);
  const { html, text } = genPVAL(R);
  return { html, text };
}

// Host ‚Üí secretos individuales
async function sendSecretsToAll(){
  if(!lobbyCode) return;
  const hostOrSolo = isHost || playersConnected <= 1;
  if(!hostOrSolo){
    if(window.showToast) window.showToast('Solo el ADMIN puede enviar secretos en sala');
    return;
  }
  const state = lastLobbyState;
  const pids = getActivePlayerIdsFromState(state);
  if(pids.length === 0) return;

  const ts = Date.now();
  const updates = {};
  for(const pid of pids){
    const { html, text } = genSecretForPlayer(pid);
    updates[`lobbies/${lobbyCode}/secrets/${pid}`] = {
      html, text, ts, ack:false, title: 'üïµÔ∏è Enunciado secreto'
    };
  }
  await update(ref(db), updates);
  if(window.showToast) window.showToast(`Se enviaron ${pids.length} secretos`);
}

// Local ‚Üí overlay en dispositivo
function sendLocalSecret(){
  const { html } = genPVAL(rng());
  showSecretOverlay(html, 'üïµÔ∏è Enunciado secreto');
}

/* ===========================
   17) Obra maestra (compartido)
===========================*/
function genSharedSecret(){
  const seed = `${lobbyCode || 'local'}-MASTERPIECE-${Date.now()}`;
  const R = rng(seed);
  const { html, text } = genPVAL(R);
  return { html, text };
}

// Host ‚Üí mismo secreto para todos
async function sendMasterpieceToAll(){
  if(!lobbyCode) return;
  const hostOrSolo = isHost || playersConnected <= 1;
  if(!hostOrSolo){
    if(window.showToast) window.showToast('Solo el ADMIN puede enviar secretos en sala');
    return;
  }
  const state = lastLobbyState;
  const pids = getActivePlayerIdsFromState(state);
  if(pids.length === 0) return;

  const ts = Date.now();
  const shared = genSharedSecret();
  const updates = {};
  for(const pid of pids){
    updates[`lobbies/${lobbyCode}/secrets/${pid}`] = {
      html: shared.html,
      text: shared.text,
      ts,
      ack: false,
      title: 'üé® Dibuja tu Obra Maestra con este enunciado'
    };
  }
  await update(ref(db), updates);
  if(window.showToast) window.showToast(`OBRA MAESTRA enviada a ${pids.length} jugadores`);
}

// Local ‚Üí overlay en dispositivo
function sendLocalMasterpiece(){
  const { html } = genPVAL(rng());
  showSecretOverlay(html, 'üé® Dibuja tu Obra Maestra con este enunciado');
}

/* ===========================
   18) Grupos (parejas A, B, C‚Ä¶)
===========================*/
async function generarGrupos(){
  if (!lobbyCode) return;
  const hostOrSolo = isHost || playersConnected <= 1;
  if (!hostOrSolo) return;

  const snap = await get(ref(db, `lobbies/${lobbyCode}/players`));
  const playersObj = snap.val() || {};

  const activos = Object.entries(playersObj)
    .filter(([,p]) => p && p.name && p.connections && Object.keys(p.connections).length > 0)
    .map(([pid,p]) => ({ pid, name: p.name }));

  if (activos.length < 2 || activos.length % 2 !== 0) {
    alert("Agrega o quita un jugador para formar grupos parejos");
    return;
  }

  // shuffle
  for (let i = activos.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [activos[i], activos[j]] = [activos[j], activos[i]];
  }

  const letras = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const updates = {};
  for (let i = 0; i < activos.length; i += 2) {
    const groupIndex = Math.floor(i / 2);
    const letter = letras[groupIndex] || letras[letras.length - 1]; // usa Z si se pasa
    const a = activos[i], b = activos[i+1];
    updates[`lobbies/${lobbyCode}/players/${a.pid}/group`] = letter;
    updates[`lobbies/${lobbyCode}/players/${b.pid}/group`] = letter;
  }
  await update(ref(db), updates);
}

/* ===========================
   19) Generaci√≥n / Botones
===========================*/
const MAP = {
  btnPVAL:'PVAL', btnPV:'PV', btnPA:'PA', btnPL:'PL',
  btnPVA:'PVA', btnPAL:'PAL', btnPVL:'PVL',
  btnFusion:'FUSION', btnP:'P', btnEvento:'EVENTO', btnEscena:'ESCENA',
  btnDoble:'DOBLE', btnTriple:'TRIPLE',
  btnSecreto:'SECRETO', btnMasterpiece:'MASTERPIECE',
  btnReto:'RETO'
};

function genOne(mode){
  const R = (window.rng ? window.rng() : Math.random);
  const gens = {
    PVAL: window.genPVAL, PV: window.genPV, PA: window.genPA, PL: window.genPL,
    PAL: window.genPAL, PVA: window.genPVA, PVL: window.genPVL,
    FUSION: window.genFusion, P: window.genP, EVENTO: window.genEvento, ESCENA: window.genEscena
  };
  const fn = gens[mode] || gens.PVAL;
  return fn(R);
}

// Helpers de render/publish para reducir repetici√≥n
function renderLocal(html, text){
  const out = document.getElementById("salida");
  if(out) out.innerHTML = html || "";
  if(typeof window.lastCopyText !== "undefined") window.lastCopyText = text || "";
  upsertRerollButtons();
}

async function handleGenerate(mode){
  // Si no es RETO, borra nota previa
  if(mode !== 'RETO'){
    await clearChallengeForAll();
  }

  // DOBLE: por grupo PV/PA/PL aleatorio
  if(mode === 'DOBLE'){
    if(lobbyCode){
      const hostOrSolo = isHost || playersConnected <= 1;
      if(!hostOrSolo) return;
      const grouped = buildGroupedOutputDouble();
      if(grouped) publishOutput(grouped.html, grouped.text);
      else {
        const R = rng(); const { html, text } = genRandPVPAorPL(R);
        publishOutput(html, text || '');
      }
    }else{
      const grouped = buildGroupedOutputDouble();
      if(grouped) renderLocal(grouped.html, grouped.text);
      else {
        const R = rng(); const { html, text } = genRandPVPAorPL(R);
        renderLocal(html, text || '');
      }
    }
    return;
  }

  // TRIPLE: por grupo PVA/PAL/PVL aleatorio
  if(mode === 'TRIPLE'){
    if(lobbyCode){
      const hostOrSolo = isHost || playersConnected <= 1;
      if(!hostOrSolo){ if(window.showToast) window.showToast('Solo el ADMIN puede generar enunciados en sala'); return; }
      const grouped = buildGroupedOutputTriple();
      if(grouped) publishOutput(grouped.html, grouped.text);
      else {
        const R = rng(); const { html, text } = genRandTriple(R);
        publishOutput(html, text || '');
      }
    }else{
      const grouped = buildGroupedOutputTriple();
      if(grouped) renderLocal(grouped.html, grouped.text);
      else {
        const R = rng(); const { html, text } = genRandTriple(R);
        renderLocal(html, text || '');
      }
    }
    return;
  }

  // RETO: igual que TRIPLE + nota
  if(mode === 'RETO'){
    let html, text;
    if(lobbyCode){
      const hostOrSolo = isHost || playersConnected <= 1;
      if(!hostOrSolo){ if(window.showToast) window.showToast('Solo el ADMIN puede generar enunciados en sala'); return; }
      const grouped = buildGroupedOutputTriple();
      if(grouped){ html = grouped.html; text = grouped.text; }
      else{ const R = rng(); ({ html, text } = genRandTriple(R)); }
      publishOutput(html, text || '');
    }else{
      const grouped = buildGroupedOutputTriple();
      if(grouped){ renderLocal(grouped.html, grouped.text); }
      else{ const R = rng(); const res = genRandTriple(R); renderLocal(res.html, res.text || ''); }
    }
    const note = pickChallenge();
    const noteHtml = `üìù <strong>RETO:</strong> ${note}`;
    if(lobbyCode){ await update(ref(db, `lobbies/${lobbyCode}`), { currentChallengeHtml: noteHtml }); }
    setChallengeNote(noteHtml);
    return;
  }

  // SECRETO
  if(mode === 'SECRETO'){
    if(lobbyCode) sendSecretsToAll(); else sendLocalSecret();
    return;
  }

  // OBRA MAESTRA
  if(mode === 'MASTERPIECE'){
    if(lobbyCode) sendMasterpieceToAll(); else sendLocalMasterpiece();
    return;
  }
  
  // *** NUEVO: Modo P con ronda y reroll por grupo ***
  if (mode === 'P'){
    await clearChallengeForAll(); // limpia desaf√≠os previos como en los otros modos
    const hostOrSolo = isHost || playersConnected <= 1;
    if (lobbyCode && !hostOrSolo){
      if(window.showToast) window.showToast('Solo el ADMIN puede generar enunciados en sala');
      return;
    }
    startGroupRoundP();
    return;
  }

  // Flujo est√°ndar
  if(lobbyCode){
    const hostOrSolo = isHost || playersConnected <= 1;
    if(!hostOrSolo) return;
    const grouped = buildGroupedOutput(mode);
    if (grouped) publishOutput(grouped.html, grouped.text);
    else {
      const { html, text } = genOne(mode);
      publishOutput(html, text || '');
    }
  }else{
    const grouped = buildGroupedOutput(mode);
    if (grouped) renderLocal(grouped.html, grouped.text);
    else {
      const { html, text } = genOne(mode);
      renderLocal(html, text || '');
    }
  }
}

// Enlazar botones
Object.entries(MAP).forEach(([id,mode])=>{
  const btn = $(id);
  if(btn){ btn.onclick = ()=> handleGenerate(mode); }
});

// Bot√≥n de grupos y limpiar
btnGrupos?.addEventListener('click', generarGrupos);
document.getElementById('btnClearOutput')?.addEventListener('click', clearOutput);

  /* ===========================
   19.5) Ronda con reroll por grupo (modo P)
===========================*/
const MAX_REROLLS_PER_GROUP = 1;

// Crea una ronda nueva (solo modo P) y publica salida + estado de la ronda
async function startGroupRoundP(){
  // Seguridad: solo ADMIN en sala o modo local
  const hostOrSolo = isHost || playersConnected <= 1;

  // Determinar grupos activos
const state  = lastLobbyState;
const groups = getActiveGroupsFromState(state);

// ‚úÖ Si no hay grupos, usamos uno sint√©tico para que exista la ronda y salga ‚Äú‚Üª Cambiar‚Äù
const groupsEff = (groups && groups.length) ? groups : ['A'];

// Nueva ronda
const round = {
  id: Date.now(),
  mode: 'P',
  rerolls: {},                  // { 'A': 0, 'B': 1, ... }
  maxRerollsPerGroup: MAX_REROLLS_PER_GROUP
};

const { html, text } = renderRoundHTML(round, groupsEff);

if (lobbyCode && hostOrSolo){
  // Publica salida + estado de ronda
  await window.fbUpdate(window.fbRef(window.db, `lobbies/${lobbyCode}`), {
    currentOutputHtml: html,
    currentOutputText: text,
    round
  });
} else {
  // Local
  window.__localRound = round;
  renderLocal(html, text);
}

// Dibuja el HTML/texto de la ronda completa, calculando el personaje por grupo
function renderRoundHTML(round, groups){
  const linesHtml = [];
  const linesText = [];

  for (const g of groups){
    const used  = (round.rerolls && round.rerolls[g]) || 0;
    const limit = round.maxRerollsPerGroup || 1;

    const R = rng(`${(lobbyCode||'local')}-${g}-${round.id}-r${Math.min(used, limit)}`);
    const { html, text } = window.genP(R);

    const col = groupColor(g);
    const bg  = rgba(col, 0.22);
    const bd  = rgba(col, 0.55);
    
    linesHtml.push(`
      <div class="lineGroup" data-line-group="${g}">
        <span class="gBadge" style="background:${bg};border-color:${bd}">Grupo ${g}</span>
        <span class="groupText">${html}</span>
      </div>
    `.trim());

    linesText.push(`Grupo ${g}: ${text}`);
  }

  return { html: linesHtml.join(""), text: linesText.join("\n") };
}

  function upsertRerollButtons(){
  // Estado actual de la ronda (sala o local)
  const round = lobbyCode ? (lastLobbyState && lastLobbyState.round) : window.__localRound;

  // Si no hay ronda P, eliminar cualquier bot√≥n que haya quedado
  if (!round || round.mode !== 'P'){
    document.querySelectorAll('#salida .rerollBtn').forEach(b => b.remove());
    return;
  }

  const hostOrSolo = isHost || playersConnected <= 1;

  // Recorre cada l√≠nea de grupo dibujada
  document.querySelectorAll('#salida .lineGroup').forEach(line=>{
    const g = line.getAttribute('data-line-group');
    if(!g) return;

    // Si no eres host (y est√°s en sala), aseg√∫rate de NO tener bot√≥n
    if (lobbyCode && !hostOrSolo){
      const old = line.querySelector('.rerollBtn');
      if (old) old.remove();
      return;
    }

    // Host o local: crea/actualiza bot√≥n
    let btn = line.querySelector('.rerollBtn');
    if (!btn){
      btn = document.createElement('button');
      btn.className = 'btn rerollBtn';
      btn.setAttribute('data-group', g);
      btn.title = 'Cambiar una vez';
      btn.textContent = '‚Üª Cambiar';
      line.appendChild(btn);
    }

    // Habilitar/Deshabilitar seg√∫n usos
    const used  = (round.rerolls && round.rerolls[g]) || 0;
    const limit = round.maxRerollsPerGroup || 1;
    const disabled = used >= limit;

    btn.disabled = disabled;
    btn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
    btn.style.opacity = disabled ? '.5' : '';
    btn.style.pointerEvents = disabled ? 'none' : '';
  });
}

// Reroll (‚Üª) para un grupo espec√≠fico (solo ADMIN en sala; en local cualquiera)
async function rerollGroupOnce(groupLetter){
  // Leer ronda actual (local o desde lobby)
  const round = lobbyCode ? (lastLobbyState && lastLobbyState.round) : window.__localRound;
  if (!round || round.mode !== 'P') return;

  const limit = round.maxRerollsPerGroup || 1;
  const used  = (round.rerolls && round.rerolls[groupLetter]) || 0;
  if (used >= limit){
    if (window.showToast) window.showToast(`Grupo ${groupLetter} ya us√≥ su cambio`);
    return;
  }

  // Clona la ronda y marca un uso de reroll
  const next = {
    ...round,
    rerolls: { ...round.rerolls, [groupLetter]: used + 1 }
  };

  // ‚úÖ Obtener grupos actuales desde el estado o, si no hay, desde el DOM (soporta el grupo sint√©tico)
  const state  = lastLobbyState;
  const groupsState = lobbyCode ? (getActiveGroupsFromState(state) || []) : [];

  const groupsFromDOM = Array
    .from(document.querySelectorAll('#salida .lineGroup'))
    .map(el => el.getAttribute('data-line-group'))
    .filter(Boolean);

  // ‚úÖ Si no hay grupos reales, usa los del DOM; si tampoco, usa ['A']
  const groupsEff = (groupsState.length ? groupsState : (groupsFromDOM.length ? groupsFromDOM : ['A']));

  const { html, text } = renderRoundHTML(next, groupsEff);

  // Publicar cambios
  if (lobbyCode){
    const hostOrSolo = isHost || playersConnected <= 1;
    if (!hostOrSolo) return;
    await window.fbUpdate(window.fbRef(window.db, `lobbies/${lobbyCode}`), {
      currentOutputHtml: html,
      currentOutputText: text,
      round: next
    });
  } else {
    window.__localRound = next;
    renderLocal(html, text);
  }
}

// Delegaci√≥n de clics en los botones ‚Üª (en el contenedor #salida)
document.getElementById('salida')?.addEventListener('click', (e)=>{
  const btn = e.target.closest('.rerollBtn');
  if (!btn) return;

  const hostOrSolo = isHost || playersConnected <= 1;
  if (lobbyCode && !hostOrSolo) return;

  const g = btn.getAttribute('data-group');
  if (!g) return;
  rerollGroupOnce(g);
});

/* ===========================
   20) Atajos y timer sin sala
===========================*/
// Bloquea atajos si no eres host en lobby
document.addEventListener('keydown', (e)=>{
  if ((e.metaKey || e.ctrlKey) && ['1','2','3','4','5','6'].includes(e.key)) {
    if (lobbyCode){
      const hostOrSolo = isHost || playersConnected <= 1;
      if (!hostOrSolo) { e.preventDefault(); e.stopPropagation(); }
    }
  }
}, true);

// Deshabilitar timer si no hay lobby
if(!lobbyCode){
  if(timerSelect){
    timerSelect.disabled = true;
    timerSelect.style.opacity = 0.5;
  }
  if(timerDisplay){
    timerDisplay.style.pointerEvents = 'none';
    timerDisplay.style.opacity = 0.6;
  }
}

/* ===========================
   21) Init / Leave / Confirm
===========================*/
(function initLobbyOnce(){
  const saved = localStorage.getItem(LS_CODE_KEY);
  if(saved){
    overlayEl.style.display = 'none';
    badgeEl.style.display='inline-block'; badgeEl.textContent = `Sala: ${saved}`;
    leaveRow.style.display='flex';
    lobbyCode = saved;
    playersCard.style.display='block';
    watchLobby(saved);
    setupPresence(saved);
  }else{
    overlayEl.style.display = 'flex';
    playersCard.style.display='none';
    setJoinMode(false); // muestra Crear / Unirse
  }
})();

async function leaveLobby(){
  if (!lobbyCode) return;
  const code = lobbyCode;

  try{
    // Transferir host o borrar sala
    if (isHost) {
      const playersSnap = await get(ref(db, `lobbies/${code}/players`));
      const playersObj = playersSnap.val() || {};
      const candidatos = Object.entries(playersObj)
        .filter(([pid, p]) => pid !== clientId && p && p.connections && Object.keys(p.connections).length > 0)
        .map(([pid]) => pid);
      if (candidatos.length > 0) {
        const nuevoHostId = candidatos[0];
        await update(ref(db, `lobbies/${code}`), { hostId: nuevoHostId });
      } else {
        try { await remove(ref(db, `lobbies/${code}`)); } catch(e){}
      }
    }

    if (lobbyRef && lobbyCallback){
      off(lobbyRef, 'value', lobbyCallback);
      lobbyRef = null; lobbyCallback = null;
    }

    if (currentConnRef){
      try{ onDisconnect(currentConnRef).cancel(); }catch(e){}
      try{ await remove(currentConnRef); }catch(e){}
      currentConnRef = null;
    }

    try{ await remove(ref(db, `lobbies/${code}/players/${clientId}`)); }catch(e){}
  }catch(e){
    console.warn('Error al salir de la sala:', e);
  }

  // Reset UI
  lobbyCode = null;
  lastLobbyState = null;
  badgeEl.style.display='none'; badgeEl.textContent = 'Sala: -----';
  leaveRow.style.display='none';
  overlayEl.style.display='flex';
  playersCard.style.display='none';
  const s = document.getElementById("salida"); if (s) s.innerHTML = "";
  if (statusEl) statusEl.textContent = "";
  if (playersList) playersList.innerHTML = "";
  isHost = false; prevIsHost = false; playersConnected = 0;
  updateHostUI();
}

// Confirmaci√≥n de salida
document.getElementById("btnLeave")?.addEventListener("click", (e)=>{
  e.preventDefault();
  openConfirmExit();
});

const confirmExitOverlay = document.getElementById('confirmExitOverlay');
const btnExitYes = document.getElementById('btnConfirmExitYes');
const btnExitNo  = document.getElementById('btnConfirmExitNo');

function openConfirmExit(){
  if(!confirmExitOverlay) return;
  confirmExitOverlay.classList.add('open');
  confirmExitOverlay.style.opacity = '1';
  confirmExitOverlay.style.pointerEvents = 'auto';
  btnExitYes?.focus();
}
function closeConfirmExit(){
  if(!confirmExitOverlay) return;
  confirmExitOverlay.classList.remove('open');
  confirmExitOverlay.style.opacity = '0';
  confirmExitOverlay.style.pointerEvents = 'none';
}

confirmExitOverlay?.addEventListener('click', (e)=>{
  if(e.target === confirmExitOverlay) closeConfirmExit();
});
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && confirmExitOverlay?.classList.contains('open')) closeConfirmExit();
});
btnExitYes?.addEventListener('click', async ()=>{
  closeConfirmExit();
  await leaveLobby();
});
btnExitNo?.addEventListener('click', closeConfirmExit);

// Toast util
window.showToast = (msg)=>{
  const el = document.getElementById('toast');
  if(!el) return;
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(window.__tT);
  window.__tT = setTimeout(()=> el.classList.remove('show'), 2200);
};

/* ===========================
   22) Overlay inicio (Crear/Unirse)
===========================*/
$("btnCreateLobby")?.addEventListener("click", ()=>{
  const name = $("playerName")?.value?.trim() || "";
  const err = $("nameError");
  const errLen = $("nameLengthError");

  // Reglas: no vac√≠o, m√°ximo 10 chars
  if (!name.length) {
    if (err) err.style.display = "block";
    if (errLen) errLen.style.display = "none";
    return;
  }
  if (name.length > 10) {
    if (err) err.style.display = "none";
    if (errLen) errLen.style.display = "block";
    return;
  }
  if (err) err.style.display = "none";
  if (errLen) errLen.style.display = "none";
  createLobby(name);
});

btnChooseJoin?.addEventListener("click", ()=>{
  setJoinMode(true);
  $("lobbyCodeInput")?.focus();
});
btnBackJoin?.addEventListener("click", ()=> setJoinMode(false));

$("btnJoinLobby")?.addEventListener("click", ()=>{
  const name = $("playerName")?.value?.trim() || "";
  const code = ($("lobbyCodeInput")?.value || "").toUpperCase().trim();
  const err = $("nameError");
  const errLen = $("nameLengthError");
  const errCode = $("codeError");

  if (!name.length) {
    if (err) err.style.display = "block";
    if (errLen) errLen.style.display = "none";
    if (errCode) errCode.style.display = "none";
    return;
  }
  if (name.length > 10) {
    if (err) err.style.display = "none";
    if (errLen) errLen.style.display = "block";
    if (errCode) errCode.style.display = "none";
    return;
  }
  if (err) err.style.display = "none";
  if (errLen) errLen.style.display = "none";

  if(!code){
    if (errCode) errCode.style.display = "block";
    return;
  }
  if (errCode) errCode.style.display = "none";
  joinLobby(code, name);
});

// Oculta errores mientras tipeas
$("playerName")?.addEventListener("input", ()=>{
  const val = $("playerName")?.value?.trim() || "";
  const err = $("nameError");
  const errLen = $("nameLengthError");
  if (val.length && err) err.style.display = "none";
  if (val.length <= 10 && errLen) errLen.style.display = "none";
});

/* ===========================
   23) Reubicar chips (desktop header)
===========================*/
(function(){
  const btnAdv     = document.getElementById('btnToggleAdv');
  const btnFilters = document.getElementById('btnFilters');
  if(!btnAdv || !btnFilters) return;

  const originalRow = document.querySelector('#adminControls .inline');
  if(!originalRow) return;

  const appbar = document.querySelector('header .appbar');
  if(!appbar) return;

  let headerActions = document.getElementById('headerActions');
  if(!headerActions){
    headerActions = document.createElement('div');
    headerActions.id = 'headerActions';
    headerActions.className = 'header-actions';

    const roomBadge = document.getElementById('roomBadge');
    if(roomBadge){ appbar.insertBefore(headerActions, roomBadge); }
    else{ appbar.appendChild(headerActions); }
  }

  const mobileAnchor = document.createComment('mobile-anchor-btns');
  originalRow.appendChild(mobileAnchor);

  const mq = window.matchMedia('(min-width: 1024px)');

  function placeButtons(e){
    const isDesktop = e ? e.matches : mq.matches;
    if(isDesktop){
      if(btnAdv.parentElement !== headerActions){
        headerActions.appendChild(btnAdv);
        headerActions.appendChild(btnFilters);
      }
    }else{
      if(btnAdv.parentElement !== originalRow){
        originalRow.insertBefore(btnAdv, mobileAnchor.nextSibling);
        originalRow.insertBefore(btnFilters, btnAdv.nextSibling);
      }
    }
  }

  placeButtons();
  mq.addEventListener('change', placeButtons);

  const ro = new ResizeObserver(()=> placeButtons());
  ro.observe(document.body);
})();

</script>
</body>
</html>
